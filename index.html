<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="color-scheme" content="light dark" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

		<title>ectl.me</title>
		<style>
			/* ── Light palette ───────────────────────────────────── */
			:root {
				--bg: #f0f2f8;
				--text: #0f1117;
				--muted: #697285;
				--accent: #5b6ef5;
				--accent-2: #a855f7;
				--accent-glow: rgba(91,110,245,0.22);
				--accent-glow-2: rgba(168,85,247,0.14);
				--ring: rgba(91,110,245,0.35);
				--link: var(--accent);
				--card-bg: rgba(255,255,255,0.68);
				--card-border: rgba(255,255,255,0.85);
				--card-top-line: linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
				--card-shadow: 0 32px 80px rgba(15,17,40,0.13), 0 8px 24px rgba(15,17,40,0.08);
				--card-shadow-2: 0 0 0 1px rgba(255,255,255,0.6) inset;
				--panel-bg: rgba(255,255,255,0.42);
				--panel-border: rgba(91,110,245,0.13);
				--ok-bg: rgba(91,110,245,0.08);
				--ok-border: rgba(91,110,245,0.22);
				--ok-text: var(--accent);
				--btn-bg: rgba(255,255,255,0.55);
				--btn-border: rgba(91,110,245,0.22);
				--btn-hover: rgba(255,255,255,0.80);
				--btn-active: rgba(91,110,245,0.12);
				--input-bg: rgba(255,255,255,0.72);
				--input-border: rgba(91,110,245,0.2);
				--inset: inset 0 1px 0 rgba(255,255,255,0.7);
				--radius-lg: 26px;
				--radius-md: 14px;
				--blur: 22px;
				/* fluid sizing tokens */
				--card-max: 1060px;
				--card-pad: 24px;
				--base-font: 15px;
				--textarea-h: 220px;
				--wrap-pad-x: 14px;
				/* animation tokens */
				--ease: cubic-bezier(0.25, 1, 0.5, 1);
				--ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
				--t-fast: 140ms;
				--t-mid: 260ms;
				--t-slow: 420ms;
			}

			/* ≤ 480 px – phone */
			@media (max-width: 480px) {
				:root {
					--card-pad: 14px;
					--base-font: 14px;
					--textarea-h: 180px;
					--wrap-pad-x: 8px;
					--radius-lg: 18px;
					--radius-md: 11px;
					--blur: 14px;
				}
			}

			/* ≥ 768 px – tablet */
			@media (min-width: 768px) {
				:root {
					--card-max: 1200px;
					--card-pad: 32px;
					--base-font: 16px;
					--textarea-h: 260px;
					--wrap-pad-x: 24px;
					--radius-lg: 26px;
					--radius-md: 16px;
					--blur: 22px;
				}
			}

			/* ≥ 1200 px – desktop */
			@media (min-width: 1200px) {
				:root {
					--card-max: 1420px;
					--card-pad: 40px;
					--base-font: 17px;
					--textarea-h: 320px;
					--wrap-pad-x: 40px;
					--radius-lg: 30px;
					--radius-md: 18px;
					--blur: 26px;
				}
			}

			/* ≥ 1600 px – wide / ultrawide */
			@media (min-width: 1600px) {
				:root {
					--card-max: 1680px;
					--card-pad: 48px;
					--base-font: 18px;
					--textarea-h: 380px;
					--wrap-pad-x: 60px;
					--radius-lg: 34px;
					--radius-md: 20px;
					--blur: 30px;
				}
			}

			/* ── Dark palette ────────────────────────────────────── */
			@media (prefers-color-scheme: dark) {
				:root {
					--bg: #0b0d14;
					--text: #e8eaf6;
					--muted: #7a84a8;
					--accent: #818cf8;
					--accent-2: #c084fc;
					--accent-glow: rgba(129,140,248,0.25);
					--accent-glow-2: rgba(192,132,252,0.16);
					--ring: rgba(129,140,248,0.40);
					--card-bg: rgba(17,19,35,0.78);
					--card-border: rgba(129,140,248,0.18);
					--card-shadow: 0 32px 80px rgba(0,0,0,0.5), 0 8px 24px rgba(0,0,0,0.3);
					--card-shadow-2: 0 0 0 1px rgba(255,255,255,0.07) inset;
					--panel-bg: rgba(255,255,255,0.04);
					--panel-border: rgba(129,140,248,0.16);
					--ok-bg: rgba(129,140,248,0.12);
					--ok-border: rgba(129,140,248,0.30);
					--ok-text: var(--accent);
					--btn-bg: rgba(255,255,255,0.06);
					--btn-border: rgba(129,140,248,0.24);
					--btn-hover: rgba(255,255,255,0.10);
					--btn-active: rgba(129,140,248,0.18);
					--input-bg: rgba(255,255,255,0.06);
					--input-border: rgba(129,140,248,0.22);
					--inset: inset 0 1px 0 rgba(255,255,255,0.08);
				}
			}

			* {
				box-sizing: border-box;
			}

			/* Ensure [hidden] always wins, even against display:grid/.wrap etc. */
			[hidden] { display: none !important; }

			body {
				margin: 0;
				font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
				font-size: var(--base-font);
				background:
					/* Top-left bloom – primary accent */
					radial-gradient(ellipse 70% 60% at 5% 0%,   color-mix(in srgb, var(--accent)   62%, transparent), transparent),
					/* Top-right bloom – secondary accent */
					radial-gradient(ellipse 55% 50% at 95% 5%,  color-mix(in srgb, var(--accent-2)  48%, transparent), transparent),
					/* Centre soft haze */
					radial-gradient(ellipse 80% 55% at 50% 46%, color-mix(in srgb, var(--accent)   18%, transparent), transparent),
					/* Bottom anchor */
					radial-gradient(ellipse 90% 55% at 25% 100%,color-mix(in srgb, var(--accent-2)  28%, transparent), transparent),
					/* Diagonal shimmer */
					linear-gradient(135deg,
						color-mix(in srgb, var(--accent) 12%, transparent) 0%,
						transparent 45%,
						color-mix(in srgb, var(--accent-2) 10%, transparent) 100%),
					var(--bg);
				color: var(--text);
				min-height: 100vh;
			}

			/* Grain overlay */
			body::before {
				content: '';
				position: fixed;
				inset: 0;
				pointer-events: none;
				z-index: 0;
				opacity: 0.045;
				background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
				background-size: 200px 200px;
			}
			/* Slow-moving aurora shimmer */
			body::after {
				content: '';
				position: fixed;
				inset: -20%;
				pointer-events: none;
				z-index: 0;
				background:
					radial-gradient(ellipse 60% 40% at 30% 30%, color-mix(in srgb, var(--accent) 10%, transparent), transparent 70%),
					radial-gradient(ellipse 50% 35% at 75% 70%, color-mix(in srgb, var(--accent-2) 9%, transparent), transparent 70%);
				animation: aurora-drift 18s ease-in-out infinite alternate;
				will-change: transform;
			}
			@keyframes aurora-drift {
				0%   { transform: translate(0, 0)    scale(1); }
				33%  { transform: translate(3%, -4%) scale(1.04); }
				66%  { transform: translate(-4%, 3%) scale(0.97); }
				100% { transform: translate(2%, 5%)  scale(1.02); }
			}

			/* Make sure page content sits above the grain */
			.wrap, header, main {
				position: relative;
				z-index: 1;
			}

			.wrap {
				min-height: 100vh;
				display: grid;
				place-items: center;
				padding: 30px var(--wrap-pad-x);
			}
			@media (max-width: 360px) {
				.wrap { padding-left: 4px; padding-right: 4px; }
			}

			/* App is top-aligned so the card never jumps when tab content changes height. */
			#app.wrap {
				place-items: start center;
				padding-top: 32px;
				padding-bottom: 48px;
				align-items: start;
			}
			@media (max-width: 480px) {
				#app.wrap  { padding-top: 12px; padding-bottom: 20px; }
				#login-screen.wrap { padding-top: 16px; padding-bottom: 16px; }
			}

			/* Login stays visually centered, but auth tab resizes grow/shrink downward (top stays fixed). */
			#login-screen.wrap {
				place-items: start center;
				padding-top: var(--login-pad-top, 30px);
				padding-bottom: 30px;
			}

			.card {
				width: min(var(--card-max), 100%);
				background: var(--card-bg);
				border: 1px solid var(--card-border);
				border-radius: var(--radius-lg);
				padding: var(--card-pad);
				overflow: hidden;
				backface-visibility: hidden;
				-webkit-backface-visibility: hidden;
				box-shadow: var(--card-shadow), var(--card-shadow-2);
				backdrop-filter: blur(var(--blur)) saturate(160%);
				-webkit-backdrop-filter: blur(var(--blur)) saturate(160%);
				animation: card-enter 0.6s var(--ease) both;
				position: relative;
			}
			/* Coloured accent stripe at the top of the card */
			.card::before {
				content: '';
				position: absolute;
				top: 0; left: 0; right: 0;
				height: 3px;
				background: var(--card-top-line);
				border-radius: var(--radius-lg) var(--radius-lg) 0 0;
				opacity: 0.85;
			}

			@keyframes card-enter {
				from { opacity: 0; transform: translateY(18px) scale(0.985); }
				to   { opacity: 1; transform: translateY(0)   scale(1); }
			}

			#app .card {
				transform: none;
			}

			@supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))) {
				.card {
					background: color-mix(in srgb, Canvas 94%, CanvasText);
				}
			}

			header {
				display: flex;
				align-items: flex-start;
				gap: 12px;
				flex-wrap: wrap;
			}

			.header-actions {
				margin-left: auto;
				flex-shrink: 0;
			}
			@media (max-width: 480px) {
				header { gap: 10px; }
				.header-actions { order: 3; margin-left: 0; width: 100%; }
				#btn-signout { width: 100%; }
			}

			.mark {
				width: 46px;
				height: 46px;
				min-width: 38px;
				border-radius: 14px;
				border: 1.5px solid var(--ring);
				display: grid;
				place-items: center;
				font-size: 1.15rem;
				font-weight: 800;
				letter-spacing: -0.03em;
				user-select: none;
				background: linear-gradient(135deg, var(--accent-glow) 0%, var(--accent-glow-2) 100%);
				box-shadow: var(--inset), 0 0 0 0 var(--accent-glow);
				color: var(--accent);
				transition: transform var(--t-mid) var(--ease-spring), box-shadow var(--t-mid) var(--ease);
			}
			.mark:hover {
				transform: scale(1.1) rotate(-4deg);
				box-shadow: var(--inset), 0 6px 22px var(--accent-glow);
			}

			h1 {
				font-size: clamp(1.5rem, 1.1rem + 2vw, 2.2rem);
				line-height: 1.12;
				margin: 0;
				letter-spacing: -0.04em;
				background: linear-gradient(110deg, var(--text) 50%, var(--accent) 130%);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.subtitle {
				margin: 5px 0 0;
				color: var(--muted);
				font-size: 0.92rem;
				letter-spacing: 0.01em;
			}

			.row {
				margin-top: 16px;
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 8px 12px;
				flex-wrap: wrap;
			}

			.auth {
				display: inline-flex;
				align-items: center;
				gap: 10px;
				color: var(--muted);
				font-size: 0.95rem;
			}

			#save-status {
				padding: 3px 11px;
				border-radius: 999px;
				border: 1px solid var(--ok-border);
				color: var(--ok-text);
				background: var(--ok-bg);
				font-size: 0.82rem;
				font-weight: 700;
				letter-spacing: 0.02em;
				text-transform: uppercase;
				animation: badge-pop var(--t-mid) var(--ease-spring) both;
			}

			@keyframes badge-pop {
				from { opacity: 0; transform: scale(0.82); }
				to   { opacity: 1; transform: scale(1); }
			}

			.tabs {
				margin-top: 16px;
				display: flex;
				gap: 4px;
				padding: 4px;
				border-radius: 999px;
				border: 1px solid var(--card-border);
				background: rgba(0,0,0,0.05);
				backdrop-filter: blur(calc(var(--blur) * 0.5)) saturate(150%);
				-webkit-backdrop-filter: blur(calc(var(--blur) * 0.5)) saturate(150%);
				box-§shadow: inset 0 1px 0 rgba(255,255,255,0.15), 0 1px 4px rgba(0,0,0,0.06);
				overflow-x: auto;
				-webkit-overflow-scrolling: touch;
				scrollbar-width: none;
				max-width: 100%;
			}
			.tabs::-webkit-scrollbar { display: none; }

			.tab {
				appearance: none;
				border: 1px solid transparent;
				background: transparent;
				color: var(--muted);
				padding: 7px 14px;
				min-height: 36px;
				border-radius: 999px;
				font-size: 0.88rem;
				font-weight: 600;
				letter-spacing: 0.01em;
				white-space: nowrap;
				flex-shrink: 0;
				cursor: pointer;
				transition:
					color var(--t-fast) var(--ease),
					background var(--t-fast) var(--ease),
					border-color var(--t-fast) var(--ease),
					box-shadow var(--t-mid) var(--ease),
					transform var(--t-mid) var(--ease-spring);
			}
			.tab:hover:not([aria-selected='true']) {
				color: var(--text);
				background: rgba(255,255,255,0.18);
			}
			.tab:active {
				transform: scale(0.93);
			}

			.tab[aria-selected='true'] {
				color: var(--accent);
				background: var(--card-bg);
				border-color: var(--ring);
				box-shadow: var(--inset), 0 2px 10px var(--accent-glow);
				animation: tab-select var(--t-mid) var(--ease-spring) both;
			}

			@keyframes tab-select {
				from { transform: scale(0.91); opacity: 0.7; }
				to   { transform: scale(1);    opacity: 1; }
			}

			.btn {
				appearance: none;
				border: 1px solid var(--btn-border);
				background: var(--btn-bg);
				color: var(--text);
				padding: 10px 16px;
				min-height: 40px;
				border-radius: var(--radius-md);
				font-size: 0.9rem;
				font-weight: 600;
				letter-spacing: 0.01em;
				cursor: pointer;
				box-shadow: var(--inset), 0 1px 3px rgba(0,0,0,0.07);
				transition:
					background var(--t-fast) var(--ease),
					border-color var(--t-fast) var(--ease),
					box-shadow var(--t-mid) var(--ease),
					transform var(--t-mid) var(--ease-spring),
					opacity var(--t-fast) var(--ease);
			}

			.btn:hover {
				background: var(--btn-hover);
				border-color: var(--ring);
				box-shadow: var(--inset), 0 4px 16px var(--accent-glow);
				transform: translateY(-1px);
			}

			.btn:active {
				background: var(--btn-active);
				transform: scale(0.95) translateY(0);
				box-shadow: var(--inset);
			}

			.btn:disabled {
				opacity: 0.45;
				cursor: not-allowed;
				transform: none;
			}

			/* Accent/primary button variant */
			.btn-accent {
				background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
				border-color: transparent;
				color: #fff;
				box-shadow: var(--inset), 0 4px 18px var(--accent-glow);
			}
			.btn-accent:hover {
				background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 85%, #fff) 0%, color-mix(in srgb, var(--accent-2) 85%, #fff) 100%);
				border-color: transparent;
				box-shadow: var(--inset), 0 6px 24px var(--accent-glow);
			}
			.btn-accent:active {
				background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
			}

			.input,
			textarea {
				width: 100%;
				padding: 10px 13px;
				border-radius: var(--radius-md);
				border: 1.5px solid var(--input-border);
				background: var(--input-bg);
				color: var(--text);
				font: inherit;
				box-shadow: var(--inset), inset 0 1px 3px rgba(0,0,0,0.04);
				transition:
					border-color var(--t-fast) var(--ease),
					box-shadow var(--t-mid) var(--ease),
					background var(--t-fast) var(--ease);
			}
			.input:focus,
			textarea:focus {
				outline: none;
				border-color: var(--accent);
				box-shadow: var(--inset), 0 0 0 3.5px var(--accent-glow);
			}
                    .input:hover:not(:focus),
                    textarea:hover:not(:focus) {
                            border-color: color-mix(in srgb, var(--accent) 45%, var(--input-border));
                    }
                    /* All native <select> elements inherit the page color-scheme
                       so Brave/Chrome render the picker popup in dark mode too */
                    select {
                            color-scheme: inherit;
                    }
                    select option {
                            background: var(--bg, #fff);
                            color: var(--text, #111);
                    }			textarea {
				min-height: var(--textarea-h);
				max-width: 100%;
				display: block;
				resize: vertical;
			}

			.fields {
				margin-top: 16px;
				display: grid;
				gap: 12px;
			}

			.field label {
				display: block;
				margin-bottom: 7px;
				font-size: 0.82rem;
				font-weight: 700;
				letter-spacing: 0.05em;
				text-transform: uppercase;
				color: var(--muted);
			}

			.actions {
				margin-top: 14px;
				display: flex;
				gap: 10px;
				flex-wrap: wrap;
			}
			@media (max-width: 380px) {
				.actions .btn { flex: 1 1 100%; }
			}

			.pwrow {
				display: flex;
				gap: 10px;
				align-items: center;
				flex-wrap: wrap;
			}

			.pwrow .input {
				flex: 1;
			}

			.btn.btn-small {
				padding: 8px 10px;
				border-radius: 12px;
				white-space: nowrap;
			}

			.notes-label {
				display: block;
				margin-top: 14px;
				font-weight: 700;
			}

			/* ── Files tab ─────────────────────────────────────── */
			.upload-zone {
				margin-top: 14px;
				border: 2px dashed var(--panel-border);
				border-radius: var(--radius-md);
				padding: 28px 16px;
				text-align: center;
				cursor: pointer;
				transition: border-color var(--t-mid) var(--ease), background var(--t-mid) var(--ease), box-shadow var(--t-mid) var(--ease);
			}
			.upload-zone:hover, .upload-zone.drag-over {
				border-color: var(--accent);
				background: var(--accent-glow);
				box-shadow: 0 0 0 4px var(--accent-glow);
			}
			.upload-zone input[type="file"] {
				display: none;
			}
			.upload-zone-label {
				display: block;
				font-weight: 600;
				margin-bottom: 4px;
			}
			.upload-zone-sub {
				font-size: 0.88rem;
				color: var(--muted);
			}
			.upload-progress {
				display: none;
				margin-top: 12px;
				height: 4px;
				border-radius: 999px;
				background: var(--panel-border);
				overflow: hidden;
			}
			.upload-progress.visible { display: block; }
			.upload-progress-bar {
				height: 100%;
				width: 0%;
				background: linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
				border-radius: 999px;
				transition: width 0.3s var(--ease);
			}
			.files-status {
				margin-top: 10px;
				min-height: 1.4em;
				font-size: 0.92rem;
				color: var(--muted);
			}
			.file-list {
				margin-top: 14px;
				display: flex;
				flex-direction: column;
				gap: 6px;
			}
			.file-row {
				display: flex;
				align-items: center;
				flex-wrap: wrap;
				gap: 8px 10px;
				padding: 9px 12px;
				border-radius: var(--radius-md);
				background: var(--btn-bg);
				border: 1px solid var(--btn-border);
				word-break: break-all;
				transition: background var(--t-fast) var(--ease), transform var(--t-mid) var(--ease-spring), box-shadow var(--t-fast) var(--ease);
				animation: file-row-in var(--t-slow) var(--ease) both;
			}
			.file-row:hover {
				background: var(--btn-hover);
				transform: translateY(-1px);
				box-shadow: 0 4px 12px color-mix(in srgb, CanvasText 8%, transparent);
			}

			@keyframes file-row-in {
				from { opacity: 0; transform: translateY(6px); }
				to   { opacity: 1; transform: translateY(0); }
			}
			.file-row-name {
				flex: 1;
				font-size: 0.93rem;
				font-weight: 600;
			}
			.file-row-meta {
				font-size: 0.8rem;
				color: var(--muted);
				white-space: nowrap;
			}
			@media (max-width: 400px) {
				.file-row-meta { display: none; }
			}
			.file-row-actions {
				display: flex;
				gap: 6px;
				flex-shrink: 0;
			}

			/* stagger file rows */
			.file-row:nth-child(1)  { animation-delay:  0ms; }
			.file-row:nth-child(2)  { animation-delay: 40ms; }
			.file-row:nth-child(3)  { animation-delay: 80ms; }
			.file-row:nth-child(4)  { animation-delay:120ms; }
			.file-row:nth-child(5)  { animation-delay:160ms; }
			.file-row:nth-child(n+6){ animation-delay:200ms; }

			#panel-notes .row {
				margin-bottom: 10px;
				gap: 8px;
				flex-wrap: wrap;
			}

			#notes {
				margin-top: 8px;
				line-height: 1.35;
			}

			/* ── Multi-doc notes layout ──────────────────────── */
			.notes-layout {
				display: grid;
				grid-template-columns: 220px 1fr;
				gap: 14px;
				margin-top: 14px;
			}
			@media (max-width: 600px) {
				.notes-layout {
					grid-template-columns: 1fr;
					gap: 10px;
				}
				.notes-sidebar { max-height: 140px; overflow-y: auto; }
				.notes-editor-toolbar {
					gap: 6px;
				}
				.notes-title-input { min-width: 0; }
				#btn-rename-doc, #btn-dl-doc, #btn-delete-doc {
					padding: 7px 9px;
					font-size: 0.82rem;
				}
			}

			.notes-sidebar {
				display: flex;
				flex-direction: column;
				gap: 4px;
				overflow-y: auto;
				max-height: 460px;
				padding-right: 2px;
			}
			.notes-sidebar::-webkit-scrollbar { width: 4px; }
			.notes-sidebar::-webkit-scrollbar-thumb { background: var(--panel-border); border-radius: 99px; }

			.doc-item {
				display: flex;
				align-items: center;
				gap: 6px;
				padding: 8px 10px;
				border-radius: var(--radius-md);
				border: 1px solid transparent;
				cursor: pointer;
				background: transparent;
				width: 100%;
				text-align: left;
				transition: background var(--t-fast) var(--ease), border-color var(--t-fast) var(--ease), transform var(--t-mid) var(--ease-spring);
				animation: file-row-in var(--t-slow) var(--ease) both;
			}
			.doc-item:hover {
				background: var(--btn-hover);
				border-color: var(--panel-border);
				transform: translateX(2px);
			}
			.doc-item.active {
				background: var(--ok-bg);
				border-color: var(--accent);
				color: var(--accent);
			}
			.doc-item-name {
				flex: 1;
				font-size: 0.88rem;
				font-weight: 600;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			.doc-item-date {
				font-size: 0.73rem;
				color: var(--muted);
				white-space: nowrap;
			}

			.notes-editor-col {
				display: flex;
				flex-direction: column;
				gap: 8px;
			}
			.notes-editor-toolbar {
				display: flex;
				gap: 8px;
				align-items: center;
				flex-wrap: wrap;
			}
			.notes-title-input {
				flex: 1;
				min-width: 120px;
				font-weight: 700;
				font-size: 1rem;
			}
			#notes {
				margin-top: 0;
				flex: 1;
			}

			.panel {
				margin-top: 20px;
				padding: 18px;
				border-radius: calc(var(--radius-lg) - 4px);
				background: var(--panel-bg);
				border: 1px solid var(--panel-border);
				box-shadow: var(--inset), 0 2px 12px rgba(0,0,0,0.04);
				backdrop-filter: blur(calc(var(--blur) * 0.7)) saturate(150%);
				-webkit-backdrop-filter: blur(calc(var(--blur) * 0.7)) saturate(150%);
				animation: panel-in var(--t-slow) var(--ease) both;
			}

			@keyframes panel-in {
				from { opacity: 0; transform: translateY(10px) scale(0.99); }
				to   { opacity: 1; transform: translateY(0)   scale(1); }
			}

			.status {
				display: inline-flex;
				align-items: center;
				gap: 8px;
				margin: 18px 0 0;
				padding: 9px 16px;
				border-radius: 999px;
				background: var(--ok-bg);
				border: 1px solid var(--ok-border);
				color: var(--ok-text);
				font-size: 0.9rem;
				font-weight: 700;
				letter-spacing: 0.01em;
				width: fit-content;
				box-shadow: 0 2px 12px var(--accent-glow);
				backdrop-filter: blur(calc(var(--blur) * 0.6)) saturate(150%);
				-webkit-backdrop-filter: blur(calc(var(--blur) * 0.6)) saturate(150%);
			}

			.dot {
				width: 8px;
				height: 8px;
				border-radius: 999px;
				background: var(--accent);
				box-shadow: 0 0 0 0 var(--accent-glow);
				animation: dot-pulse 2.4s var(--ease) infinite;
			}

			@keyframes dot-pulse {
				0%   { opacity: 1;   transform: scale(1);    box-shadow: 0 0 0 0   var(--accent-glow); }
				50%  { opacity: 0.7; transform: scale(0.8);  box-shadow: 0 0 0 5px transparent; }
				100% { opacity: 1;   transform: scale(1);    box-shadow: 0 0 0 0   var(--accent-glow); }
			}

			.meta {
				margin-top: 18px;
				padding-top: 16px;
				border-top: 1px solid color-mix(in srgb, CanvasText 10%, transparent);
				display: flex;
				flex-wrap: wrap;
				gap: 10px 16px;
				color: var(--muted);
				font-size: 0.95rem;
			}

			a:focus-visible,
			.tab:focus-visible,
			.btn:focus-visible,
			.input:focus-visible,
			textarea:focus-visible {
				outline: 2.5px solid var(--accent);
				outline-offset: 3px;
				border-radius: 12px;
			}

			a {
				color: var(--accent);
				text-underline-offset: 4px;
				transition: color var(--t-fast) var(--ease), opacity var(--t-fast) var(--ease);
			}
			a:hover { opacity: 0.78; }

			.hint {
				margin: 10px 0 0;
				color: var(--muted);
				font-size: 0.95rem;
			}

			/* ── Customization settings ───────────────────────────── */
			.settings-section {
				margin-top: 22px;
				padding-top: 18px;
				border-top: 1px solid var(--panel-border);
			}
			.settings-section:first-child { margin-top: 0; padding-top: 0; border-top: none; }

			.settings-section-title {
				font-size: 0.78rem;
				font-weight: 800;
				letter-spacing: 0.08em;
				text-transform: uppercase;
				color: var(--muted);
				margin: 0 0 12px;
			}

			/* Colour swatches */
			.swatch-row {
				display: flex;
				gap: 10px;
				flex-wrap: wrap;
			}
			.swatch {
				width: 32px;
				height: 32px;
				border-radius: 50%;
				border: 2.5px solid transparent;
				cursor: pointer;
				transition: transform var(--t-mid) var(--ease-spring), box-shadow var(--t-mid) var(--ease), border-color var(--t-fast) var(--ease);
				outline: none;
				box-shadow: 0 2px 8px rgba(0,0,0,0.15);
			}
			.swatch:hover {
				transform: scale(1.15);
				box-shadow: 0 4px 16px rgba(0,0,0,0.22);
			}
			.swatch.active {
				border-color: var(--text);
				transform: scale(1.18);
				box-shadow: 0 0 0 3px var(--card-bg), 0 0 0 5px var(--text), 0 4px 16px rgba(0,0,0,0.18);
			}

			/* Option chips (font size, width, bg style) */
			.chip-row {
				display: flex;
				gap: 8px;
				flex-wrap: wrap;
			}
			.chip {
				appearance: none;
				border: 1.5px solid var(--btn-border);
				background: var(--btn-bg);
				color: var(--muted);
				padding: 8px 14px;
				min-height: 40px;
				border-radius: 999px;
				font-size: 0.85rem;
				font-weight: 600;
				cursor: pointer;
				transition:
					background var(--t-fast) var(--ease),
					border-color var(--t-fast) var(--ease),
					color var(--t-fast) var(--ease),
					box-shadow var(--t-mid) var(--ease),
					transform var(--t-mid) var(--ease-spring);
			}
			.chip:hover {
				border-color: var(--ring);
				color: var(--text);
				background: var(--btn-hover);
			}
			.chip:active { transform: scale(0.94); }
			.chip.active {
				background: var(--accent-glow);
				border-color: var(--accent);
				color: var(--accent);
				box-shadow: 0 0 0 3px var(--accent-glow);
			}

			.prefs-save-row {
				margin-top: 18px;
				display: flex;
				align-items: center;
				gap: 12px;
			}
			#prefs-status {
				font-size: 0.85rem;
				color: var(--muted);
			}

			/* ── end customization ───────────────────────────────── */

			/* ── Toast notifications ──────────────────────────────── */
			#toast-container {
				position: fixed;
				bottom: 24px;
				right: 20px;
				z-index: 9999;
				display: flex;
				flex-direction: column;
				gap: 8px;
				align-items: flex-end;
				pointer-events: none;
			}
			.toast {
				pointer-events: auto;
				display: inline-flex;
				align-items: center;
				gap: 8px;
				padding: 10px 16px;
				border-radius: 999px;
				background: var(--card-bg);
				border: 1px solid var(--card-border);
				color: var(--text);
				font-size: 0.87rem;
				font-weight: 600;
				backdrop-filter: blur(var(--blur)) saturate(160%);
				-webkit-backdrop-filter: blur(var(--blur)) saturate(160%);
				box-shadow: 0 8px 32px rgba(0,0,0,0.18), 0 2px 8px rgba(0,0,0,0.10);
				animation: toast-in 0.28s var(--ease-spring) both;
				max-width: min(340px, calc(100vw - 32px));
			}
			.toast.toast-success { border-color: var(--accent); color: var(--accent); }
			.toast.toast-error   { border-color: #f87171; color: #ef4444; }
			.toast.toast-out     { animation: toast-out 0.22s var(--ease) forwards; }
			@keyframes toast-in  { from { opacity:0; transform:translateY(12px) scale(0.93); } to { opacity:1; transform:none; } }
			@keyframes toast-out { from { opacity:1; transform:none; } to { opacity:0; transform:translateY(6px) scale(0.95); } }

			/* ── File thumbnails ────────────────────────────────────── */
			.file-row-thumb {
				width: 40px;
				height: 40px;
				border-radius: 8px;
				object-fit: cover;
				border: 1px solid var(--panel-border);
				flex-shrink: 0;
			}
			.file-row-icon {
				font-size: 1.5rem;
				line-height: 1;
				flex-shrink: 0;
				width: 32px;
				text-align: center;
			}

			/* ── Notes search ───────────────────────────────────────── */
			.notes-search {
				width: 100%;
				margin-bottom: 6px;
				font-size: 0.85rem;
			}

			/* ── Word / char count ──────────────────────────────────── */
			.notes-word-count {
				font-size: 0.78rem;
				color: var(--muted);
				text-align: right;
				margin-top: 2px;
				letter-spacing: 0.02em;
			}

			/* ── Pin button in doc sidebar ──────────────────────────── */
			.doc-pin-btn {
				appearance: none;
				background: transparent;
				border: none;
				cursor: pointer;
				padding: 2px 4px;
				font-size: 0.85rem;
				opacity: 0.3;
				transition: opacity var(--t-fast) var(--ease), transform var(--t-mid) var(--ease-spring);
				line-height: 1;
				margin-left: 2px;
				color: var(--accent);
				flex-shrink: 0;
			}
			.doc-pin-btn:hover, .doc-pin-btn.pinned { opacity: 1; }
			.doc-pin-btn.pinned { transform: rotate(-45deg); }

			/* ── Email verified badge ───────────────────────────────── */
			.verified-badge {
				display: inline-flex;
				align-items: center;
				gap: 4px;
				padding: 3px 10px;
				border-radius: 999px;
				font-size: 0.78rem;
				font-weight: 700;
				letter-spacing: 0.04em;
				border: 1px solid;
			}
			.verified-badge.ok  { background: rgba(5,150,105,0.10); border-color: rgba(5,150,105,0.35); color: #059669; }
			.verified-badge.warn{ background: rgba(217,119,6,0.10);  border-color: rgba(217,119,6,0.35);  color: #d97706; }

			/* ── Sliding tab indicator ──────────────────────────────── */
			.tabs {
				position: relative;
			}
			.tab-indicator {
				position: absolute;
				bottom: 4px;
				Height: 3px;
				border-radius: 999px;
				background: linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
				transition: left var(--t-mid) var(--ease), width var(--t-mid) var(--ease), opacity var(--t-fast) var(--ease);
				opacity: 0;
				pointer-events: none;
			}
			.tab-indicator.visible { opacity: 1; }

			/* ── Splash screen ─────────────────────────────────── */
			#splash {
				position: fixed;
				inset: 0;
				z-index: 10000;
				display: grid;
				place-items: center;
				background: var(--bg);
				transition: opacity 0.48s var(--ease), visibility 0.48s;
			}
			#splash.splash-out {
				opacity: 0;
				visibility: hidden;
				pointer-events: none;
			}
			.splash-inner {
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 18px;
			}
			.splash-mark {
				width: 64px;
				height: 64px;
				border-radius: 20px;
				border: 2px solid var(--ring);
				display: grid;
				place-items: center;
				font-size: 1.8rem;
				font-weight: 800;
				letter-spacing: -0.04em;
				color: var(--accent);
				background: linear-gradient(135deg, var(--accent-glow) 0%, var(--accent-glow-2) 100%);
				animation: splash-bounce 1.1s var(--ease-spring) infinite alternate;
			}
			@keyframes splash-bounce {
				from { transform: translateY(0) scale(1); }
				to   { transform: translateY(-8px) scale(1.05); }
			}
			.splash-dots {
				display: flex;
				gap: 7px;
			}
			.splash-dots span {
				width: 7px;
				height: 7px;
				border-radius: 50%;
				background: var(--accent);
				animation: splash-dot 0.9s var(--ease) infinite alternate;
			}
			.splash-dots span:nth-child(2) { animation-delay: 0.2s; background: color-mix(in srgb, var(--accent) 60%, var(--accent-2)); }
			.splash-dots span:nth-child(3) { animation-delay: 0.4s; background: var(--accent-2); }
			@keyframes splash-dot {
				from { opacity: 0.3; transform: scale(0.7); }
				to   { opacity: 1;   transform: scale(1.15); }
			}

			/* ── Theme toggle button ────────────────────────────────── */
			#btn-theme-toggle {
				padding: 8px 11px;
				min-height: 36px;
				border-radius: var(--radius-md);
				font-size: 1rem;
				line-height: 1;
			}
			/* body.theme-light / body.theme-dark override CSS vars */
			body.theme-dark {
				--bg: #0b0d14;
				--text: #e8eaf6;
				--muted: #7a84a8;
				--accent: #818cf8;
				--accent-2: #c084fc;
				--accent-glow: rgba(129,140,248,0.25);
				--accent-glow-2: rgba(192,132,252,0.16);
				--ring: rgba(129,140,248,0.40);
				--card-bg: rgba(17,19,35,0.78);
				--card-border: rgba(129,140,248,0.18);
				--card-shadow: 0 32px 80px rgba(0,0,0,0.5), 0 8px 24px rgba(0,0,0,0.3);
				--card-shadow-2: 0 0 0 1px rgba(255,255,255,0.07) inset;
				--panel-bg: rgba(255,255,255,0.04);
				--panel-border: rgba(129,140,248,0.16);
				--ok-bg: rgba(129,140,248,0.12);
				--ok-border: rgba(129,140,248,0.30);
				--ok-text: var(--accent);
				--btn-bg: rgba(255,255,255,0.06);
				--btn-border: rgba(129,140,248,0.24);
				--btn-hover: rgba(255,255,255,0.10);
				--btn-active: rgba(129,140,248,0.18);
				--input-bg: rgba(255,255,255,0.06);
				--input-border: rgba(129,140,248,0.22);
				--inset: inset 0 1px 0 rgba(255,255,255,0.08);
				color-scheme: dark;
			}
			body.theme-light {
				--bg: #f0f2f8;
				--text: #0f1117;
				--muted: #697285;
				--accent: #5b6ef5;
				--accent-2: #a855f7;
				--accent-glow: rgba(91,110,245,0.22);
				--accent-glow-2: rgba(168,85,247,0.14);
				--ring: rgba(91,110,245,0.35);
				--card-bg: rgba(255,255,255,0.68);
				--card-border: rgba(255,255,255,0.85);
				--card-shadow: 0 32px 80px rgba(15,17,40,0.13), 0 8px 24px rgba(15,17,40,0.08);
				--card-shadow-2: 0 0 0 1px rgba(255,255,255,0.6) inset;
				--panel-bg: rgba(255,255,255,0.42);
				--panel-border: rgba(91,110,245,0.13);
				--ok-bg: rgba(91,110,245,0.08);
				--ok-border: rgba(91,110,245,0.22);
				--ok-text: var(--accent);
				--btn-bg: rgba(255,255,255,0.55);
				--btn-border: rgba(91,110,245,0.22);
				--btn-hover: rgba(255,255,255,0.80);
				--btn-active: rgba(91,110,245,0.12);
				--input-bg: rgba(255,255,255,0.72);
				--input-border: rgba(91,110,245,0.2);
				--inset: inset 0 1px 0 rgba(255,255,255,0.7);
				color-scheme: light;
			}
			/* body.theme-dark doesn't use aurora body gradient — simpler bg */
			body.theme-dark {
				background: var(--bg);
			}
			body.theme-light {
				background:
					radial-gradient(ellipse 70% 60% at 5% 0%,   color-mix(in srgb, var(--accent)   62%, transparent), transparent),
					radial-gradient(ellipse 55% 50% at 95% 5%,  color-mix(in srgb, var(--accent-2)  48%, transparent), transparent),
					radial-gradient(ellipse 80% 55% at 50% 46%, color-mix(in srgb, var(--accent)   18%, transparent), transparent),
					radial-gradient(ellipse 90% 55% at 25% 100%,color-mix(in srgb, var(--accent-2)  28%, transparent), transparent),
					linear-gradient(135deg,
						color-mix(in srgb, var(--accent) 12%, transparent) 0%,
						transparent 45%,
						color-mix(in srgb, var(--accent-2) 10%, transparent) 100%),
					var(--bg);
			}

			/* ── Note density ───────────────────────────────────────── */
			body.density-compact .doc-item  { padding: 5px 8px; }
			body.density-comfortable .doc-item { padding: 12px 12px; }
			body.density-compact .notes-sidebar { max-height: 520px; }

			/* ── Stats grid (Home panel) ────────────────────────────── */
			.stats-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
				gap: 10px;
				margin-top: 14px;
			}
			.stat-card {
				padding: 12px 14px;
				border-radius: var(--radius-md);
				background: var(--btn-bg);
				border: 1px solid var(--btn-border);
				text-align: center;
				animation: panel-in var(--t-slow) var(--ease) both;
			}
			.stat-card-value {
				font-size: 1.5rem;
				font-weight: 800;
				letter-spacing: -0.03em;
				color: var(--accent);
				line-height: 1;
			}
			.stat-card-label {
				font-size: 0.75rem;
				color: var(--muted);
				margin-top: 4px;
				font-weight: 600;
				letter-spacing: 0.04em;
				text-transform: uppercase;
			}

			/* ── Home panel enriched ────────────────────────────────── */
			.home-greeting {
				display: flex;
				align-items: baseline;
				flex-wrap: wrap;
				gap: 6px 12px;
				margin-bottom: 4px;
			}
			.home-greeting-text {
				font-size: 1.55rem;
				font-weight: 800;
				background: linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
				line-height: 1.25;
			}
			.home-greeting-date {
				font-size: 0.82rem;
				color: var(--muted);
				font-weight: 600;
				align-self: center;
			}
			.home-quick-actions {
				display: flex;
				flex-wrap: wrap;
				gap: 8px;
				margin-top: 14px;
				margin-bottom: 2px;
			}
			.home-qa-btn {
				display: inline-flex;
				align-items: center;
				gap: 6px;
				padding: 8px 16px;
				border-radius: var(--radius-md);
				border: 1.5px solid var(--panel-border);
				background: var(--btn-bg);
				color: var(--fg);
				font-size: 0.88rem;
				font-weight: 600;
				cursor: pointer;
				transition: background 0.15s, border-color 0.15s, transform 0.1s, box-shadow 0.15s;
				backdrop-filter: blur(4px);
			}
			.home-qa-btn:hover {
				background: var(--accent-glow);
				border-color: var(--accent);
				color: var(--accent);
				transform: translateY(-1px);
				box-shadow: 0 3px 10px var(--accent-glow);
			}
			.home-qa-btn.primary {
				background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
				border-color: transparent;
				color: #fff;
			}
			.home-qa-btn.primary:hover {
				opacity: 0.9;
				transform: translateY(-1px);
				box-shadow: 0 4px 14px var(--accent-glow);
				color: #fff;
			}
			/* Recent notes cards */
			.home-note-cards {
				display: flex;
				flex-direction: column;
				gap: 5px;
				margin-top: 10px;
			}
			.home-note-card {
				display: flex;
				align-items: center;
				gap: 10px;
				padding: 9px 12px;
				border-radius: var(--radius-md);
				background: var(--btn-bg);
				border: 1px solid var(--panel-border);
				cursor: pointer;
				font-size: 0.87rem;
				transition: background 0.14s, border-color 0.14s, transform 0.1s;
				animation: file-row-in var(--t-slow) var(--ease) both;
			}
			.home-note-card:hover {
				background: var(--accent-glow);
				border-color: var(--accent);
				transform: translateX(2px);
			}
			.home-note-card-dot {
				width: 8px;
				height: 8px;
				border-radius: 50%;
				flex-shrink: 0;
				background: var(--muted);
			}
			.home-note-card-dot.color-red    { background: #ef4444; }
			.home-note-card-dot.color-yellow { background: #f59e0b; }
			.home-note-card-dot.color-green  { background: #10b981; }
			.home-note-card-dot.color-blue   { background: #3b82f6; }
			.home-note-card-dot.color-purple { background: #a855f7; }
			.home-note-card-title {
				flex: 1;
				font-weight: 600;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			.home-note-card-snippet {
				font-size: 0.78rem;
				color: var(--muted);
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				max-width: 200px;
			}
			.home-note-card-meta {
				display: flex;
				align-items: center;
				gap: 6px;
				flex-shrink: 0;
			}
			.home-note-card-date {
				font-size: 0.73rem;
				color: var(--muted);
				white-space: nowrap;
			}
			.home-note-card-words {
				font-size: 0.71rem;
				color: var(--muted);
				background: var(--panel-border);
				border-radius: 999px;
				padding: 1px 7px;
				white-space: nowrap;
			}
			.home-note-pin { font-size: 0.82rem; flex-shrink: 0; }
			/* Pinned notes on home */
			#home-pinned-notes .home-note-card {
				border-left: 3px solid var(--accent);
			}
			/* Activity row */
			.home-activity-row {
				display: flex;
				align-items: center;
				gap: 10px;
				margin-top: 10px;
				flex-wrap: wrap;
			}
			.home-activity-dots {
				display: flex;
				align-items: flex-end;
				gap: 3px;
			}
			.home-activity-day {
				width: 10px;
				border-radius: 3px;
				background: var(--panel-border);
				transition: background 0.2s, height 0.3s;
				min-height: 4px;
			}
			.home-activity-day.has-edits { background: var(--accent); }
			.home-activity-day.many-edits { background: var(--accent-2); }
			.home-activity-label {
				font-size: 0.75rem;
				color: var(--muted);
				font-weight: 600;
			}
			.home-streak-badge {
				display: inline-flex;
				align-items: center;
				gap: 4px;
				font-size: 0.75rem;
				font-weight: 700;
				color: var(--accent);
				background: var(--accent-glow);
				border: 1px solid var(--panel-border);
				border-radius: 999px;
				padding: 2px 10px;
			}

			/* ── Recent files (Home panel) ──────────────────────────── */
			.recent-files-list {
				margin-top: 10px;
				display: flex;
				flex-direction: column;
				gap: 4px;
			}
			.recent-file-row {
				display: flex;
				align-items: center;
				gap: 8px;
				padding: 7px 10px;
				border-radius: var(--radius-md);
				background: var(--btn-bg);
				border: 1px solid var(--btn-border);
				font-size: 0.87rem;
				animation: file-row-in var(--t-slow) var(--ease) both;
				cursor: default;
			}
			.recent-file-icon { flex-shrink: 0; font-size: 1.1rem; }
			.recent-file-name { flex: 1; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
			.recent-file-date { font-size: 0.75rem; color: var(--muted); white-space: nowrap; }

			/* ── Storage bar (Files panel) ──────────────────────────── */
			.storage-bar-wrap {
				margin-top: 14px;
			}
			.storage-bar-label {
				display: flex;
				justify-content: space-between;
				font-size: 0.78rem;
				color: var(--muted);
				font-weight: 600;
				margin-bottom: 5px;
			}
			.storage-bar-track {
				height: 5px;
				border-radius: 999px;
				background: var(--panel-border);
				overflow: hidden;
			}
			.storage-bar-fill {
				height: 100%;
				border-radius: 999px;
				background: linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
				width: 0%;
				transition: width 0.6s var(--ease);
			}

			/* ── Char-limit warning ─────────────────────────────────── */
			.notes-char-warning {
				font-size: 0.78rem;
				font-weight: 700;
				color: #d97706;
				text-align: right;
				margin-top: 2px;
				display: none;
			}
			.notes-char-warning.visible { display: block; }
			textarea.char-limit-near {
				border-color: #d97706 !important;
				box-shadow: var(--inset), 0 0 0 3px rgba(217,119,6,0.18) !important;
			}
			textarea.char-limit-at {
				border-color: #ef4444 !important;
				box-shadow: var(--inset), 0 0 0 3px rgba(239,68,68,0.18) !important;
			}

			/* ── Drag-to-reorder ────────────────────────────────────── */
			.doc-item.dragging {
				opacity: 0.45;
				transform: scale(0.97);
			}
			.doc-item.drag-over {
				border-color: var(--accent) !important;
				background: var(--accent-glow) !important;
			}

			/* ── Word-goal bar ─────────────────────────────────────── */
			.word-goal-row {
				display: flex;
				align-items: center;
				gap: 10px;
				margin-top: 8px;
			}
			.word-goal-label {
				font-size: 0.75rem;
				color: var(--muted);
				font-weight: 600;
				white-space: nowrap;
				min-width: 80px;
			}
			.word-goal-track {
				flex: 1;
				height: 4px;
				border-radius: 999px;
				background: var(--panel-border);
				overflow: hidden;
			}
			.word-goal-fill {
				height: 100%;
				border-radius: 999px;
				background: linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
				width: 0%;
				transition: width 0.4s var(--ease);
			}
			.word-goal-fill.goal-met {
				background: linear-gradient(90deg, #059669 0%, #34d399 100%);
			}
			.word-goal-set-btn {
				font-size: 0.75rem;
				padding: 4px 10px;
				min-height: 28px;
				border-radius: 999px;
			}

			/* ── Template picker ────────────────────────────────────── */
			.template-picker {
				position: absolute;
				top: calc(100% + 6px);
				left: 0;
				z-index: 200;
				display: flex;
				flex-direction: column;
				gap: 4px;
				padding: 8px;
				background: var(--card-bg);
				border: 1px solid var(--card-border);
				border-radius: var(--radius-md);
				box-shadow: var(--card-shadow);
				backdrop-filter: blur(var(--blur)) saturate(160%);
				-webkit-backdrop-filter: blur(var(--blur)) saturate(160%);
				min-width: 175px;
				animation: panel-in 0.18s var(--ease) both;
			}
			.template-picker[hidden] { display: none !important; }
			.template-option {
				appearance: none;
				background: transparent;
				border: 1px solid transparent;
				color: var(--text);
				padding: 8px 12px;
				border-radius: calc(var(--radius-md) - 2px);
				text-align: left;
				font: inherit;
				font-size: 0.88rem;
				font-weight: 600;
				cursor: pointer;
				transition: background var(--t-fast) var(--ease), border-color var(--t-fast) var(--ease);
			}
			.template-option:hover {
				background: var(--btn-hover);
				border-color: var(--panel-border);
			}
			.template-option-sub {
				display: block;
				font-size: 0.72rem;
				font-weight: 400;
				color: var(--muted);
				margin-top: 1px;
			}
			#btn-new-doc-wrap {
				position: relative;
			}

			/* ── Session info badge ─────────────────────────────────── */
			.session-badge {
				display: inline-flex;
				align-items: center;
				gap: 6px;
				padding: 4px 12px;
				border-radius: 999px;
				font-size: 0.78rem;
				font-weight: 600;
				background: var(--btn-bg);
				border: 1px solid var(--btn-border);
				color: var(--muted);
			}
			.session-badge.expiring-soon {
				border-color: #d97706;
				color: #d97706;
				background: rgba(217,119,6,0.08);
			}

			/* ── Custom app title inputs ────────────────────────────── */
			.app-title-edit {
				display: flex;
				gap: 8px;
				align-items: center;
				flex-wrap: wrap;
				margin-top: 8px;
			}
			.app-title-edit .input {
				font-weight: 700;
			}

			/* ── Auto-lock chips ────────────────────────────────────── */
			/* reuse existing .chip styles, no new CSS needed */

			/* ── Keyboard shortcut hint pill ────────────────────────── */
			.kb-hints {
				display: flex;
				gap: 6px;
				flex-wrap: wrap;
				margin-top: 10px;
			}
			.kb-pill {
				display: inline-flex;
				align-items: center;
				gap: 5px;
				font-size: 0.72rem;
				color: var(--muted);
				font-weight: 500;
			}
			.kb-pill kbd {
				font-family: inherit;
				font-size: 0.7rem;
				font-weight: 700;
				padding: 1px 5px;
				border-radius: 5px;
				background: var(--btn-bg);
				border: 1px solid var(--btn-border);
				color: var(--text);
				letter-spacing: 0.01em;
			}

			/* ── Note color labels ──────────────────────────────────── */
			.doc-color-dot {
				display: inline-block; width: 8px; height: 8px;
				border-radius: 50%; flex-shrink: 0; margin-right: 4px;
				background: transparent; border: 1.5px solid var(--panel-border);
				vertical-align: middle;
			}
			.doc-color-dot[data-color="red"]    { background:#f87171; border-color:#f87171; }
			.doc-color-dot[data-color="yellow"] { background:#fbbf24; border-color:#fbbf24; }
			.doc-color-dot[data-color="green"]  { background:#34d399; border-color:#34d399; }
			.doc-color-dot[data-color="blue"]   { background:#60a5fa; border-color:#60a5fa; }
			.doc-color-dot[data-color="purple"] { background:#a78bfa; border-color:#a78bfa; }
			.doc-item.color-red    { border-left: 2.5px solid #f87171; }
			.doc-item.color-yellow { border-left: 2.5px solid #fbbf24; }
			.doc-item.color-green  { border-left: 2.5px solid #34d399; }
			.doc-item.color-blue   { border-left: 2.5px solid #60a5fa; }
			.doc-item.color-purple { border-left: 2.5px solid #a78bfa; }
			.color-picker-pop {
				position: fixed; z-index: 600;
				display: flex; gap: 5px; padding: 7px 9px;
				background: var(--card-bg); border: 1px solid var(--card-border);
				border-radius: var(--radius-md); box-shadow: var(--card-shadow);
				backdrop-filter: blur(var(--blur)) saturate(160%);
				animation: panel-in 0.15s var(--ease) both;
			}
			.color-picker-pop[hidden] { display: none !important; }
			.color-swatch-btn {
				width: 18px; height: 18px; border-radius: 50%;
				border: 2px solid transparent; cursor: pointer;
				appearance: none; padding: 0; flex-shrink: 0;
				transition: transform 0.12s var(--ease), border-color 0.12s;
			}
			.color-swatch-btn:hover { transform: scale(1.2); }
			.color-swatch-btn.active { border-color: var(--text) !important; }
			.color-swatch-btn[data-color="none"]   { background: var(--btn-bg); border-color: var(--btn-border); }
			.color-swatch-btn[data-color="red"]    { background: #f87171; }
			.color-swatch-btn[data-color="yellow"] { background: #fbbf24; }
			.color-swatch-btn[data-color="green"]  { background: #34d399; }
			.color-swatch-btn[data-color="blue"]   { background: #60a5fa; }
			.color-swatch-btn[data-color="purple"] { background: #a78bfa; }
			.doc-color-btn {
				appearance: none; background: transparent; border: none; cursor: pointer;
				padding: 0 3px; line-height: 1; color: var(--muted); font-size: 0.75rem;
				flex-shrink: 0; position: relative;
			}
			.doc-color-btn:hover { color: var(--text); }
			.doc-item-left { display:flex; align-items:center; gap:2px; min-width:0; flex:1; overflow:hidden; }
			.color-filter-row {
				display: flex; gap: 5px; align-items: center; margin-bottom: 6px; flex-wrap: wrap;
			}
			.color-filter-btn {
				width: 18px; height: 18px; border-radius: 50%; border: 2px solid transparent;
				cursor: pointer; appearance: none; padding: 0; flex-shrink: 0;
				opacity: 0.5; transition: opacity 0.12s, transform 0.12s, border-color 0.12s;
			}
			.color-filter-btn:hover { opacity: 1; }
			.color-filter-btn.active { opacity: 1; border-color: var(--text); transform: scale(1.15); }
			.color-filter-btn[data-color="all"]    { background: var(--btn-bg); border-color: var(--btn-border); font-size:9px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:700; opacity:0.8; }
			.color-filter-btn[data-color="red"]    { background: #f87171; }
			.color-filter-btn[data-color="yellow"] { background: #fbbf24; }
			.color-filter-btn[data-color="green"]  { background: #34d399; }
			.color-filter-btn[data-color="blue"]   { background: #60a5fa; }
			.color-filter-btn[data-color="purple"] { background: #a78bfa; }

			/* ── Focus / writing mode ──────────────────────────────── */
			body.focus-mode .notes-sidebar-wrap,
			body.focus-mode #panel-notes > .row,
			body.focus-mode .kb-hints,
			body.focus-mode .word-goal-row { display: none !important; }
			body.focus-mode .notes-layout { grid-template-columns: 1fr !important; }
			body.focus-mode #notes {
				max-width: 65ch; width: 100%; margin: 0 auto;
				min-height: 70vh; font-size: 1.08rem; line-height: 1.78;
			}
			body.focus-mode .notes-editor-toolbar { max-width: 65ch; margin: 0 auto 8px; }
			.focus-exit-banner {
				position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%);
				z-index: 500; padding: 8px 22px; border-radius: 999px;
				background: var(--card-bg); border: 1px solid var(--card-border);
				box-shadow: var(--card-shadow); backdrop-filter: blur(var(--blur));
				font-size: 0.8rem; color: var(--muted); font-weight: 600;
				pointer-events: none; opacity: 0; transition: opacity 0.3s var(--ease);
				white-space: nowrap;
			}
			body.focus-mode .focus-exit-banner { opacity: 1; }

			/* ── File preview lightbox ─────────────────────────────── */
			.lightbox-overlay {
				position: fixed; inset: 0; z-index: 800;
				background: rgba(0,0,0,0.72); backdrop-filter: blur(6px);
				display: flex; align-items: center; justify-content: center; flex-direction: column;
				padding: 24px; cursor: zoom-out;
				animation: lb-in 0.2s var(--ease) both;
			}
			.lightbox-overlay[hidden] { display: none !important; }
			@keyframes lb-in { from { opacity:0; } to { opacity:1; } }
			.lightbox-inner {
				position: relative; max-width: min(90vw, 900px); cursor: default;
			}
			.lightbox-inner img {
				max-width: 100%; max-height: 78vh; border-radius: var(--radius-md);
				box-shadow: 0 32px 80px rgba(0,0,0,0.55); display: block;
			}
			.lightbox-inner pre {
				max-width: min(80vw, 720px); max-height: 68vh; overflow: auto;
				background: var(--card-bg); border-radius: var(--radius-md);
				padding: 20px 24px; font-size: 0.85rem; line-height: 1.65;
				white-space: pre-wrap; word-break: break-all;
				box-shadow: 0 32px 80px rgba(0,0,0,0.45); color: var(--text);
			}
			.lightbox-close {
				position: absolute; top: -13px; right: -13px; width: 30px; height: 30px;
				border-radius: 50%; background: var(--card-bg); border: 1px solid var(--card-border);
				font-size: 0.95rem; cursor: pointer; display: flex; align-items: center;
				justify-content: center; box-shadow: var(--card-shadow); z-index: 10;
				transition: background var(--t-fast) var(--ease); appearance: none;
			}
			.lightbox-close:hover { background: var(--btn-hover); }
			.lightbox-fname {
				margin-top: 10px; text-align: center; font-size: 0.8rem;
				color: rgba(255,255,255,0.75); font-weight: 600;
			}

			/* ── Keyboard shortcut modal ───────────────────────────── */
			.kb-modal-overlay {
				position: fixed; inset: 0; z-index: 700;
				background: rgba(0,0,0,0.45); backdrop-filter: blur(4px);
				display: flex; align-items: center; justify-content: center;
				padding: 24px; animation: lb-in 0.18s var(--ease) both;
			}
			.kb-modal-overlay[hidden] { display: none !important; }
			.kb-modal {
				background: var(--card-bg); border: 1px solid var(--card-border);
				border-radius: var(--radius-lg); box-shadow: var(--card-shadow);
				backdrop-filter: blur(var(--blur)) saturate(160%);
				padding: 28px 32px; min-width: 300px; max-width: 460px; width: 100%;
				max-height: 82vh; overflow-y: auto;
				animation: panel-in 0.2s var(--ease) both;
			}
			.kb-modal h2 { font-size: 1rem; font-weight: 700; margin: 0 0 18px; }
			.kb-modal-section { margin-bottom: 18px; }
			.kb-modal-section h3 {
				font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
				letter-spacing: 0.06em; color: var(--muted); margin: 0 0 8px;
			}
			.kb-modal-row {
				display: flex; justify-content: space-between; align-items: center;
				padding: 5px 0; border-bottom: 1px solid var(--panel-border);
				font-size: 0.84rem; gap: 16px;
			}
			.kb-modal-row:last-child { border-bottom: none; }
			.kb-modal-keys { display: flex; gap: 4px; flex-shrink: 0; }
			.kb-modal-keys kbd {
				font-family: inherit; font-size: 0.73rem; font-weight: 700;
				padding: 2px 7px; border-radius: 5px;
				background: var(--btn-bg); border: 1px solid var(--btn-border); color: var(--text);
			}
			.kb-modal-close-row { text-align: right; margin-top: 14px; }

			/* ── Undo toast button ──────────────────────────────────── */
			.toast-undo-btn {
				appearance: none;
				border: 1.5px solid currentColor;
				background: transparent;
				color: inherit;
				padding: 3px 10px;
				border-radius: 999px;
				font-size: 0.78rem;
				font-weight: 700;
				cursor: pointer;
				flex-shrink: 0;
				transition: background var(--t-fast) var(--ease);
			}
			.toast-undo-btn:hover { background: rgba(255,255,255,0.15); }

			/* ── Note sort controls ─────────────────────────────────── */
			.notes-sort-row {
				display: flex;
				gap: 5px;
				align-items: center;
				margin-bottom: 4px;
			}
			.notes-sort-select {
				flex: 1;
				font-size: 0.78rem;
				font-weight: 600;
				padding: 4px 8px;
				min-height: 28px;
				border-radius: var(--radius-md);
				border: 1.5px solid var(--input-border);
				background: var(--input-bg);
				color: var(--text);
				cursor: pointer;
				appearance: none;
				background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23888' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
				background-repeat: no-repeat;
				background-position: right 8px center;
				padding-right: 24px;
			}
			.notes-sort-select:focus {
				outline: none;
				border-color: var(--accent);
				box-shadow: 0 0 0 3px var(--accent-glow);
			}

			/* ── Note search snippet ────────────────────────────────── */
			.doc-item-snippet {
				display: block;
				font-size: 0.72rem;
				color: var(--muted);
				font-weight: 400;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				margin-top: 1px;
				max-width: 100%;
			}
			.doc-item-snippet mark {
				background: color-mix(in srgb, var(--accent) 25%, transparent);
				color: var(--accent);
				border-radius: 2px;
				padding: 0 1px;
				font-weight: 700;
			}
			/* Make doc-item taller when showing snippet */
			.doc-item.has-snippet { align-items: flex-start; }
			.doc-item.has-snippet .doc-item-left { flex-direction: column; align-items: flex-start; }

			/* ── Markdown preview ───────────────────────────────────── */
			.notes-editor-col.preview-mode {
				display: grid;
				grid-template-rows: auto 1fr auto auto auto;
				grid-template-columns: 1fr 1fr;
				column-gap: 14px;
			}
			.notes-editor-col.preview-mode .notes-editor-toolbar { grid-column: 1 / -1; }
			.notes-editor-col.preview-mode #notes { grid-column: 1; }
			.md-preview-pane {
				grid-column: 2;
				grid-row: 2;
				border-radius: var(--radius-md);
				border: 1.5px solid var(--input-border);
				background: var(--input-bg);
				padding: 12px 16px;
				overflow-y: auto;
				font-size: var(--base-font);
				line-height: 1.65;
				color: var(--text);
				min-height: var(--textarea-h);
			}
			.md-preview-pane[hidden] { display: none !important; }
			.md-preview-pane h1,.md-preview-pane h2,.md-preview-pane h3,
			.md-preview-pane h4,.md-preview-pane h5,.md-preview-pane h6 {
				line-height: 1.2; margin: 1em 0 0.4em; font-weight: 700; color: var(--text);
			}
			.md-preview-pane h1 { font-size: 1.55em; }
			.md-preview-pane h2 { font-size: 1.3em; }
			.md-preview-pane h3 { font-size: 1.1em; }
			.md-preview-pane p  { margin: 0.55em 0; }
			.md-preview-pane code {
				font-family: ui-monospace, 'Fira Mono', monospace;
				font-size: 0.88em;
				background: color-mix(in srgb, var(--accent) 10%, transparent);
				border-radius: 4px; padding: 1px 5px;
			}
			.md-preview-pane pre {
				background: color-mix(in srgb, CanvasText 5%, transparent);
				border-radius: var(--radius-md); padding: 12px 14px;
				overflow-x: auto; font-size: 0.85em; line-height: 1.6;
				margin: 0.7em 0;
			}
			.md-preview-pane pre code { background: none; padding: 0; }
			.md-preview-pane blockquote {
				border-left: 3px solid var(--accent); margin: 0.7em 0;
				padding: 0.2em 0.8em; color: var(--muted);
			}
			.md-preview-pane ul,.md-preview-pane ol { padding-left: 1.4em; margin: 0.5em 0; }
			.md-preview-pane li { margin: 0.2em 0; }
			.md-preview-pane hr { border: none; border-top: 1px solid var(--panel-border); margin: 1em 0; }
			.md-preview-pane a { color: var(--accent); }
			.md-preview-pane strong { font-weight: 700; }
			.md-preview-pane em { font-style: italic; }
			.md-preview-pane table { border-collapse: collapse; width: 100%; margin: 0.6em 0; }
			.md-preview-pane th,.md-preview-pane td {
				border: 1px solid var(--panel-border); padding: 5px 10px;
				text-align: left; font-size: 0.9em;
			}
			.md-preview-pane th { background: color-mix(in srgb, var(--accent) 8%, transparent); font-weight: 700; }
			/* task list checkboxes */
			.md-preview-pane .task-list-item { list-style: none; }
			.md-preview-pane .task-list-item input[type="checkbox"] { margin-right: 6px; accent-color: var(--accent); }
			@media (max-width: 700px) {
				.notes-editor-col.preview-mode { grid-template-columns: 1fr; }
				.notes-editor-col.preview-mode #notes { grid-column: 1; }
				.md-preview-pane { grid-column: 1; grid-row: 3; }
			}

			/* ── Stat card hover ──────────────────────────────────── */
			.stat-card {
				cursor: default;
				transition: transform var(--t-mid) var(--ease-spring), box-shadow var(--t-mid) var(--ease), border-color var(--t-fast) var(--ease);
			}
			.stat-card.clickable { cursor: pointer; }
			.stat-card.clickable:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 20px var(--accent-glow);
				border-color: var(--accent);
			}
			.stat-card.clickable:active { transform: scale(0.96); }

			/* ── File search bar ────────────────────────────────────── */
			.file-search-row {
				display: flex;
				gap: 8px;
				align-items: center;
				margin: 12px 0 0;
			}
			.file-search-input {
				flex: 1;
				font-size: 0.88rem;
			}

			/* ── Notes sidebar scrollbar polish ─────────────────────── */
			.notes-sidebar {
				scrollbar-width: thin;
				scrollbar-color: var(--accent) transparent;
			}
			.notes-sidebar::-webkit-scrollbar { width: 4px; }
			.notes-sidebar::-webkit-scrollbar-track { background: transparent; }
			.notes-sidebar::-webkit-scrollbar-thumb {
				background: var(--accent);
				border-radius: 99px;
				opacity: 0.5;
			}

			/* ── Duplicate button style ─────────────────────────────── */
			/* reuses .btn .btn-small — no new rules needed */

			/* ── Note count badge in sidebar ────────────────────────── */
			.notes-count-badge {
				font-size: 0.7rem;
				color: var(--muted);
				font-weight: 600;
				padding: 1px 7px;
				border-radius: 999px;
				background: var(--btn-bg);
				border: 1px solid var(--btn-border);
				white-space: nowrap;
				align-self: center;
			}

			/* ── Formatting toolbar buttons ────────────────────────── */
			.fmt-btn {
				font-weight: 700;
				font-size: 0.85rem;
				min-width: 28px;
				padding: 4px 7px;
				font-family: ui-monospace, 'Fira Mono', monospace;
			}
			.fmt-btn:active { transform: scale(0.92); }
			.fmt-divider {
				width: 1px;
				height: 20px;
				background: var(--btn-border);
				align-self: center;
				flex-shrink: 0;
				margin: 0 2px;
			}

			/* ── Pinned badge on doc-item ───────────────────────────── */
			.doc-item-pin-badge {
				font-size: 0.7rem;
				opacity: 0.7;
				flex-shrink: 0;
				line-height: 1;
				margin-right: -2px;
			}

			/* ── History / snapshot restore dropdown ────────────────── */
			.history-wrap { position: relative; }
			.history-pop {
				position: fixed;
				z-index: 9000;
				min-width: 220px;
				max-width: 320px;
				background: var(--card-bg);
				border: 1.5px solid var(--input-border);
				border-radius: var(--radius-md);
				box-shadow: 0 12px 40px rgba(0,0,0,0.18);
				backdrop-filter: blur(var(--blur));
				-webkit-backdrop-filter: blur(var(--blur));
				padding: 6px 0;
				overflow-y: auto;
				max-height: 280px;
			}
			.history-pop[hidden] { display: none !important; }
			.history-pop-item {
				display: block;
				width: 100%;
				text-align: left;
				background: none;
				border: none;
				padding: 8px 14px;
				font-size: 0.82rem;
				color: var(--text);
				cursor: pointer;
				line-height: 1.3;
				border-bottom: 1px solid var(--panel-border);
			}
			.history-pop-item:last-child { border-bottom: none; }
			.history-pop-item:hover { background: var(--btn-hover); }
			.history-pop-item .hist-ts { display: block; font-size: 0.72rem; color: var(--muted); margin-bottom: 2px; }
			.history-pop-item .hist-preview { display: block; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
			.history-pop-empty { padding: 10px 14px; font-size: 0.82rem; color: var(--muted); text-align: center; }

			/* ── Quick-insert macro hint ────────────────────────────── */
			.macro-hint {
				display: none;
				position: fixed;
				z-index: 8000;
				background: var(--card-bg);
				border: 1.5px solid var(--input-border);
				border-radius: var(--radius-md);
				box-shadow: 0 8px 28px rgba(0,0,0,0.16);
				backdrop-filter: blur(var(--blur));
				-webkit-backdrop-filter: blur(var(--blur));
				padding: 6px 0;
				min-width: 180px;
			}
			.macro-hint.visible { display: block; }
			.macro-hint-item {
				display: flex;
				align-items: center;
				gap: 10px;
				padding: 7px 14px;
				cursor: pointer;
				font-size: 0.83rem;
				border-bottom: 1px solid var(--panel-border);
			}
			.macro-hint-item:last-child { border-bottom: none; }
			.macro-hint-item:hover, .macro-hint-item.active { background: var(--ok-bg); color: var(--accent); }
			.macro-hint-item kbd { font-size: 0.72rem; background: var(--btn-bg); border: 1px solid var(--btn-border); border-radius: 4px; padding: 1px 5px; font-family: ui-monospace, monospace; }
			.macro-hint-item span { color: var(--muted); font-size: 0.78rem; }

			/* ── Files sort + bulk delete bar ───────────────────────── */
			.files-controls-row {
				display: flex;
				gap: 8px;
				align-items: center;
				margin: 10px 0 0;
				flex-wrap: wrap;
			}
			.files-sort-select {
				font-size: 0.82rem;
				font-weight: 600;
				padding: 5px 28px 5px 10px;
				min-height: 30px;
				border-radius: var(--radius-md);
				border: 1.5px solid var(--input-border);
				background: var(--input-bg);
				color: var(--text);
				cursor: pointer;
				appearance: none;
				background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%23697285' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
				background-repeat: no-repeat;
				background-position: right 9px center;
			}
			.files-sort-select:focus { outline: 2px solid var(--ring); outline-offset: 2px; }
			.files-bulk-btn {
				margin-left: auto;
				display: none;
			}
			.files-bulk-btn.visible { display: inline-flex; }
			.file-row-check {
				width: 16px;
				height: 16px;
				accent-color: var(--accent);
				cursor: pointer;
				flex-shrink: 0;
				margin-right: 2px;
			}

			/* ── Tools panel ────────────────────────────────────────── */
			.tool-card {
				background: var(--btn-bg);
				border: 1px solid var(--panel-border);
				border-radius: var(--radius-md);
				margin-bottom: 14px;
				overflow: hidden;
				animation: file-row-in var(--t-slow) var(--ease) both;
			}
			.tool-card-header {
				padding: 10px 14px;
				font-size: 0.88rem;
				font-weight: 700;
				border-bottom: 1px solid var(--panel-border);
				background: var(--accent-glow);
				letter-spacing: 0.01em;
			}
			.tool-card-body {
				padding: 12px 14px;
				display: flex;
				flex-direction: column;
				gap: 10px;
			}
			.tool-row {
				display: flex;
				align-items: center;
				gap: 8px;
			}
			.tool-output {
				flex: 1;
				font-family: ui-monospace, monospace;
				font-size: 0.85rem;
			}
			.tool-textarea {
				width: 100%;
				box-sizing: border-box;
				resize: vertical;
				font-family: ui-monospace, monospace;
				font-size: 0.83rem;
				min-height: 70px;
			}
			.tool-check-row { gap: 14px; flex-wrap: wrap; }
			.tool-check {
				display: flex;
				align-items: center;
				gap: 5px;
				font-size: 0.84rem;
				cursor: pointer;
				color: var(--fg);
			}
			.tool-label {
				font-size: 0.83rem;
				color: var(--muted);
				white-space: nowrap;
			}
			.tool-range {
				flex: 1;
				min-width: 80px;
				accent-color: var(--accent);
			}
			.tool-num-input {
				width: 52px;
				padding: 3px 6px;
				border-radius: var(--radius-sm);
				border: 1.5px solid var(--input-border);
				background: var(--input-bg);
				color: var(--fg);
				font-size: 0.83rem;
				text-align: center;
			}
			.tool-select {
				padding: 4px 8px;
				border-radius: var(--radius-sm);
				border: 1.5px solid var(--input-border);
				background: var(--input-bg);
				color: var(--text);
				font-size: 0.83rem;
			}
			.tool-pw-strength {
				font-size: 0.78rem;
				font-weight: 700;
				padding: 2px 10px;
				border-radius: 999px;
				background: var(--panel-border);
			}
			.tool-pw-strength.weak   { background: #fee2e2; color: #dc2626; }
			.tool-pw-strength.fair   { background: #fef3c7; color: #d97706; }
			.tool-pw-strength.strong { background: #d1fae5; color: #059669; }
			.tool-pw-strength.great  { background: #ede9fe; color: #7c3aed; }
			.tool-stats-row { display: flex; gap: 6px; flex-wrap: wrap; }
			.tool-stat-pill {
				font-size: 0.78rem;
				font-weight: 600;
				padding: 3px 10px;
				border-radius: 999px;
				background: var(--accent-glow);
				color: var(--accent);
				border: 1px solid var(--panel-border);
			}
			/* Pomodoro */
			.tool-pomo-body { align-items: center; }
			.tool-pomo-ring-wrap {
				position: relative;
				width: 110px;
				height: 110px;
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.tool-pomo-ring {
				position: absolute;
				inset: 0;
				width: 100%;
				height: 100%;
				transform: rotate(-90deg);
			}
			.pomo-track { fill: none; stroke: var(--panel-border); stroke-width: 6; }
			.pomo-fill  {
				fill: none;
				stroke: var(--accent);
				stroke-width: 6;
				stroke-linecap: round;
				transition: stroke-dashoffset 1s linear, stroke 0.4s;
				stroke-dasharray: 213.6;
				stroke-dashoffset: 0;
			}
			.pomo-break .pomo-fill { stroke: var(--accent-2); }
			.tool-pomo-inner {
				position: relative;
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 2px;
			}
			.tool-pomo-time {
				font-size: 1.35rem;
				font-weight: 800;
				line-height: 1;
			}
			.tool-pomo-phase {
				font-size: 0.68rem;
				font-weight: 700;
				color: var(--muted);
				text-transform: uppercase;
				letter-spacing: 0.06em;
			}
			.tool-pomo-controls { justify-content: center; }
			.tool-pomo-log {
				width: 100%;
				font-size: 0.76rem;
				color: var(--muted);
				text-align: center;
				min-height: 18px;
			}
			/* UUID list */
			.tool-uuid-list { display: flex; flex-direction: column; gap: 4px; }
			.tool-uuid-row {
				display: flex;
				align-items: center;
				gap: 8px;
				padding: 4px 8px;
				border-radius: var(--radius-sm);
				background: var(--input-bg);
				border: 1px solid var(--panel-border);
			}
			.tool-uuid-val {
				flex: 1;
				font-family: ui-monospace, monospace;
				font-size: 0.8rem;
				user-select: all;
			}
			.tool-uuid-copy-btn {
				padding: 2px 8px;
				font-size: 0.72rem;
				cursor: pointer;
				background: var(--btn-bg);
				border: 1px solid var(--btn-border);
				border-radius: var(--radius-sm);
				color: var(--fg);
			}
			.tool-uuid-copy-btn:hover { background: var(--accent-glow); color: var(--accent); }
			/* JSON / Timestamp */
			.tool-json-status { font-size: 0.78rem; font-weight: 600; }
			.tool-json-status.ok  { color: #059669; }
			.tool-json-status.err { color: #dc2626; }
			.tool-ts-results { display: flex; flex-direction: column; gap: 4px; margin-top: 4px; }
			.tool-ts-row { display: flex; gap: 8px; font-size: 0.82rem; align-items: center; }
			.tool-ts-label { color: var(--muted); font-weight: 600; min-width: 120px; flex-shrink: 0; }
			.tool-ts-val { font-family: ui-monospace, monospace; user-select: all; }

			/* ── Work panel ─────────────────────────────────────────── */
			.work-subsection-label {
				font-size: 0.78rem;
				font-weight: 700;
				color: var(--muted);
				text-transform: uppercase;
				letter-spacing: 0.06em;
				margin-bottom: 6px;
			}
			.work-report-section-label {
				font-size: 0.72rem;
				font-weight: 700;
				color: var(--accent);
				text-transform: uppercase;
				letter-spacing: 0.08em;
				margin: 10px 0 5px;
				padding-bottom: 4px;
				border-bottom: 1px solid var(--panel-border);
			}
			.rpt-client-chip {
				display: inline-flex;
				align-items: center;
				gap: 5px;
				background: var(--btn-bg);
				border: 1px solid var(--btn-border);
				border-radius: var(--radius-sm);
				padding: 3px 8px 3px 10px;
				font-size: 0.78rem;
				cursor: pointer;
				transition: border-color var(--t-slow) var(--ease);
			}
			.rpt-client-chip:hover { border-color: var(--accent); }
			.rpt-chip-name { color: var(--fg); }
			.rpt-chip-del {
				background: none;
				border: none;
				color: var(--muted);
				cursor: pointer;
				font-size: 0.7rem;
				padding: 0 2px;
				line-height: 1;
				transition: color var(--t-slow) var(--ease);
			}
			.rpt-chip-del:hover { color: #dc2626; }
			/* ── Reports topbar ── */
			.rpt-topbar {
				display: flex;
				align-items: center;
				gap: 10px;
				padding: 8px 16px;
				background: var(--input-bg);
				border-bottom: 1px solid var(--panel-border);
				flex-wrap: wrap;
				position: sticky;
				top: 0;
				z-index: 10;
			}
			.rpt-topbar-label {
				font-size: 0.78rem;
				font-weight: 700;
				color: var(--muted);
				white-space: nowrap;
			}
			#rpt-client-select,
			#rpt-tech-select {
				flex: 1;
				min-width: 180px;
				max-width: 380px;
			}
			.rpt-keep-label {
				display: flex;
				align-items: center;
				gap: 7px;
				font-size: 0.8rem;
				color: var(--muted);
				cursor: pointer;
				margin-top: 8px;
				user-select: none;
			}
			.rpt-keep-label input[type="checkbox"] { cursor: pointer; accent-color: var(--accent); }
			.rpt-field-group {
				display: flex;
				flex-direction: column;
				gap: 0;
				margin-top: 8px;
			}
			.rpt-field-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				background: var(--input-bg);
				border: 1px solid var(--input-border);
				border-bottom: none;
				border-radius: var(--radius-sm) var(--radius-sm) 0 0;
				padding: 5px 10px;
				gap: 8px;
			}
			.rpt-field-header + .input {
				border-top-left-radius: 0;
				border-top-right-radius: 0;
			}
			.rpt-field-label {
				font-size: 0.75rem;
				font-weight: 700;
				text-transform: uppercase;
				letter-spacing: 0.07em;
				color: var(--accent);
			}
			.rpt-date-input {
				width: auto !important;
				flex: none !important;
				font-size: 0.75rem !important;
				padding: 3px 7px !important;
				border-radius: var(--radius-sm) !important;
				color: var(--muted) !important;
			}
			.work-ticket-list {
				display: flex;
				flex-direction: column;
				gap: 5px;
				max-height: 260px;
				overflow-y: auto;
				margin-top: 2px;
			}
			.work-ticket-row {
				display: flex;
				align-items: flex-start;
				gap: 8px;
				padding: 8px 10px;
				border-radius: var(--radius-sm);
				background: var(--input-bg);
				border: 1px solid var(--panel-border);
				font-size: 0.82rem;
				animation: file-row-in var(--t-slow) var(--ease) both;
			}
			.work-ticket-row-meta {
				display: flex;
				flex-direction: column;
				gap: 2px;
				flex: 1;
				min-width: 0;
			}
			.work-ticket-row-top {
				display: flex;
				align-items: center;
				gap: 6px;
				flex-wrap: wrap;
			}
			.work-ticket-id { font-weight: 700; }
			.work-ticket-badge {
				font-size: 0.71rem;
				font-weight: 700;
				padding: 1px 7px;
				border-radius: 999px;
				border: 1px solid var(--panel-border);
				white-space: nowrap;
			}
			.work-badge-open     { background:#fee2e2; color:#dc2626; }
			.work-badge-inprog   { background:#fef3c7; color:#92400e; }
			.work-badge-waiting  { background:#dbeafe; color:#1d4ed8; }
			.work-badge-done     { background:#d1fae5; color:#059669; }
			.work-ticket-notes-text { color: var(--muted); font-size: 0.78rem; white-space: pre-wrap; word-break: break-word; }
			.work-ticket-date { font-size: 0.71rem; color: var(--muted); white-space: nowrap; flex-shrink: 0; }
			.work-ticket-del {
				background: none;
				border: none;
				cursor: pointer;
				color: var(--muted);
				font-size: 0.85rem;
				padding: 0 2px;
				flex-shrink: 0;
				line-height: 1;
			}
			.work-ticket-del:hover { color: #dc2626; }
			.work-ticket-count { font-size: 0.78rem; color: var(--muted); font-weight: 600; }
			/* Subnet results */
			.work-subnet-results {
				display: flex;
				flex-direction: column;
				gap: 3px;
				margin-top: 4px;
			}
			.work-subnet-row {
				display: flex;
				gap: 8px;
				font-size: 0.81rem;
				align-items: center;
			}
			.work-subnet-label {
				color: var(--muted);
				font-weight: 600;
				min-width: 140px;
				flex-shrink: 0;
			}
			.work-subnet-val {
				font-family: ui-monospace, monospace;
				user-select: all;
			}
			/* Ports grid */
			.work-ports-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
				gap: 4px;
			}
			.work-port-chip {
				display: flex;
				align-items: center;
				gap: 6px;
				padding: 4px 8px;
				border-radius: var(--radius-sm);
				background: var(--input-bg);
				border: 1px solid var(--panel-border);
				font-size: 0.78rem;
			}
			.work-port-num {
				font-family: ui-monospace, monospace;
				font-weight: 700;
				color: var(--accent);
				min-width: 42px;
			}
			.work-port-desc { color: var(--fg); }
			/* IP ranges */
			.work-ip-ranges {
				display: flex;
				flex-direction: column;
				gap: 3px;
			}
			.work-ip-row {
				display: flex;
				gap: 10px;
				font-size: 0.8rem;
				align-items: center;
			}
			.work-ip-range {
				font-family: ui-monospace, monospace;
				color: var(--accent);
				min-width: 160px;
			}
			.work-ip-desc { color: var(--muted); font-size: 0.76rem; }
			/* Checklist */
			.work-checklist {
				display: flex;
				flex-direction: column;
				gap: 5px;
				margin-top: 4px;
			}
			.work-check-item {
				display: flex;
				align-items: flex-start;
				gap: 8px;
				padding: 6px 10px;
				border-radius: var(--radius-sm);
				background: var(--input-bg);
				border: 1px solid var(--panel-border);
				font-size: 0.83rem;
				cursor: pointer;
				transition: background 0.12s;
			}
			.work-check-item:hover { background: var(--accent-glow); }
			.work-check-item.done {
				opacity: 0.55;
				text-decoration: line-through;
				background: var(--btn-bg);
			}
			.work-check-item input[type=checkbox] { accent-color: var(--accent); flex-shrink: 0; margin-top: 1px; }
			.work-check-text { flex: 1; line-height: 1.4; }
			.work-check-cat {
				font-size: 0.68rem;
				font-weight: 700;
				color: var(--muted);
				text-transform: uppercase;
				letter-spacing: 0.05em;
				flex-shrink: 0;
				margin-top: 2px;
			}
			/* Storage results */
			.work-storage-results {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
				gap: 5px;
				margin-top: 4px;
			}
			.work-storage-chip {
				padding: 5px 10px;
				border-radius: var(--radius-sm);
				background: var(--input-bg);
				border: 1px solid var(--panel-border);
				font-size: 0.78rem;
			}
			.work-storage-chip-unit { color: var(--muted); font-weight: 700; font-size: 0.7rem; }
			.work-storage-chip-val  { font-family: ui-monospace, monospace; font-weight: 600; }
			/* CMD grid */
			.work-cmd-grid {
				display: flex;
				flex-direction: column;
				gap: 4px;
				margin-top: 6px;
				max-height: 300px;
				overflow-y: auto;
			}
			.work-cmd-row {
				display: flex;
				align-items: flex-start;
				gap: 10px;
				padding: 5px 8px;
				border-radius: var(--radius-sm);
				background: var(--input-bg);
				border: 1px solid var(--panel-border);
				font-size: 0.81rem;
				cursor: pointer;
				transition: background 0.12s;
			}
			.work-cmd-row:hover { background: var(--accent-glow); }
			.work-cmd-cmd {
				font-family: ui-monospace, monospace;
				font-weight: 700;
				color: var(--accent);
				min-width: 160px;
				flex-shrink: 0;
				word-break: break-all;
			}
			.work-cmd-desc { color: var(--fg); flex: 1; font-size: 0.78rem; }
			.work-cmd-tag {
				font-size: 0.68rem;
				font-weight: 700;
				padding: 1px 6px;
				border-radius: 999px;
				background: var(--panel-border);
				color: var(--muted);
				white-space: nowrap;
				flex-shrink: 0;
			}

			@media (prefers-reduced-motion: reduce) {
				* {
					scroll-behavior: auto !important;
					transition: none !important;
					animation: none !important;
				}
				body::after {
					animation: none !important;
				}
				#splash { display: none !important; }
			}
		</style>

		<!-- Print stylesheet — only active when window.print() is called from the preview modal -->
		<style id="rpt-print-style">
			/* ── Print preview modal (screen only) ── */
			.rpt-print-overlay {
				position: fixed;
				inset: 0;
				background: rgba(0,0,0,0.72);
				z-index: 9000;
				display: flex;
				align-items: flex-start;
				justify-content: center;
				padding: 24px 16px 16px;
				backdrop-filter: blur(4px);
			}
			.rpt-print-overlay[hidden] { display: none !important; }
			.rpt-print-modal {
				background: #1e1e1e;
				border: 1px solid #333;
				border-radius: 10px;
				width: 100%;
				max-width: 820px;
				max-height: calc(100vh - 40px);
				display: flex;
				flex-direction: column;
				overflow: hidden;
				box-shadow: 0 24px 64px rgba(0,0,0,0.6);
			}
			.rpt-print-toolbar {
				display: flex;
				align-items: center;
				justify-content: space-between;
				padding: 12px 16px;
				border-bottom: 1px solid #333;
				flex-shrink: 0;
			}
			.rpt-print-toolbar-title {
				font-size: 0.85rem;
				font-weight: 600;
				color: #ccc;
			}
			.rpt-print-scroll {
				overflow-y: auto;
				padding: 24px;
				background: #2a2a2a;
				flex: 1;
			}
			/* A4 paper simulation on screen */
			.rpt-a4 {
				width: 210mm;
				min-height: 297mm;
				margin: 0 auto;
				background: #ffffff;
				color: #000000;
				padding: 18mm 16mm 16mm;
				box-shadow: 0 4px 32px rgba(0,0,0,0.5);
				font-family: 'Segoe UI', Arial, sans-serif;
				font-size: 10pt;
				line-height: 1.5;
				box-sizing: border-box;
			}
			/* A4 internal layout */
			.rpt-a4 .rpt-header {
				text-align: center;
				margin-bottom: 8mm;
				padding-bottom: 5mm;
				border-bottom: 2.5pt solid #111;
			}
			.rpt-a4 .rpt-header h1 {
				font-size: 22pt;
				font-weight: 900;
				letter-spacing: -1px;
				color: #111;
				margin: 0 0 4px;
			}
			.rpt-a4 .rpt-ref {
				font-size: 8pt;
				color: #666;
			}
			.rpt-a4 .rpt-meta-grid {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 5mm 8mm;
				margin-bottom: 7mm;
			}
			.rpt-a4 .rpt-meta-box {
				background: #f7f7f7;
				border: 1pt solid #ddd;
				border-radius: 4pt;
				padding: 3.5mm 4mm;
			}
			.rpt-a4 .rpt-meta-box h2 {
				font-size: 7pt;
				text-transform: uppercase;
				letter-spacing: 0.8px;
				color: #888;
				margin: 0 0 2mm;
				font-weight: 700;
			}
			.rpt-a4 .rpt-meta-row {
				display: flex;
				justify-content: space-between;
				font-size: 9.5pt;
				margin-bottom: 1.5mm;
				gap: 4mm;
			}
			.rpt-a4 .rpt-meta-row:last-child { margin-bottom: 0; }
			.rpt-a4 .rpt-meta-label {
				color: #555;
				font-weight: 500;
				white-space: nowrap;
				flex-shrink: 0;
			}
			.rpt-a4 .rpt-meta-val {
				color: #111;
				font-weight: 600;
				text-align: right;
				word-break: break-word;
			}
			.rpt-a4 .rpt-section {
				margin-bottom: 6mm;
			}
			.rpt-a4 .rpt-section-title {
				font-size: 8pt;
				font-weight: 700;
				text-transform: uppercase;
				letter-spacing: 1px;
				color: #fff;
				background: #222;
				padding: 2mm 4mm;
				border-radius: 3pt 3pt 0 0;
				margin-bottom: 0;
			}
			.rpt-a4 .rpt-section-body {
				border: 1pt solid #ccc;
				border-top: none;
				padding: 3.5mm 4mm;
				border-radius: 0 0 3pt 3pt;
				background: #fff;
				min-height: 16mm;
			}
			.rpt-a4 .rpt-section-body p {
				margin: 0 0 1.5mm;
				font-size: 9.5pt;
				color: #222;
			}
			.rpt-a4 .rpt-section-body ul {
				margin: 0;
				padding-left: 5mm;
			}
			.rpt-a4 .rpt-section-body li {
				font-size: 9.5pt;
				color: #222;
				margin-bottom: 1mm;
			}
			.rpt-a4 .rpt-summary-bar {
				display: flex;
				gap: 4mm;
				margin-bottom: 7mm;
			}
			.rpt-a4 .rpt-summary-chip {
				flex: 1;
				background: #f0f0f0;
				border: 1pt solid #ccc;
				border-radius: 4pt;
				padding: 2.5mm 4mm;
				text-align: center;
			}
			.rpt-a4 .rpt-summary-chip .rpt-chip-label {
				font-size: 7pt;
				text-transform: uppercase;
				letter-spacing: 0.6px;
				color: #888;
				font-weight: 600;
			}
			.rpt-a4 .rpt-summary-chip .rpt-chip-val {
				font-size: 9.5pt;
				font-weight: 700;
				color: #111;
				margin-top: 1mm;
			}
			.rpt-a4 .rpt-sig-block {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 8mm;
				margin-top: 8mm;
				padding-top: 5mm;
				border-top: 1pt solid #ccc;
			}
			.rpt-a4 .rpt-sig-line {
				border-top: 1pt solid #aaa;
				padding-top: 2mm;
				font-size: 8pt;
				color: #777;
			}
			.rpt-a4 .rpt-footer {
				margin-top: 8mm;
				padding-top: 4mm;
				border-top: 1.5pt solid #111;
				display: flex;
				justify-content: space-between;
				align-items: center;
				font-size: 7.5pt;
				color: #888;
			}
			/* ── @media print — hide UI chrome if user prints directly from main window ── */
			@media print {
				body > * { display: none !important; }
			}
		</style>
	</head>

	<body>
		<!-- ── Splash screen ── -->
		<div id="splash" role="status" aria-label="Loading">
			<div class="splash-inner">
				<div class="splash-mark" aria-hidden="true">e</div>
				<div class="splash-dots" aria-hidden="true">
					<span></span><span></span><span></span>
				</div>
			</div>
		</div>

		<div class="wrap" id="login-screen">
			<main class="card">
				<header>
					<div class="mark" aria-hidden="true">e</div>
					<div>
						<h1>ectl.me</h1>
						<p class="subtitle">Log in to continue.</p>
					</div>
				</header>

				<div class="row" style="margin-bottom: 0">
					<div class="auth">
						<span id="login-status">Signed out</span>
					</div>
					<div>
						<button class="btn btn-small" id="btn-toggle-login-debug" type="button" aria-expanded="false">
							Show status
						</button>
					</div>
				</div>

				<div class="tabs" role="tablist" aria-label="Auth tabs">
					<button class="tab" id="auth-tab-login" type="button" role="tab" aria-controls="auth-panel-login" aria-selected="true">
						Log in
					</button>
					<span class="tab-indicator" id="auth-tab-indicator"></span>
				</div>

				<section class="panel" id="auth-panel-login" role="tabpanel" aria-labelledby="auth-tab-login">
					<div class="fields">
						<div class="field">
							<label for="login-identifier">Username or email</label>
							<input
								class="input"
								id="login-identifier"
								name="username"
								type="text"
								autocomplete="username"
								placeholder="yourname or you@example.com"
							/>
						</div>
						<div class="field">
							<label for="login-password">Password</label>
							<div class="pwrow">
								<input class="input" id="login-password" name="password" type="password" autocomplete="current-password" placeholder="your password" />
								<button class="btn btn-small" id="btn-toggle-login-password" type="button" aria-pressed="false">
									Show
								</button>
							</div>
						</div>
					</div>

					<div class="actions">
						<button class="btn btn-accent" id="btn-login" type="button">Log in</button>
					</div>
					<p class="hint">You can log in with either username or email.</p>
				</section>


				<p class="hint" id="login-debug" hidden></p>
			</main>
		</div>

		<div class="wrap" id="app" hidden>
			<main class="card">
				<header>
					<div class="mark" aria-hidden="true">e</div>
					<div>
						<h1>ectl.me</h1>
						<p class="subtitle">A small tools site.</p>

						<div class="tabs" role="tablist" aria-label="Page tabs">
							<button class="tab" id="tab-home" type="button" role="tab" aria-controls="panel-home" aria-selected="true">Home</button>
							<button class="tab" id="tab-notes" type="button" role="tab" aria-controls="panel-notes" aria-selected="false">Notes</button>
							<button class="tab" id="tab-settings" type="button" role="tab" aria-controls="panel-settings" aria-selected="false">Settings</button>
							<button class="tab" id="tab-files" type="button" role="tab" aria-controls="panel-files" aria-selected="false">Files</button>
							<button class="tab" id="tab-tools" type="button" role="tab" aria-controls="panel-tools" aria-selected="false">Tools</button>
							<button class="tab" id="tab-work" type="button" role="tab" aria-controls="panel-work" aria-selected="false">Work</button>
						<button class="tab" id="tab-reports" type="button" role="tab" aria-controls="panel-reports" aria-selected="false">Reports</button>
							<button class="tab" id="tab-admin" type="button" role="tab" aria-controls="panel-admin" aria-selected="false" hidden>👤 Accounts</button>
							<span class="tab-indicator" id="app-tab-indicator"></span>
						</div>
					</div>
						<div class="header-actions" style="display:flex;gap:8px;align-items:center;">
							<button class="btn btn-small" id="btn-shortcuts-help" type="button" aria-label="Keyboard shortcuts" title="Keyboard shortcuts" style="font-weight:700">?</button>
							<button class="btn btn-small" id="btn-theme-toggle" type="button" aria-label="Toggle dark/light mode" title="Toggle dark/light mode">🌙</button>
							<button class="btn" id="btn-signout" type="button" hidden>Sign out</button>
						</div>
				</header>

				<section class="panel" id="panel-home" role="tabpanel" aria-labelledby="tab-home">

					<!-- Greeting (logged-in) -->
					<div id="home-greeting" hidden>
						<div class="home-greeting">
							<span class="home-greeting-text" id="home-greeting-text"></span>
							<span class="home-greeting-date" id="home-greeting-date"></span>
						</div>
						<span id="home-last-signin" style="font-size:0.77rem;color:var(--muted);font-weight:600;display:block;margin-top:2px"></span>
					</div>

					<!-- Signed-out placeholder -->
					<div id="home-signed-out">
						<div class="status" role="status" aria-live="polite">
							<span class="dot" aria-hidden="true"></span>
							<span>It works</span>
						</div>
						<div class="meta">
							<span>Sign in to access your notes and dashboard.</span>
						</div>
					</div>

					<!-- Quick actions -->
					<div id="home-quick-actions" class="home-quick-actions" hidden>
						<button class="home-qa-btn primary" id="btn-home-new-note" type="button">✦ New note</button>
						<button class="home-qa-btn" id="btn-home-journal" type="button">📖 Today's journal</button>
						<button class="home-qa-btn" id="btn-home-go-notes" type="button">📝 Notes</button>
						<button class="home-qa-btn" id="btn-home-go-files" type="button">🗂 Files</button>
					</div>

					<!-- Writing activity -->
					<div id="home-activity" hidden>
						<p class="settings-section-title" style="margin-top:18px;margin-bottom:6px">7-Day Activity</p>
						<div class="home-activity-row">
							<div class="home-activity-dots" id="home-activity-dots"></div>
							<span class="home-activity-label" id="home-activity-label"></span>
							<span class="home-streak-badge" id="home-streak-badge" hidden></span>
						</div>
					</div>

					<!-- Stats dashboard -->
					<div id="home-stats" hidden>
						<p class="settings-section-title" style="margin-top:18px;margin-bottom:0">Dashboard</p>
						<div class="stats-grid" id="stats-grid"></div>
					</div>

					<!-- Pinned notes -->
					<div id="home-pinned-notes" hidden>
						<p class="settings-section-title" style="margin-top:18px;margin-bottom:0">📌 Pinned</p>
						<div class="home-note-cards" id="home-pinned-list"></div>
					</div>

					<!-- Recent notes -->
					<div id="home-recent-notes" hidden>
						<p class="settings-section-title" style="margin-top:18px;margin-bottom:0">Recent Notes</p>
						<div class="home-note-cards" id="home-recent-notes-list"></div>
					</div>

					<!-- Recent files -->
					<div id="home-recent-files" hidden>
						<p class="settings-section-title" style="margin-top:18px;margin-bottom:0">Recent Files</p>
						<div class="recent-files-list" id="recent-files-list"></div>
					</div>
				</section>

				<section class="panel" id="panel-notes" role="tabpanel" aria-labelledby="tab-notes" hidden>
					<div class="row" style="margin-bottom:0">
						<div class="auth">
							<span id="auth-status">Checking sign-in…</span>
							<span id="save-status" hidden>Saved</span>
						</div>
						<div style="display:flex;gap:8px;align-items:center">
							<div id="btn-new-doc-wrap" style="position:relative">
								<button class="btn btn-small btn-accent" id="btn-new-doc" type="button" title="New document">+ New ▾</button>
								<div class="template-picker" id="template-picker" hidden role="menu">
									<button class="template-option" data-template="blank" type="button" role="menuitem">📄 Blank note<span class="template-option-sub">Empty document</span></button>
									<button class="template-option" data-template="meeting" type="button" role="menuitem">💼 Meeting notes<span class="template-option-sub">Agenda · notes · actions</span></button>
									<button class="template-option" data-template="todo" type="button" role="menuitem">✅ To-do list<span class="template-option-sub">Checklist with sections</span></button>
									<button class="template-option" data-template="journal" type="button" role="menuitem">📖 Journal entry<span class="template-option-sub">Date · mood · reflection</span></button>
								</div>
							</div>
							<button class="btn btn-small" id="btn-dl-all" type="button" title="Download all as zip">⤓ All</button>
						</div>
					</div>

					<div class="notes-layout">
						<!-- Sidebar: document list -->
						<div class="notes-sidebar-wrap" style="display:flex;flex-direction:column;gap:4px">
							<input class="input notes-search" id="notes-search" type="search" placeholder="Search notes…" />
							<!-- Sort row -->
							<div class="notes-sort-row">
								<select class="notes-sort-select" id="notes-sort-select" aria-label="Sort notes">
									<option value="updated">Modified ↓</option>
									<option value="created">Created ↓</option>
									<option value="az">Title A–Z</option>
									<option value="za">Title Z–A</option>
									<option value="words">Word count ↓</option>
								</select>
								<span class="notes-count-badge" id="notes-count-badge">0</span>
							</div>
							<!-- Color filter row -->
							<div class="color-filter-row" id="color-filter-row" aria-label="Filter by color">
								<button class="color-filter-btn active" data-color="all" type="button" title="All notes" aria-label="All notes">✕</button>
								<button class="color-filter-btn" data-color="red"    type="button" title="Red"    aria-label="Red"></button>
								<button class="color-filter-btn" data-color="yellow" type="button" title="Yellow" aria-label="Yellow"></button>
								<button class="color-filter-btn" data-color="green"  type="button" title="Green"  aria-label="Green"></button>
								<button class="color-filter-btn" data-color="blue"   type="button" title="Blue"   aria-label="Blue"></button>
								<button class="color-filter-btn" data-color="purple" type="button" title="Purple" aria-label="Purple"></button>
							</div>
							<div class="notes-sidebar" id="doc-list" role="list" aria-label="Documents"></div>
						</div>

						<!-- Editor -->
						<div class="notes-editor-col" id="notes-editor-col">
							<div class="notes-editor-toolbar">
								<input class="input notes-title-input" id="doc-title" type="text" placeholder="Document title" />
								<button class="btn btn-small" id="btn-rename-doc" type="button">Rename</button>
								<button class="btn btn-small" id="btn-dl-doc" type="button" title="Download as .txt">⤓ .txt</button>
								<button class="btn btn-small" id="btn-dl-doc-md" type="button" title="Download as .md">⤓ .md</button>
								<button class="btn btn-small" id="btn-duplicate-doc" type="button" title="Duplicate note (⌘D)">⧉</button>
								<button class="btn btn-small" id="btn-export-all-md" type="button" title="Export all notes as one Markdown file">⤓ All .md</button>
								<button class="btn btn-small" id="btn-md-preview" type="button" title="Toggle Markdown preview" aria-pressed="false">👁 MD</button>
								<button class="btn btn-small" id="btn-paste-create" type="button" title="Paste clipboard as new note">📋</button>
								<button class="btn btn-small" id="btn-focus-mode" type="button" title="Focus mode (⌘.)">⛶</button>
								<span class="fmt-divider" aria-hidden="true"></span>
								<button class="btn btn-small fmt-btn" id="btn-fmt-bold" type="button" title="Bold (⌘B)"><b>B</b></button>
								<button class="btn btn-small fmt-btn" id="btn-fmt-italic" type="button" title="Italic (⌘I)"><i>I</i></button>
								<button class="btn btn-small fmt-btn" id="btn-fmt-code" type="button" title="Inline code"><code>`</code></button>
								<button class="btn btn-small fmt-btn" id="btn-fmt-strike" type="button" title="Strikethrough"><s>S</s></button>
								<span class="fmt-divider" aria-hidden="true"></span>
								<div class="history-wrap" style="position:relative">
									<button class="btn btn-small" id="btn-history" type="button" title="Restore a previous snapshot">🕐</button>
									<div class="history-pop" id="history-pop" hidden role="menu" aria-label="Note history"></div>
								</div>
								<button class="btn btn-small" id="btn-delete-doc" type="button" title="Delete document">🗑</button>
							</div>
							<textarea id="notes" name="notes" placeholder="Sign in to write notes" disabled></textarea>
							<!-- Markdown preview pane -->
							<div class="md-preview-pane" id="md-preview-pane" hidden aria-label="Markdown preview"></div>
							<span class="notes-char-warning" id="notes-char-warning"></span>
							<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
								<p class="hint" id="notes-hint" style="margin:0">Your notes sync to the cloud. <kbd style="font-size:0.78rem;opacity:0.6">⌘S</kbd> save &nbsp;<kbd style="font-size:0.78rem;opacity:0.6">⌘T</kbd> new</p>
								<span class="notes-word-count" id="notes-word-count"></span>
							</div>
							<!-- Word goal -->
							<div class="word-goal-row" id="word-goal-row" hidden>
								<span class="word-goal-label" id="word-goal-label">0 / 500 words</span>
								<div class="word-goal-track"><div class="word-goal-fill" id="word-goal-fill"></div></div>
								<button class="btn btn-small word-goal-set-btn" id="btn-word-goal" type="button" title="Set or clear word goal">🎯</button>
							</div>
							<!-- Keyboard hint pills -->
							<div class="kb-hints" aria-hidden="true">
								<span class="kb-pill"><kbd>⌘⇧H/N</kbd> switch tabs</span>
								<span class="kb-pill"><kbd>/</kbd> search</span>
								<span class="kb-pill"><kbd>⌘S</kbd> save</span>
								<span class="kb-pill"><kbd>⌘T</kbd> new</span>
								<span class="kb-pill"><kbd>⌘.</kbd> focus</span>
								<span class="kb-pill"><kbd>?</kbd> shortcuts</span>
							</div>
						</div>
					</div>
				</section>

				<!-- Focus mode exit hint -->
				<div class="focus-exit-banner" aria-hidden="true">Press <strong>⌘.</strong> or click ⛶ to exit focus mode</div>

				<section class="panel" id="panel-settings" role="tabpanel" aria-labelledby="tab-settings" hidden>

					<!-- Account -->
					<div class="settings-section">
						<p class="settings-section-title">Account</p>
						<p class="hint" id="acct-current" style="margin:0 0 8px">Signed in</p>
						<div id="acct-badges" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px"></div>
						<div class="fields">
							<div class="field">
								<label for="acct-username">New username</label>
								<input class="input" id="acct-username" name="acct-username" type="text" autocomplete="username" />
							</div>
							<div class="actions">
								<button class="btn" id="btn-update-username" type="button">Update username</button>
							</div>
							<div class="field">
								<label for="acct-password">New password</label>
								<div class="pwrow">
									<input class="input" id="acct-password" name="acct-password" type="password" autocomplete="new-password" />
									<button class="btn btn-small" id="btn-toggle-acct-password" type="button" aria-pressed="false">Show</button>
								</div>
							</div>
							<div class="actions">
								<button class="btn" id="btn-update-password" type="button">Update password</button>
								<button class="btn" id="btn-delete-account" type="button">Delete account</button>
							</div>
						</div>
						<p class="hint" id="acct-status"></p>
						<!-- Session info -->
						<div id="session-info-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px" hidden>
							<span class="session-badge" id="session-expiry-badge">🔒 Session expires …</span>
							<button class="btn btn-small" id="btn-refresh-session" type="button">↻ Refresh session</button>
						</div>

					<!-- Customization -->
					<div class="settings-section">
						<p class="settings-section-title">Customization</p>

						<!-- Accent colour -->
						<div class="field" style="margin-bottom:18px">
							<label style="margin-bottom:10px">Accent colour</label>
							<div class="swatch-row" id="swatch-row" role="radiogroup" aria-label="Accent colour"></div>
						</div>

						<!-- Font size -->
						<div class="field" style="margin-bottom:18px">
							<label style="margin-bottom:10px">Font size</label>
							<div class="chip-row" id="chips-fontsize" role="radiogroup" aria-label="Font size">
								<button class="chip" data-val="small"  type="button">Small</button>
								<button class="chip" data-val="medium" type="button">Medium</button>
								<button class="chip" data-val="large"  type="button">Large</button>
							</div>
						</div>

						<!-- Card width -->
						<div class="field" style="margin-bottom:18px">
							<label style="margin-bottom:10px">Card width</label>
							<div class="chip-row" id="chips-cardwidth" role="radiogroup" aria-label="Card width">
								<button class="chip" data-val="compact" type="button">Compact</button>
								<button class="chip" data-val="regular" type="button">Regular</button>
								<button class="chip" data-val="wide"    type="button">Wide</button>
							</div>
						</div>

						<!-- Background style -->
						<div class="field">
							<label style="margin-bottom:10px">Background</label>
							<div class="chip-row" id="chips-bgstyle" role="radiogroup" aria-label="Background style">
								<button class="chip" data-val="aurora"  type="button">Aurora</button>
								<button class="chip" data-val="subtle"  type="button">Subtle</button>
								<button class="chip" data-val="minimal" type="button">Minimal</button>
							</div>
						</div>

						<!-- Note density -->
						<div class="field" style="margin-top:18px">
							<label style="margin-bottom:10px">Note density</label>
							<div class="chip-row" id="chips-density" role="radiogroup" aria-label="Note density">
								<button class="chip" data-val="compact"     type="button">Compact</button>
								<button class="chip" data-val="normal"      type="button">Normal</button>
								<button class="chip" data-val="comfortable" type="button">Comfortable</button>
							</div>
						</div>

						<div class="prefs-save-row">
							<button class="btn btn-accent" id="btn-save-prefs" type="button">Save preferences</button>
							<span id="prefs-status"></span>
						</div>

						<!-- Custom app title -->
						<div class="settings-section">
							<p class="settings-section-title">App title &amp; subtitle</p>
							<div class="app-title-edit">
								<input class="input" id="pref-app-title" type="text" placeholder="ectl.me" maxlength="40" style="flex:1;min-width:100px" />
								<input class="input" id="pref-app-subtitle" type="text" placeholder="A small static site…" maxlength="80" style="flex:2;min-width:140px" />
								<button class="btn btn-small" id="btn-apply-title" type="button">Apply</button>
							</div>
							<p class="hint" style="margin-top:6px;font-size:0.78rem">Shown in the app header. Saved with your preferences.</p>
						</div>

						<!-- Auto-lock -->
						<div class="settings-section">
							<p class="settings-section-title">Auto-lock (sign out after idle)</p>
							<div class="chip-row" id="chips-autolock" role="radiogroup" aria-label="Auto-lock timeout">
								<button class="chip" data-val="off" type="button">Off</button>
								<button class="chip" data-val="5"   type="button">5 min</button>
								<button class="chip" data-val="15"  type="button">15 min</button>
								<button class="chip" data-val="30"  type="button">30 min</button>
							</div>
							<p class="hint" style="margin-top:6px;font-size:0.78rem">Signs you out automatically if the tab is idle.</p>
						</div>
					</div>

				</section>

					<section class="panel" id="panel-files" role="tabpanel" aria-labelledby="tab-files" hidden>
						<p class="subtitle" style="margin-top: 4px; margin-bottom: 2px">Files</p>
						<div class="upload-zone" id="files-upload-zone" role="button" tabindex="0" aria-label="Upload files">
							<input type="file" id="files-input" multiple />
							<span class="upload-zone-label">Click or drag files here to upload</span>
							<span class="upload-zone-sub">Files are private to your account</span>
						</div>
						<div class="upload-progress" id="files-upload-progress">
							<div class="upload-progress-bar" id="files-upload-bar"></div>
						</div>
						<!-- Storage usage bar -->
						<div class="storage-bar-wrap" id="storage-bar-wrap" hidden>
							<div class="storage-bar-label">
								<span id="storage-bar-used">0 B used</span>
								<span id="storage-bar-limit">1 GB</span>
							</div>
							<div class="storage-bar-track">
								<div class="storage-bar-fill" id="storage-bar-fill"></div>
							</div>
						</div>
						<!-- File search -->
						<div class="file-search-row" id="file-search-row" hidden>
							<input class="input file-search-input" id="file-search-input" type="search" placeholder="Filter files…" aria-label="Filter files" />
						</div>
						<!-- Files sort + bulk delete -->
						<div class="files-controls-row" id="files-controls-row" hidden>
							<select class="files-sort-select" id="files-sort-select" aria-label="Sort files">
								<option value="date-desc">Newest first</option>
								<option value="date-asc">Oldest first</option>
								<option value="name-asc">Name A–Z</option>
								<option value="name-desc">Name Z–A</option>
								<option value="size-desc">Largest first</option>
								<option value="size-asc">Smallest first</option>
							</select>
							<button class="btn btn-small files-bulk-btn" id="btn-bulk-delete" type="button" title="Delete selected files">🗑 Delete selected</button>
						</div>
						<p class="files-status" id="files-status" aria-live="polite"></p>
						<div class="file-list" id="file-list"></div>
					</section>

				<!-- ── Tools panel ── -->
				<section class="panel" id="panel-tools" role="tabpanel" aria-labelledby="tab-tools" hidden>

					<!-- Password Generator -->
					<div class="tool-card">
						<div class="tool-card-header">🔐 Password Generator</div>
						<div class="tool-card-body">
							<div class="tool-row">
								<input class="input tool-output" id="tool-pw-output" type="text" readonly placeholder="Click Generate…" aria-label="Generated password" />
								<button class="btn btn-small" id="tool-pw-copy" type="button">Copy</button>
							</div>
							<div class="tool-row" style="gap:14px;flex-wrap:wrap;align-items:center">
								<label class="tool-label">Length: <span id="tool-pw-len-val">16</span></label>
								<input type="range" id="tool-pw-len" min="8" max="64" value="16" class="tool-range" aria-label="Password length" />
							</div>
							<div class="tool-row tool-check-row">
								<label class="tool-check"><input type="checkbox" id="tool-pw-upper" checked /> A–Z</label>
								<label class="tool-check"><input type="checkbox" id="tool-pw-lower" checked /> a–z</label>
								<label class="tool-check"><input type="checkbox" id="tool-pw-num"   checked /> 0–9</label>
								<label class="tool-check"><input type="checkbox" id="tool-pw-sym"   checked /> !@#…</label>
							</div>
							<div class="tool-row">
								<button class="btn btn-accent" id="tool-pw-gen" type="button">Generate</button>
								<span class="tool-pw-strength" id="tool-pw-strength"></span>
							</div>
						</div>
					</div>

					<!-- Text Analyser -->
					<div class="tool-card">
						<div class="tool-card-header">📊 Text Analyser</div>
						<div class="tool-card-body">
							<textarea class="input tool-textarea" id="tool-wc-input" placeholder="Paste or type text here…" rows="5" aria-label="Text to analyse"></textarea>
							<div class="tool-stats-row" id="tool-wc-stats">
								<span class="tool-stat-pill" id="tool-wc-words">0 words</span>
								<span class="tool-stat-pill" id="tool-wc-chars">0 chars</span>
								<span class="tool-stat-pill" id="tool-wc-chars-nsp">0 no-space</span>
								<span class="tool-stat-pill" id="tool-wc-sents">0 sentences</span>
								<span class="tool-stat-pill" id="tool-wc-paras">0 paragraphs</span>
								<span class="tool-stat-pill" id="tool-wc-read">~0 min read</span>
							</div>
							<div class="tool-row" style="margin-top:2px">
								<button class="btn btn-small" id="tool-wc-clear" type="button">Clear</button>
								<button class="btn btn-small" id="tool-wc-copy-stats" type="button">Copy stats</button>
							</div>
						</div>
					</div>

					<!-- Pomodoro Timer -->
					<div class="tool-card">
						<div class="tool-card-header">🍅 Pomodoro Timer</div>
						<div class="tool-card-body tool-pomo-body">
							<div class="tool-pomo-ring-wrap" aria-live="polite" aria-label="Timer">
								<svg class="tool-pomo-ring" viewBox="0 0 80 80" aria-hidden="true">
									<circle class="pomo-track" cx="40" cy="40" r="34"/>
									<circle class="pomo-fill" id="pomo-ring-fill" cx="40" cy="40" r="34"/>
								</svg>
								<div class="tool-pomo-inner">
									<div class="tool-pomo-time" id="pomo-time">25:00</div>
									<div class="tool-pomo-phase" id="pomo-phase">Work</div>
								</div>
							</div>
							<div class="tool-row tool-pomo-controls">
								<button class="btn btn-accent" id="btn-pomo-start" type="button">▶ Start</button>
								<button class="btn btn-small" id="btn-pomo-reset" type="button">↺ Reset</button>
							</div>
							<div class="tool-row tool-check-row" style="justify-content:center">
								<label class="tool-check">Work <input type="number" id="pomo-work-min" value="25" min="1" max="90" class="tool-num-input" aria-label="Work minutes" /> min</label>
								<label class="tool-check">Break <input type="number" id="pomo-break-min" value="5" min="1" max="30" class="tool-num-input" aria-label="Break minutes" /> min</label>
							</div>
							<div class="tool-pomo-log" id="pomo-log"></div>
						</div>
					</div>

					<!-- Base64 -->
					<div class="tool-card">
						<div class="tool-card-header">🔄 Base64 Encoder / Decoder</div>
						<div class="tool-card-body">
							<textarea class="input tool-textarea" id="tool-b64-input" placeholder="Text or Base64 to convert…" rows="3" aria-label="Base64 input" spellcheck="false"></textarea>
							<div class="tool-row">
								<button class="btn btn-small btn-accent" id="tool-b64-enc" type="button">Encode →</button>
								<button class="btn btn-small" id="tool-b64-dec" type="button">← Decode</button>
								<button class="btn btn-small" id="tool-b64-copy" type="button">Copy</button>
							</div>
							<textarea class="input tool-textarea" id="tool-b64-output" rows="3" readonly placeholder="Output…" aria-label="Base64 output" spellcheck="false"></textarea>
						</div>
					</div>

					<!-- UUID Generator -->
					<div class="tool-card">
						<div class="tool-card-header">🆔 UUID Generator</div>
						<div class="tool-card-body">
							<div class="tool-uuid-list" id="tool-uuid-list"></div>
							<div class="tool-row" style="margin-top:4px">
								<button class="btn btn-accent" id="tool-uuid-gen" type="button">Generate</button>
								<label class="tool-label" style="margin-left:2px">×
									<select class="tool-select" id="tool-uuid-count" aria-label="How many UUIDs">
										<option value="1">1</option>
										<option value="5" selected>5</option>
										<option value="10">10</option>
									</select>
								</label>
								<button class="btn btn-small" id="tool-uuid-copy-all" type="button">Copy all</button>
							</div>
						</div>
					</div>

					<!-- JSON Formatter -->
					<div class="tool-card">
						<div class="tool-card-header">🗂 JSON Formatter</div>
						<div class="tool-card-body">
							<textarea class="input tool-textarea" id="tool-json-input" placeholder="Paste JSON here…" rows="5" aria-label="JSON input" spellcheck="false"></textarea>
							<div class="tool-row">
								<button class="btn btn-small btn-accent" id="tool-json-fmt" type="button">Format</button>
								<button class="btn btn-small" id="tool-json-min" type="button">Minify</button>
								<button class="btn btn-small" id="tool-json-copy" type="button">Copy</button>
								<span class="tool-json-status" id="tool-json-status"></span>
							</div>
							<textarea class="input tool-textarea" id="tool-json-output" rows="5" readonly placeholder="Output…" aria-label="JSON output" spellcheck="false"></textarea>
						</div>
					</div>

					<!-- Unix Timestamp -->
					<div class="tool-card">
						<div class="tool-card-header">⏱ Unix Timestamp</div>
						<div class="tool-card-body">
							<div class="tool-row">
								<input class="input" id="tool-ts-input" type="text" placeholder="Unix timestamp or date string…" aria-label="Timestamp input" style="flex:1" />
								<button class="btn btn-small btn-accent" id="tool-ts-now" type="button">Now</button>
							</div>
							<div class="tool-ts-results" id="tool-ts-results"></div>
						</div>
					</div>

				</section>

				<!-- ── Work panel ── -->
				<section class="panel" id="panel-work" role="tabpanel" aria-labelledby="tab-work" hidden>

					<!-- Ticket / Job Log -->
					<div class="tool-card">
						<div class="tool-card-header">🎫 Ticket / Job Log</div>
						<div class="tool-card-body">
							<div class="tool-row" style="flex-wrap:wrap;gap:8px">
								<input class="input" id="work-ticket-id" type="text" placeholder="Ticket # or device name" style="flex:1;min-width:120px" aria-label="Ticket ID" />
								<select class="tool-select" id="work-ticket-status" aria-label="Status">
									<option value="open">🔴 Open</option>
									<option value="inprog">🟡 In Progress</option>
									<option value="waiting">🔵 Waiting on parts</option>
									<option value="done">🟢 Done</option>
								</select>
								<select class="tool-select" id="work-ticket-type" aria-label="Job type">
									<option value="diag">Diagnostics</option>
									<option value="os">OS / Software</option>
									<option value="hw">Hardware repair</option>
									<option value="net">Network / Wi-Fi</option>
									<option value="data">Data recovery</option>
									<option value="virus">Virus / Malware</option>
									<option value="setup">New device setup</option>
									<option value="other">Other</option>
								</select>
							</div>
							<textarea class="input tool-textarea" id="work-ticket-notes" placeholder="Notes about the job, findings, parts needed…" rows="3" aria-label="Ticket notes"></textarea>
							<div class="tool-row">
								<button class="btn btn-accent" id="btn-work-ticket-add" type="button">+ Add entry</button>
								<button class="btn btn-small" id="btn-work-ticket-export" type="button">Export CSV</button>
								<span class="work-ticket-count" id="work-ticket-count"></span>
							</div>
							<div class="work-ticket-list" id="work-ticket-list"></div>
						</div>
					</div>

					<!-- Network Toolkit -->
					<div class="tool-card">
						<div class="tool-card-header">🌐 Network Toolkit</div>
						<div class="tool-card-body">
							<!-- Subnet Calculator -->
							<div class="work-subsection-label">Subnet Calculator</div>
							<div class="tool-row" style="flex-wrap:wrap">
								<input class="input" id="work-subnet-ip" type="text" placeholder="IP address (e.g. 192.168.1.1)" style="flex:2;min-width:140px" aria-label="IP address" />
								<input class="input" id="work-subnet-cidr" type="text" placeholder="CIDR (e.g. 24)" style="flex:1;min-width:60px;max-width:90px" aria-label="CIDR prefix" />
								<button class="btn btn-small btn-accent" id="btn-work-subnet-calc" type="button">Calculate</button>
							</div>
							<div class="work-subnet-results" id="work-subnet-results"></div>
							<!-- Common ports quick-ref -->
							<div class="work-subsection-label" style="margin-top:12px">Common Ports</div>
							<div class="work-ports-grid" id="work-ports-grid"></div>
							<!-- IP class lookup -->
							<div class="work-subsection-label" style="margin-top:12px">Private IP Ranges</div>
							<div class="work-ip-ranges" id="work-ip-ranges"></div>
						</div>
					</div>

					<!-- System Checklist -->
					<div class="tool-card">
						<div class="tool-card-header">✅ Repair Checklist</div>
						<div class="tool-card-body">
							<div class="tool-row" style="flex-wrap:wrap;gap:6px">
								<select class="tool-select" id="work-checklist-type" aria-label="Checklist template">
									<option value="general">General PC repair</option>
									<option value="virus">Virus / Malware removal</option>
									<option value="os">Windows reinstall</option>
									<option value="laptop">Laptop hardware repair</option>
									<option value="network">Network troubleshoot</option>
									<option value="data">Data recovery</option>
								</select>
								<button class="btn btn-small btn-accent" id="btn-work-checklist-load" type="button">Load</button>
								<button class="btn btn-small" id="btn-work-checklist-reset" type="button">Reset</button>
								<button class="btn btn-small" id="btn-work-checklist-copy" type="button">Copy</button>
							</div>
							<div class="work-checklist" id="work-checklist"></div>
						</div>
					</div>

					<!-- Storage & RAM Quick Calc -->
					<div class="tool-card">
						<div class="tool-card-header">💾 Storage / RAM Converter</div>
						<div class="tool-card-body">
							<div class="tool-row" style="flex-wrap:wrap">
								<input class="input" id="work-storage-val" type="number" placeholder="Value" min="0" style="flex:1;min-width:80px" aria-label="Storage value" />
								<select class="tool-select" id="work-storage-from" aria-label="From unit">
									<option value="B">Bytes</option>
									<option value="KB">KB</option>
									<option value="MB" selected>MB</option>
									<option value="GB">GB</option>
									<option value="TB">TB</option>
									<option value="KiB">KiB</option>
									<option value="MiB">MiB</option>
									<option value="GiB">GiB</option>
									<option value="TiB">TiB</option>
								</select>
								<span class="tool-label">→</span>
							</div>
							<div class="work-storage-results" id="work-storage-results"></div>
						</div>
					</div>

					<!-- Windows CMD Quick Reference -->
					<div class="tool-card">
						<div class="tool-card-header">💻 Windows / CMD Quick Reference</div>
						<div class="tool-card-body">
							<input class="input" id="work-cmd-search" type="search" placeholder="Search commands…" aria-label="Search commands" />
							<div class="work-cmd-grid" id="work-cmd-grid"></div>
						</div>
					</div>

					<!-- Chromebook Quick Reference -->
					<div class="tool-card">
						<div class="tool-card-header">🐧 Chromebook / ChromeOS Quick Reference</div>
						<div class="tool-card-body">
							<input class="input" id="work-crosh-search" type="search" placeholder="Search commands…" aria-label="Search Chromebook commands" />
							<div class="work-cmd-grid" id="work-crosh-grid"></div>
						</div>
					</div>

					<!-- Client-ready Report Generator moved to panel-reports -->

				</section>

				<!-- Reports panel -->
				<section class="panel" id="panel-reports" role="tabpanel" aria-labelledby="tab-reports" hidden>

					<!-- Saved clients bar — always visible above the form -->
					<div class="rpt-topbar" id="rpt-topbar">
						<label class="rpt-topbar-label" for="rpt-client-select">📋 Saved Clients</label>
						<select class="input rpt-client-select" id="rpt-client-select" aria-label="Load saved client">
							<option value="">— Select a saved client —</option>
						</select>
						<button class="btn btn-small" id="btn-rpt-del-saved" type="button" title="Remove selected saved client" style="flex-shrink:0">✕ Remove</button>
						<label class="rpt-topbar-label" for="rpt-tech-select" style="margin-left:8px">🔧 Saved Technicians</label>
						<select class="input rpt-client-select" id="rpt-tech-select" aria-label="Load saved technician">
							<option value="">— Select a saved technician —</option>
						</select>
						<button class="btn btn-small" id="btn-rpt-del-saved-tech" type="button" title="Remove selected saved technician" style="flex-shrink:0">✕ Remove</button>
					</div>

					<div class="tools-grid">

					<!-- Client Report Generator -->
					<div class="tool-card" style="grid-column:1/-1">
						<div class="tool-card-header">📄 Service Report Generator</div>
						<div class="tool-card-body">

							<div class="work-report-section-label">Reference</div>
							<div class="tool-row" style="flex-wrap:wrap;gap:8px">
								<input class="input" id="rpt-ref-input" type="text" placeholder="Auto-generated reference (editable)" style="flex:1;min-width:180px;font-family:ui-monospace,monospace;font-size:0.82rem" aria-label="Report reference" />
								<button class="btn btn-small" id="btn-rpt-ref-regen" type="button" title="Regenerate reference">↻ New Ref</button>
							</div>

						<div class="work-report-section-label">Client</div>
						<div class="tool-row" style="flex-wrap:wrap;gap:8px">
							<input class="input" id="rpt-client" type="text" placeholder="Client / Company name" style="flex:1;min-width:160px" aria-label="Client name" />
						</div>
						<div class="tool-row" style="flex-wrap:wrap;gap:8px">
							<input class="input" id="rpt-email" type="email" placeholder="Email" style="flex:1;min-width:140px" aria-label="Client email" />
							<input class="input" id="rpt-phone" type="tel" placeholder="Phone" style="flex:1;min-width:120px" aria-label="Client phone" />
						</div>
						<div class="tool-row" style="flex-wrap:wrap;gap:8px">
							<input class="input" id="rpt-street" type="text" placeholder="Street address" style="flex:2;min-width:160px" aria-label="Street" />
							<input class="input" id="rpt-postal" type="text" placeholder="Postal code" style="flex:0 0 90px" aria-label="Postal code" />
							<input class="input" id="rpt-city" type="text" placeholder="City" style="flex:1;min-width:100px" aria-label="City" />
						</div>

						<div class="work-report-section-label">Technician</div>
						<div class="tool-row" style="flex-wrap:wrap;gap:8px">
							<input class="input" id="rpt-tech" type="text" placeholder="Technician name" style="flex:1;min-width:160px" aria-label="Technician" />
						</div>
						<div class="tool-row" style="flex-wrap:wrap;gap:8px">
							<input class="input" id="rpt-tech-email" type="email" placeholder="Technician email" style="flex:1;min-width:140px" aria-label="Technician email" />
							<input class="input" id="rpt-tech-phone" type="tel" placeholder="Technician phone" style="flex:1;min-width:120px" aria-label="Technician phone" />
						</div>
						<div class="tool-row" style="flex-wrap:wrap;gap:8px">
							<input class="input" id="rpt-tech-street" type="text" placeholder="Return address (street)" style="flex:2;min-width:160px" aria-label="Technician street" />
							<input class="input" id="rpt-tech-postal" type="text" placeholder="Postal" style="flex:0 0 90px" aria-label="Technician postal code" />
							<input class="input" id="rpt-tech-city" type="text" placeholder="City" style="flex:1;min-width:100px" aria-label="Technician city" />
						</div>

						<div class="work-report-section-label">Device</div>
						<div class="tool-row" style="flex-wrap:wrap;gap:8px">
							<input class="input" id="rpt-device" type="text" placeholder="Device (e.g. Dell Inspiron 15)" style="flex:2;min-width:160px" aria-label="Device" />
							<input class="input" id="rpt-serial" type="text" placeholder="Serial number" style="flex:1;min-width:120px" aria-label="Serial number" />
						</div>
						<div class="tool-row" style="flex-wrap:wrap;gap:8px">
							<label style="display:flex;align-items:center;gap:6px;font-size:0.8rem;color:var(--muted);flex:1;min-width:160px">
								<span style="white-space:nowrap">Date received</span>
								<input class="input" id="rpt-date-received" type="date" style="flex:1" aria-label="Date received" />
							</label>
						</div>							<!-- Jira import -->
							<div class="work-report-section-label" style="display:flex;align-items:center;justify-content:space-between">
								<span>Import from Jira</span>
								<button class="btn btn-small" id="btn-rpt-jira-toggle" type="button">📋 Paste Jira text</button>
							</div>
							<div id="rpt-jira-panel" style="display:none;margin-bottom:10px">
								<textarea class="input tool-textarea" id="rpt-jira-paste" rows="6" placeholder="Copy the Jira issue page text (Ctrl+A, Ctrl+C on the issue page) and paste it here…" style="font-size:0.78rem;color:var(--muted)"></textarea>
								<div style="display:flex;gap:8px;margin-top:6px">
									<button class="btn" id="btn-rpt-jira-import" type="button" style="flex:1">⬇ Import fields</button>
									<button class="btn btn-small" id="btn-rpt-jira-cancel" type="button">✕</button>
								</div>
								<div id="rpt-jira-feedback" style="font-size:0.75rem;color:var(--muted);margin-top:4px;min-height:1.2em"></div>
							</div>

							<div class="work-report-section-label">Job Details</div>
							<input class="input" id="rpt-issue" type="text" placeholder="Reported issue / reason for visit" aria-label="Reported issue" />

							<div class="rpt-field-group">
								<div class="rpt-field-header">
									<span class="rpt-field-label">Troubleshooting</span>
									<input class="input rpt-date-input" id="rpt-troubleshoot-date" type="date" aria-label="Troubleshooting date" />
								</div>
								<textarea class="input tool-textarea" id="rpt-findings" placeholder="Steps taken to diagnose the issue — one item per line…" rows="4" aria-label="Troubleshooting notes"></textarea>
							</div>

							<div class="rpt-field-group">
								<div class="rpt-field-header">
									<span class="rpt-field-label">Solution</span>
									<input class="input rpt-date-input" id="rpt-solution-date" type="date" aria-label="Solution date" />
								</div>
								<textarea class="input tool-textarea" id="rpt-recommendations" placeholder="Work carried out / fix applied — one item per line…" rows="3" aria-label="Solution notes"></textarea>
							</div>

							<div class="work-report-section-label">Status &amp; Type</div>
							<div class="tool-row" style="flex-wrap:wrap;gap:8px">
								<select class="input" id="rpt-status" style="flex:1;min-width:120px" aria-label="Job status">
									<option value="Completed">✅ Completed</option>
									<option value="Returned to client">📦 Returned to client</option>
									<option value="Awaiting parts">⏳ Awaiting parts</option>
									<option value="In progress">🔧 In progress</option>
									<option value="No fault found">🔍 No fault found</option>
									<option value="Client declined repair">❌ Client declined repair</option>
								</select>
								<select class="input" id="rpt-repairtype" style="flex:1;min-width:130px" aria-label="Repair type">
									<option value="Non-Warranty">Non-Warranty</option>
									<option value="Warranty">Warranty</option>
									<option value="ADP (Accidental Damage)">ADP (Accidental Damage)</option>
									<option value="Out of Warranty">Out of Warranty</option>
									<option value="Insurance Claim">Insurance Claim</option>
									<option value="Internal / Asset">Internal / Asset</option>
								</select>
							</div>

							<div class="tool-row" style="margin-top:4px">
								<button class="btn btn-accent" id="btn-rpt-gen" type="button">Generate Report</button>
								<button class="btn btn-small" id="btn-rpt-print" type="button" style="display:none">🖨 Print / Preview</button>
								<button class="btn btn-small" id="btn-rpt-copy" type="button" style="display:none">Copy Text</button>
								<button class="btn btn-small" id="btn-rpt-clear" type="button" style="display:none">New Report</button>
							</div>
							<textarea class="input tool-textarea" id="rpt-output" rows="14" readonly placeholder="Generated report appears here…" aria-label="Report output" style="font-family:ui-monospace,monospace;font-size:0.78rem;display:none;line-height:1.6"></textarea>
						</div>
					</div>

					</div>
				</section>

				<!-- Print preview modal -->
				<div class="rpt-print-overlay" id="rpt-print-overlay" hidden role="dialog" aria-modal="true" aria-label="Print preview">
					<div class="rpt-print-modal">
						<div class="rpt-print-toolbar">
							<span class="rpt-print-toolbar-title">Print Preview — A4</span>
							<div style="display:flex;gap:8px">
								<button class="btn btn-accent" id="btn-rpt-do-print" type="button">🖨 Print</button>
								<button class="btn btn-small" id="btn-rpt-print-close" type="button">✕ Close</button>
							</div>
						</div>
						<div class="rpt-print-scroll">
							<div class="rpt-a4" id="rpt-a4"></div>
						</div>
					</div>
				</div>

				<!-- Account Manager panel -->
				<section class="panel" id="panel-admin" role="tabpanel" aria-labelledby="tab-admin" hidden>
					<div class="tools-grid">
						<div class="tool-card" style="grid-column:1/-1">
							<div class="tool-card-header">👤 Account Manager</div>
							<div class="tool-card-body">
								<div class="work-report-section-label">Create New Account</div>
								<div class="tool-row" style="flex-wrap:wrap;gap:8px">
									<input class="input" id="admin-new-username" type="text" placeholder="Username" style="flex:1;min-width:120px" autocomplete="off" />
									<input class="input" id="admin-new-email" type="email" placeholder="Email" style="flex:1;min-width:160px" autocomplete="off" />
									<input class="input" id="admin-new-password" type="password" placeholder="Password" style="flex:1;min-width:140px" autocomplete="new-password" />
								</div>
								<div class="tool-row" style="margin-top:6px;align-items:center;gap:12px">
									<label style="display:flex;align-items:center;gap:6px;font-size:0.82rem;cursor:pointer">
										<input type="checkbox" id="admin-new-is-admin" /> Make admin
									</label>
									<button class="btn btn-accent" id="btn-admin-create" type="button">Create Account</button>
								</div>
								<div id="admin-create-status" style="font-size:0.8rem;color:var(--muted);margin-top:6px;min-height:1.2em"></div>

								<div class="work-report-section-label" style="margin-top:20px">Registered Accounts</div>
								<div id="admin-user-list" style="margin-top:6px"></div>
							</div>
						</div>
					</div>
				</section>

				<!-- File preview lightbox -->
				<div class="lightbox-overlay" id="lightbox-overlay" hidden role="dialog" aria-modal="true" aria-label="File preview">
					<div class="lightbox-inner" id="lightbox-inner">
						<button class="lightbox-close" id="lightbox-close" type="button" aria-label="Close preview">✕</button>
					</div>
					<p class="lightbox-fname" id="lightbox-fname"></p>
				</div>

				<!-- Quick-insert macro popup -->
				<div class="macro-hint" id="macro-hint" role="listbox" aria-label="Quick insert"></div>

				<!-- Keyboard shortcuts modal -->
				<div class="kb-modal-overlay" id="kb-modal-overlay" hidden role="dialog" aria-modal="true" aria-label="Keyboard shortcuts">
					<div class="kb-modal" id="kb-modal">
						<h2>⌨ Keyboard Shortcuts</h2>
						<div class="kb-modal-section">
							<h3>Navigation</h3>
							<div class="kb-modal-row"><span>Switch to Home</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>⇧</kbd><kbd>H</kbd></span></div>
							<div class="kb-modal-row"><span>Switch to Notes</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>⇧</kbd><kbd>N</kbd></span></div>
							<div class="kb-modal-row"><span>Switch to Settings</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>⇧</kbd><kbd>,</kbd></span></div>
							<div class="kb-modal-row"><span>Switch to Files</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>⇧</kbd><kbd>F</kbd></span></div>
							<div class="kb-modal-row"><span>Switch to Tools</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>⇧</kbd><kbd>X</kbd></span></div>
							<div class="kb-modal-row"><span>Switch to Work</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>⇧</kbd><kbd>W</kbd></span></div>
							<div class="kb-modal-row"><span>Switch to Reports</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>⇧</kbd><kbd>R</kbd></span></div>
						</div>
						<div class="kb-modal-section">
							<h3>Notes</h3>
							<div class="kb-modal-row"><span>Save current note</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>S</kbd></span></div>
							<div class="kb-modal-row"><span>New note (template picker)</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>T</kbd></span></div>
							<div class="kb-modal-row"><span>Duplicate current note</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>D</kbd></span></div>
							<div class="kb-modal-row"><span>Pin / unpin current note</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>P</kbd></span></div>
							<div class="kb-modal-row"><span>Bold selected text</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>B</kbd></span></div>
							<div class="kb-modal-row"><span>Italic selected text</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>I</kbd></span></div>
							<div class="kb-modal-row"><span>Toggle Markdown preview</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>⇧</kbd><kbd>P</kbd></span></div>
							<div class="kb-modal-row"><span>Quick-insert macro</span><span class="kb-modal-keys"><kbd>:</kbd> then <kbd>date</kbd> / <kbd>time</kbd> / <kbd>hr</kbd> / <kbd>todo</kbd></span></div>
							<div class="kb-modal-row"><span>Focus search bar</span><span class="kb-modal-keys"><kbd>/</kbd></span></div>
							<div class="kb-modal-row"><span>Clear search</span><span class="kb-modal-keys"><kbd>Esc</kbd></span></div>
							<div class="kb-modal-row"><span>Focus / writing mode</span><span class="kb-modal-keys"><kbd>⌘</kbd><kbd>.</kbd></span></div>
						</div>
						<div class="kb-modal-section">
							<h3>General</h3>
							<div class="kb-modal-row"><span>Show this cheatsheet</span><span class="kb-modal-keys"><kbd>?</kbd></span></div>
							<div class="kb-modal-row"><span>Close modal / overlay</span><span class="kb-modal-keys"><kbd>Esc</kbd></span></div>
						</div>
						<div class="kb-modal-close-row"><button class="btn btn-small" id="btn-kb-modal-close" type="button">Close</button></div>
					</div>
				</div>
		</main>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<div id="toast-container" aria-live="polite" aria-atomic="false"></div>
		<script>
			const SUPABASE_URL = 'https://oxgaltttggmxukslgjxn.supabase.co';
			const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94Z2FsdHR0Z2dteHVrc2xnanhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTA0NDYsImV4cCI6MjA4Nzc2NjQ0Nn0.Q8X_MQs_nFuhtGpY4K-KzvsaXT419Sc2Vx6slXi6Rdw';
			const USERNAME_MIN_LEN = 3;
			const USERNAME_MAX_LEN = 24;
			const AUTH_TIMEOUT_MS = 15000;
			const BUILD_STAMP = '2026-02-27';

			// ── Admin config ──────────────────────────────────────────
			const ADMIN_SEED_EMAIL = 'elias@ectl.me';
			const ADMIN_EMAILS_KEY = 'ectl_admin_emails';
			function getAdminEmails() {
				try { return JSON.parse(localStorage.getItem(ADMIN_EMAILS_KEY) || '[]'); } catch { return []; }
			}
			function isUserAdmin(email) {
				if (!email) return false;
				if (email === ADMIN_SEED_EMAIL) return true;
				return getAdminEmails().includes(email);
			}
			// ─────────────────────────────────────────────────────────

			const loginScreenEl = document.getElementById('login-screen');
			const appEl = document.getElementById('app');
			const loginStatusEl = document.getElementById('login-status');
			const loginDebugEl = document.getElementById('login-debug');
			const loginDebugToggleBtn = document.getElementById('btn-toggle-login-debug');
			const authStatusEl = document.getElementById('auth-status');
			const saveStatusEl = document.getElementById('save-status');
			const signOutBtn = document.getElementById('btn-signout');
			const loginIdentifierEl = document.getElementById('login-identifier');
			const loginPasswordEl = document.getElementById('login-password');
			const toggleLoginPasswordBtn = document.getElementById('btn-toggle-login-password');
			const signupUsernameEl = document.getElementById('signup-username');
			const signupEmailEl = document.getElementById('signup-email');
			const signupPasswordEl = document.getElementById('signup-password');
			const toggleSignupPasswordBtn = document.getElementById('btn-toggle-signup-password');
			const loginBtn = document.getElementById('btn-login');
			const signupBtn = document.getElementById('btn-signup');
			const notesEl = document.getElementById('notes');
			const notesHintEl = document.getElementById('notes-hint');
			const acctCurrentEl = document.getElementById('acct-current');
			const acctStatusEl = document.getElementById('acct-status');
			const acctUsernameEl = document.getElementById('acct-username');
			const acctPasswordEl = document.getElementById('acct-password');
			const toggleAcctPasswordBtn = document.getElementById('btn-toggle-acct-password');
			const updateUsernameBtn = document.getElementById('btn-update-username');
			const updatePasswordBtn = document.getElementById('btn-update-password');
			const deleteAccountBtn = document.getElementById('btn-delete-account');

			const tabs = [
				{ tab: document.getElementById('tab-home'),     panel: document.getElementById('panel-home') },
				{ tab: document.getElementById('tab-notes'),    panel: document.getElementById('panel-notes') },
				{ tab: document.getElementById('tab-settings'), panel: document.getElementById('panel-settings') },
				{ tab: document.getElementById('tab-files'),    panel: document.getElementById('panel-files') },
				{ tab: document.getElementById('tab-tools'),    panel: document.getElementById('panel-tools') },
				{ tab: document.getElementById('tab-work'),     panel: document.getElementById('panel-work') },
				{ tab: document.getElementById('tab-reports'),  panel: document.getElementById('panel-reports') },
				{ tab: document.getElementById('tab-admin'),    panel: document.getElementById('panel-admin') },
			];

			const authTabs = [
				{ tab: document.getElementById('auth-tab-login'), panel: document.getElementById('auth-panel-login') },
			];

			let inApp = false;
			let loginDebugVisible = false;
			const prefersReducedMotion = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;

			// ── Splash screen ────────────────────────────────────────
			(function initSplash() {
				const splash = document.getElementById('splash');
				if (!splash) return;
				// Hide splash once the page is interactive (after bootstrap completes).
				// We expose a function so bootstrap() can call it.
				window.__hideSplash = function() {
					if (!splash) return;
					splash.classList.add('splash-out');
					splash.addEventListener('transitionend', () => splash.remove(), { once: true });
					setTimeout(() => splash.remove(), 600); // fallback
				};
			})();

			// ── Dark/light theme toggle ──────────────────────────────
			let currentTheme = 'auto'; // 'auto' | 'light' | 'dark'

			function applyTheme(theme) {
				currentTheme = theme;
				document.body.classList.remove('theme-light', 'theme-dark');
				const themeBtn = document.getElementById('btn-theme-toggle');
				if (theme === 'light') {
					document.body.classList.add('theme-light');
					if (themeBtn) themeBtn.textContent = '☀️';
					document.documentElement.setAttribute('data-theme', 'light');
				} else if (theme === 'dark') {
					document.body.classList.add('theme-dark');
					if (themeBtn) themeBtn.textContent = '🌙';
					document.documentElement.setAttribute('data-theme', 'dark');
				} else {
					// auto — follow system
					const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
					if (themeBtn) themeBtn.textContent = sysDark ? '🌙' : '☀️';
					document.documentElement.removeAttribute('data-theme');
				}
			}

			(function() {
				// Read saved theme from localStorage before first paint
				try {
					const saved = localStorage.getItem('ectl_theme');
					if (saved === 'light' || saved === 'dark') applyTheme(saved);
				} catch { /* ignore */ }
			})();

			const themeToggleBtn = document.getElementById('btn-theme-toggle');
			if (themeToggleBtn) {
				themeToggleBtn.addEventListener('click', () => {
					const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
					let next;
					if (currentTheme === 'auto') {
						next = sysDark ? 'light' : 'dark';
					} else if (currentTheme === 'dark') {
						next = 'light';
					} else {
						next = 'dark';
					}
					applyTheme(next);
					try { localStorage.setItem('ectl_theme', next); } catch { /* ignore */ }
				});
			}

			function setLoginStatusText(message) {
				if (!loginStatusEl) return;
				loginStatusEl.textContent = message ? String(message) : '';
			}

			function setLoginDebugText(message) {
				if (!loginDebugEl) return;
				const msg = String(message || '').trim();
				loginDebugEl.textContent = msg ? `${msg} (build ${BUILD_STAMP})` : `build ${BUILD_STAMP}`;
			}

			function setLoginDebugVisible(visible) {
				loginDebugVisible = !!visible;
				if (loginDebugEl) loginDebugEl.hidden = !loginDebugVisible;
				if (loginDebugToggleBtn) {
					loginDebugToggleBtn.textContent = loginDebugVisible ? 'Hide status' : 'Show status';
					loginDebugToggleBtn.setAttribute('aria-expanded', String(loginDebugVisible));
				}
			}

			if (loginDebugToggleBtn) {
				loginDebugToggleBtn.addEventListener('click', () => {
					setLoginDebugVisible(!loginDebugVisible);
				});
			}

			setLoginDebugVisible(false);

			function setSaveStatus(text) {
				if (!saveStatusEl) return;
				if (!text) {
					saveStatusEl.hidden = true;
					saveStatusEl.textContent = '';
					return;
				}
				saveStatusEl.hidden = false;
				saveStatusEl.textContent = text;
			}

			function setButtonsDisabled(disabled) {
				if (loginBtn) loginBtn.disabled = disabled;
				if (loginIdentifierEl) loginIdentifierEl.disabled = disabled;
				if (loginPasswordEl) loginPasswordEl.disabled = disabled;
			}

			function setAccountStatus(text) {
				if (!acctStatusEl) return;
				acctStatusEl.textContent = String(text || '');
			}

			function showLogin(message) {
				inApp = false;
				if (loginScreenEl) loginScreenEl.hidden = false;
				if (appEl) appEl.hidden = true;
				if (loginScreenEl) loginScreenEl.style.display = '';
				if (appEl) appEl.style.display = 'none';
				setLoginStatusText(message);
				setLoginDebugVisible(false);
				if (authStatusEl) authStatusEl.textContent = 'Signed out';
				if (signOutBtn) signOutBtn.hidden = true;
				if (acctCurrentEl) acctCurrentEl.textContent = 'Signed in';
				if (acctUsernameEl) acctUsernameEl.value = '';
				if (acctPasswordEl) acctPasswordEl.value = '';
				setAccountStatus('');
				if (notesEl) {
					notesEl.disabled = true;
					notesEl.placeholder = 'Sign in to write notes';
					notesEl.value = '';
				}
				if (notesHintEl) notesHintEl.textContent = 'Your notes sync to the cloud.';
				setSaveStatus('');
				// Always hide the admin tab and reset to home when signing out
				const adminTabEl = document.getElementById('tab-admin');
				if (adminTabEl) adminTabEl.hidden = true;
				selectTab('tab-home');
				recenterLoginCard();
			}

			function showApp(displayName, userEmail) {
				inApp = true;
				if (loginScreenEl) loginScreenEl.hidden = true;
				if (appEl) appEl.hidden = false;
				if (loginScreenEl) loginScreenEl.style.display = 'none';
				if (appEl) appEl.style.display = '';
				if (authStatusEl) authStatusEl.textContent = `Signed in: ${displayName} (build ${BUILD_STAMP})`;
				if (signOutBtn) signOutBtn.hidden = false;
				if (notesEl) {
					notesEl.disabled = false;
					notesEl.placeholder = 'Write quick notes here…';
				}
				if (notesHintEl) notesHintEl.textContent = 'Auto-saves to the cloud.';
				// Show admin tab only for admins; redirect away if not admin
				const adminTab = document.getElementById('tab-admin');
				const userIsAdmin = isUserAdmin(userEmail || '');
				if (adminTab) adminTab.hidden = !userIsAdmin;
				if (!userIsAdmin) {
					const adminPanel = document.getElementById('panel-admin');
					if (adminPanel && !adminPanel.hidden) selectTab('tab-home');
				}
			}

			function getAppCard() {
				return document.querySelector('#app .card');
			}

			function getLoginCard() {
				return document.querySelector('#login-screen .card');
			}

			function recenterAppCard() {
				// App is now top-aligned — no dynamic centring needed.
			}

			function recenterLoginCard() {
				if (inApp || !loginScreenEl) return;
				window.requestAnimationFrame(() => {
					const card = getLoginCard();
					if (!card) return;
					const viewH = window.innerHeight || 0;
					const cardH = card.getBoundingClientRect().height;
					const top = Math.max(24, Math.round((viewH - cardH) / 2));
					loginScreenEl.style.setProperty('--login-pad-top', `${top}px`);
				});
			}

			function temporarilyDisableBackdrop(card) {
				if (!card) return () => {};
				const prevBackdrop = card.style.backdropFilter;
				const prevWebkitBackdrop = card.style.webkitBackdropFilter;
				card.style.backdropFilter = 'none';
				card.style.webkitBackdropFilter = 'none';
				return () => {
					card.style.backdropFilter = prevBackdrop;
					card.style.webkitBackdropFilter = prevWebkitBackdrop;
				};
			}


			window.addEventListener('resize', () => {
				recenterAppCard();
				recenterLoginCard();
			});

			function setFatalError(err) {
				const message = err?.message || String(err);
				showLogin(`Error: ${message}`);
			}

			window.addEventListener('error', (e) => {
				setFatalError(e?.error || e?.message || 'Unknown error');
			});
			window.addEventListener('unhandledrejection', (e) => {
				setFatalError(e?.reason || 'Unhandled rejection');
			});

			function animateAppLayoutChange(changeFn) {
				const card = getAppCard();
				if (!card || prefersReducedMotion) {
					changeFn();
					return;
				}

				// Cancel any in-flight layout animation to avoid jitter/stacking.
				if (card.__layoutAnimCleanup) {
					try {
						card.__layoutAnimCleanup();
					} catch {
						// ignore
					}
					card.__layoutAnimCleanup = null;
				}

				const firstHeight = card.getBoundingClientRect().height;
				changeFn();
				const lastHeight = card.getBoundingClientRect().height;
				if (Math.abs(firstHeight - lastHeight) < 0.5) return;

				const duration = 720;
				const easing = 'cubic-bezier(0.18, 1, 0.34, 1)';

				const prevWillChange = card.style.willChange;
				const prevOverflow = card.style.overflow;
				const prevTransition = card.style.transition;
				const restoreBackdrop = temporarilyDisableBackdrop(card);

				card.style.willChange = 'height';
				card.style.overflow = 'hidden';
				card.style.transition = 'none';
				card.style.height = `${firstHeight}px`;
				// Force style/layout flush so the next transition starts from the inverted state.
				void card.offsetHeight;

				let finished = false;
				const cleanup = () => {
					if (finished) return;
					finished = true;
					if (card.__layoutAnimOnEnd) {
						card.removeEventListener('transitionend', card.__layoutAnimOnEnd);
						card.__layoutAnimOnEnd = null;
					}
					if (card.__layoutAnimTimer) {
						window.clearTimeout(card.__layoutAnimTimer);
						card.__layoutAnimTimer = null;
					}
					// Freeze at the final pixel height for one frame,
					// then clear back to auto without any transition (Safari-friendly).
					card.style.transition = 'none';
					card.style.height = `${lastHeight}px`;
					void card.offsetHeight;

					window.requestAnimationFrame(() => {
						card.style.willChange = prevWillChange;
						card.style.overflow = prevOverflow;
						card.style.height = '';
						card.style.transition = prevTransition;
						restoreBackdrop();
						card.__layoutAnimCleanup = null;
					});
				};
				card.__layoutAnimCleanup = cleanup;

				const onEnd = (e) => {
					if (e.target !== card) return;
					// Only finalize when height is done; Safari can fire transform earlier and cause snaps.
					if (e.propertyName !== 'height') return;
					cleanup();
				};
				card.__layoutAnimOnEnd = onEnd;
				card.addEventListener('transitionend', onEnd);
				card.__layoutAnimTimer = window.setTimeout(cleanup, duration + 240);

				// Double-rAF makes the start frame more stable across browsers (Safari included).
				window.requestAnimationFrame(() => {
					window.requestAnimationFrame(() => {
						card.style.transition = `height ${duration}ms ${easing}`;
						card.style.height = `${lastHeight}px`;
					});
				});
			}

			function animateLoginLayoutChange(changeFn) {
				const card = getLoginCard();
				if (!card || prefersReducedMotion) {
					changeFn();
					return;
				}

				// Cancel any in-flight layout animation to avoid jitter/stacking.
				if (card.__layoutAnimCleanup) {
					try {
						card.__layoutAnimCleanup();
					} catch {
						// ignore
					}
				}

				const firstHeight = card.getBoundingClientRect().height;
				changeFn();
				const lastHeight = card.getBoundingClientRect().height;
				if (Math.abs(firstHeight - lastHeight) < 0.5) return;

				const duration = 720;
				const easing = 'cubic-bezier(0.18, 1, 0.34, 1)';

				const prevWillChange = card.style.willChange;
				const prevOverflow = card.style.overflow;
				const prevTransition = card.style.transition;
				const restoreBackdrop = temporarilyDisableBackdrop(card);

				card.style.willChange = 'height';
				card.style.overflow = 'hidden';
				card.style.transition = 'none';
				card.style.height = `${firstHeight}px`;
				void card.offsetHeight;

				let finished = false;
				const cleanup = () => {
					if (finished) return;
					finished = true;
					if (card.__layoutAnimOnEnd) {
						card.removeEventListener('transitionend', card.__layoutAnimOnEnd);
						card.__layoutAnimOnEnd = null;
					}
					if (card.__layoutAnimTimer) {
						window.clearTimeout(card.__layoutAnimTimer);
						card.__layoutAnimTimer = null;
					}
					card.style.transition = 'none';
					card.style.height = `${lastHeight}px`;
					void card.offsetHeight;

					window.requestAnimationFrame(() => {
						card.style.willChange = prevWillChange;
						card.style.overflow = prevOverflow;
						card.style.height = '';
						card.style.transition = prevTransition;
						restoreBackdrop();
						card.__layoutAnimCleanup = null;
					});
				};
				card.__layoutAnimCleanup = cleanup;

				const onEnd = (e) => {
					if (e.target !== card) return;
					if (e.propertyName !== 'height') return;
					cleanup();
				};
				card.__layoutAnimOnEnd = onEnd;
				card.addEventListener('transitionend', onEnd);
				card.__layoutAnimTimer = window.setTimeout(cleanup, duration + 240);

				window.requestAnimationFrame(() => {
					window.requestAnimationFrame(() => {
						card.style.transition = `height ${duration}ms ${easing}`;
						card.style.height = `${lastHeight}px`;
					});
				});
			}

			function replayPanelAnimation(panel) {
					if (!panel) return;
					panel.style.animation = 'none';
					void panel.offsetWidth; // reflow
					panel.style.animation = '';
				}

				// ── Toast notifications ───────────────────────────────
				const toastContainer = document.getElementById('toast-container');
				function showToast(msg, type = 'info') {
					if (!toastContainer) return;
					const el = document.createElement('div');
					el.className = 'toast' + (type === 'success' ? ' toast-success' : type === 'error' ? ' toast-error' : '');
					el.textContent = msg;
					el.setAttribute('role', 'status');
					toastContainer.appendChild(el);
					const dismiss = () => {
						el.classList.add('toast-out');
						el.addEventListener('animationend', () => el.remove(), { once: true });
						setTimeout(() => el.remove(), 400); // fallback
					};
					setTimeout(dismiss, 3200);
					el.addEventListener('click', dismiss);
				}

				// ── Sliding tab indicator ────────────────────────────
				function updateTabIndicator(indicatorId, activeTabEl) {
					const indicator = document.getElementById(indicatorId);
					if (!indicator || !activeTabEl || prefersReducedMotion) return;
					const tabsEl = activeTabEl.closest('.tabs');
					if (!tabsEl) return;
					const tabRect = activeTabEl.getBoundingClientRect();
					const containerRect = tabsEl.getBoundingClientRect();
					indicator.style.left  = (tabRect.left - containerRect.left + tabsEl.scrollLeft) + 'px';
					indicator.style.width = tabRect.width + 'px';
					indicator.classList.add('visible');
				}				function selectTab(selectedId) {
					if (!selectedId) return;
					animateAppLayoutChange(() => {
						for (const { tab, panel } of tabs) {
							if (!tab || !panel) continue;
							const selected = tab.id === selectedId;
							tab.setAttribute('aria-selected', String(selected));
							panel.hidden = !selected;
							if (selected) replayPanelAnimation(panel);
						}
					});
					const activeTab = tabs.find(t => t.tab?.id === selectedId)?.tab;
					requestAnimationFrame(() => updateTabIndicator('app-tab-indicator', activeTab));
				}				function selectAuthTab(selectedId) {
					if (!selectedId) return;
					animateLoginLayoutChange(() => {
						for (const { tab, panel } of authTabs) {
							if (!tab || !panel) continue;
							const selected = tab.id === selectedId;
							tab.setAttribute('aria-selected', String(selected));
							panel.hidden = !selected;
							if (selected) replayPanelAnimation(panel);
						}
					});
					const activeAuthTab = authTabs.find(t => t.tab?.id === selectedId)?.tab;
					requestAnimationFrame(() => updateTabIndicator('auth-tab-indicator', activeAuthTab));
				}			for (const { tab } of tabs) {
				if (!tab) continue;
				tab.addEventListener('click', () => selectTab(tab.id));
				tab.addEventListener('keydown', (e) => {
					if (e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') return;
					e.preventDefault();
					const idx = tabs.findIndex((t) => t.tab === tab);
					const next = e.key === 'ArrowRight' ? (idx + 1) % tabs.length : (idx - 1 + tabs.length) % tabs.length;
					tabs[next].tab?.focus();
					selectTab(tabs[next].tab?.id);
				});
			}

			for (const { tab } of authTabs) {
				if (!tab) continue;
				tab.addEventListener('click', () => selectAuthTab(tab.id));
				tab.addEventListener('keydown', (e) => {
					if (e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') return;
					e.preventDefault();
					const idx = authTabs.findIndex((t) => t.tab === tab);
					const next = e.key === 'ArrowRight' ? (idx + 1) % authTabs.length : (idx - 1 + authTabs.length) % authTabs.length;
					authTabs[next].tab?.focus();
					selectAuthTab(authTabs[next].tab?.id);
				});
			}

			function normalizeUsername(usernameRaw) {
				const username = String(usernameRaw || '').trim().toLowerCase();
				if (!username) return null;
				if (username.includes('@')) return null;
				if (!/^[a-z0-9._-]+$/.test(username)) return null;
				if (username.length < USERNAME_MIN_LEN || username.length > USERNAME_MAX_LEN) return null;
				return username;
			}

			function normalizeEmail(emailRaw) {
				const email = String(emailRaw || '').trim().toLowerCase();
				if (!email) return null;
				if (!email.includes('@')) return null;
				return email;
			}

			function wirePasswordToggle(inputEl, buttonEl) {
				if (!inputEl || !buttonEl) return;
				const render = () => {
					const showing = inputEl.type === 'text';
					buttonEl.textContent = showing ? 'Hide' : 'Show';
					buttonEl.setAttribute('aria-pressed', String(showing));
				};
				render();
				buttonEl.addEventListener('click', () => {
					inputEl.type = inputEl.type === 'password' ? 'text' : 'password';
					render();
					try {
						inputEl.focus();
					} catch {
						// ignore
					}
				});
			}

			wirePasswordToggle(loginPasswordEl, toggleLoginPasswordBtn);
			wirePasswordToggle(signupPasswordEl, toggleSignupPasswordBtn);
			wirePasswordToggle(acctPasswordEl, toggleAcctPasswordBtn);

			function wireEnterSubmit(panelEl, submitBtn) {
				if (!panelEl || !submitBtn) return;
				panelEl.addEventListener('keydown', (e) => {
					if (e.key !== 'Enter') return;
					if (e.isComposing) return;
					const t = e.target;
					if (!t || t.tagName !== 'INPUT') return;
					e.preventDefault();
					if (submitBtn.disabled) return;
					try {
						submitBtn.click();
					} catch {
						// ignore
					}
				});
			}

			wireEnterSubmit(document.getElementById('auth-panel-login'), loginBtn);
			wireEnterSubmit(document.getElementById('auth-panel-signup'), signupBtn);

			function withTimeout(promise, ms, label) {
				let timeoutId;
				const timeoutPromise = new Promise((_, reject) => {
					timeoutId = window.setTimeout(() => {
						reject(new Error(`${label} timed out. Check your network/adblock and Supabase status.`));
					}, ms);
				});
				return Promise.race([promise, timeoutPromise]).finally(() => {
					if (timeoutId) window.clearTimeout(timeoutId);
				});
			}

			function signInWithPasswordXHR(email, password, timeoutMs, onProgress) {
				return new Promise((resolve, reject) => {
					const xhr = new XMLHttpRequest();
					xhr.open('POST', `${SUPABASE_URL}/auth/v1/token?grant_type=password`, true);
					xhr.timeout = timeoutMs;
					xhr.setRequestHeader('Content-Type', 'application/json');
					xhr.setRequestHeader('Accept', 'application/json');
					xhr.setRequestHeader('apikey', SUPABASE_ANON_KEY);
					xhr.onreadystatechange = () => {
						try {
							if (xhr.readyState === 4) {
								onProgress?.(`Supabase response state 4 (HTTP ${xhr.status})…`);
							} else {
								onProgress?.(`Supabase response state ${xhr.readyState}…`);
							}
						} catch {
							// ignore
						}
					};
					xhr.onload = () => {
						let payload = null;
						try {
							payload = xhr.responseText ? JSON.parse(xhr.responseText) : null;
						} catch {
							payload = null;
						}

						if (xhr.status >= 200 && xhr.status < 300) {
							resolve(payload);
							return;
						}

						const msg =
							payload?.error_description ||
							payload?.msg ||
							payload?.message ||
							payload?.error ||
							`Sign in failed (HTTP ${xhr.status})`;
						reject(new Error(String(msg)));
					};
					xhr.onerror = () => reject(new Error('Network error during sign in'));
					xhr.onabort = () => reject(new Error('Sign in request aborted'));
					xhr.ontimeout = () => reject(new Error('Sign in timed out. Check your network/adblock.'));
					try {
						onProgress?.('Contacting Supabase…');
					} catch {
						// ignore
					}
					xhr.send(JSON.stringify({ email, password }));
				});
			}

			function signUpXHR(email, password, username, timeoutMs, onProgress) {
				return new Promise((resolve, reject) => {
					const xhr = new XMLHttpRequest();
					xhr.open('POST', `${SUPABASE_URL}/auth/v1/signup`, true);
					xhr.timeout = timeoutMs;
					xhr.setRequestHeader('Content-Type', 'application/json');
					xhr.setRequestHeader('Accept', 'application/json');
					xhr.setRequestHeader('apikey', SUPABASE_ANON_KEY);
					xhr.onreadystatechange = () => {
						try {
							if (xhr.readyState === 4) {
								onProgress?.(`Supabase response state 4 (HTTP ${xhr.status})…`);
							} else {
								onProgress?.(`Supabase response state ${xhr.readyState}…`);
							}
						} catch {
							// ignore
						}
					};
					xhr.onload = () => {
						let payload = null;
						try {
							payload = xhr.responseText ? JSON.parse(xhr.responseText) : null;
						} catch {
							payload = null;
						}

						if (xhr.status >= 200 && xhr.status < 300) {
							resolve(payload);
							return;
						}

						const msg =
							payload?.error_description ||
							payload?.msg ||
							payload?.message ||
							payload?.error ||
							`Sign up failed (HTTP ${xhr.status})`;
						reject(new Error(String(msg)));
					};
					xhr.onerror = () => reject(new Error('Network error during sign up'));
					xhr.onabort = () => reject(new Error('Sign up request aborted'));
					xhr.ontimeout = () => reject(new Error('Sign up timed out. Check your network/adblock.'));
					try {
						onProgress?.('Contacting Supabase…');
					} catch {
						// ignore
					}
					xhr.send(JSON.stringify({ email, password, data: { username } }));
				});
			}

			function authUpdateUserXHR(accessToken, patch, timeoutMs) {
				return new Promise((resolve, reject) => {
					const xhr = new XMLHttpRequest();
					xhr.open('PUT', `${SUPABASE_URL}/auth/v1/user`, true);
					xhr.timeout = timeoutMs;
					xhr.setRequestHeader('Content-Type', 'application/json');
					xhr.setRequestHeader('Accept', 'application/json');
					xhr.setRequestHeader('apikey', SUPABASE_ANON_KEY);
					xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
					xhr.onload = () => {
						let payload = null;
						try {
							payload = xhr.responseText ? JSON.parse(xhr.responseText) : null;
						} catch {
							payload = null;
						}
						if (xhr.status >= 200 && xhr.status < 300) {
							resolve(payload);
							return;
						}
						const msg =
							payload?.error_description ||
							payload?.msg ||
							payload?.message ||
							payload?.error ||
							`Update failed (HTTP ${xhr.status})`;
						reject(new Error(String(msg)));
					};
					xhr.onerror = () => reject(new Error('Network error updating account'));
					xhr.ontimeout = () => reject(new Error('Account update timed out'));
					xhr.send(JSON.stringify(patch || {}));
				});
			}

			async function deleteAccountViaFunction(accessToken) {
				const res = await fetch(`${SUPABASE_URL}/functions/v1/delete-account`, {
					method: 'POST',
					headers: {
						apikey: SUPABASE_ANON_KEY,
						Authorization: `Bearer ${accessToken}`,
						'Content-Type': 'application/json',
						Accept: 'application/json',
					},
					body: JSON.stringify({}),
				});
				if (res.ok) return;
				let bodyText = '';
				try {
					bodyText = await res.text();
				} catch {
					bodyText = '';
				}
				const suffix = bodyText ? `: ${bodyText}` : '';
				throw new Error(`Delete account function failed (HTTP ${res.status})${suffix}`);
			}

			function startStatusTicker(prefix) {
				const startedAt = Date.now();
				let ticks = 0;
				const render = () => {
					ticks += 1;
					const seconds = ((Date.now() - startedAt) / 1000).toFixed(1);
					if (!inApp) setLoginDebugText(`${prefix} (${seconds}s, tick ${ticks})`);
				};
				render();
				const id = window.setInterval(render, 250);
				return () => window.clearInterval(id);
			}

			async function lookupEmailForUsername(supabase, username) {
				const { data, error } = await withTimeout(
					supabase.from('usernames').select('email').eq('username', username).maybeSingle(),
					AUTH_TIMEOUT_MS,
					'Username lookup',
				);
				if (error) throw error;
				return data?.email ? String(data.email) : null;
			}

			const missingConfig =
				!SUPABASE_URL ||
				!SUPABASE_ANON_KEY ||
				SUPABASE_URL.startsWith('YOUR_') ||
				SUPABASE_ANON_KEY.startsWith('YOUR_');

			if (missingConfig) {
				showLogin('Missing Supabase config (edit index.html).');
				setButtonsDisabled(true);
			} else if (!globalThis.supabase?.createClient) {
				showLogin('Failed to load Supabase client.');
				setButtonsDisabled(true);
			} else {
				function storageAvailable() {
					try {
						const k = '__ectl_storage_test__';
						window.localStorage.setItem(k, '1');
						window.localStorage.removeItem(k);
						return true;
					} catch {
						return false;
					}
				}

				const canPersist = storageAvailable();
				const supabase = globalThis.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
					auth: {
						persistSession: canPersist,
						autoRefreshToken: canPersist,
					},
				});
				let activeUserId = null;
				let activeUser = null;
				let activeAccessToken = null;
				let activeUsingRest = false;
				let applySessionInFlight = null;
				let applySessionRun = 0;

				async function pingSupabase() {
					const res = await fetch(`${SUPABASE_URL}/auth/v1/health`, {
						method: 'GET',
						mode: 'cors',
						headers: {
							apikey: SUPABASE_ANON_KEY,
						},
					});
					return res.status;
				}

				async function lookupEmailForUsernameRest(username) {
					const url = `${SUPABASE_URL}/rest/v1/usernames?select=email&username=eq.${encodeURIComponent(username)}`;
					const res = await fetch(url, {
						method: 'GET',
						headers: {
							apikey: SUPABASE_ANON_KEY,
							Accept: 'application/json',
						},
					});
					if (!res.ok) throw new Error(`Username lookup failed (HTTP ${res.status})`);
					const arr = await res.json();
					const email = Array.isArray(arr) && arr.length ? arr[0]?.email : null;
					return email ? String(email) : null;
				}

				async function restUpsertUsernameMapping(username, userId, email, accessToken) {
					const res = await fetch(`${SUPABASE_URL}/rest/v1/usernames`, {
						method: 'POST',
						headers: {
							apikey: SUPABASE_ANON_KEY,
							Authorization: `Bearer ${accessToken}`,
							'Content-Type': 'application/json',
							Prefer: 'resolution=merge-duplicates',
							Accept: 'application/json',
						},
						body: JSON.stringify([
							{
								username,
								user_id: userId,
								email,
							},
						]),
					});
					if (!res.ok) {
						let msg = `Failed to save username mapping (HTTP ${res.status})`;
						try {
							const t = await res.text();
							if (t) msg = `${msg}: ${t}`;
						} catch {
							// ignore
						}
						throw new Error(msg);
					}
				}

				function enterRestMode(user, accessToken) {
					if (!user?.id) {
						showLogin('Sign in succeeded but user data is missing.');
						return false;
					}
					activeUsingRest = true;
					activeAccessToken = accessToken;
					activeUserId = user.id;
					activeUser = user;
					const displayName = user.user_metadata?.username || user.email || 'Account';
					showApp(`${displayName} (REST mode)`, user.email);
					if (appEl?.hidden) {
						setLoginStatusText('Internal error: app did not become visible after sign-in.');
					}
					if (acctCurrentEl) {
						const username = user.user_metadata?.username ? `@${user.user_metadata.username}` : '(no username set)';
						acctCurrentEl.textContent = `Signed in as ${username} — ${user.email || ''}`.trim();
					}
					// Email verified badge
					if (acctBadgesEl) {
						acctBadgesEl.innerHTML = '';
						const verified = !!(user.email_confirmed_at || user.confirmed_at);
						const badge = document.createElement('span');
						badge.className = 'verified-badge ' + (verified ? 'ok' : 'warn');
						badge.textContent = verified ? '✓ Email verified' : '⚠ Email not verified';
						acctBadgesEl.appendChild(badge);
					}
					// Last sign-in time — stored in new #home-last-signin (inside greeting block)
					const homeLastSigninEl2 = document.getElementById('home-last-signin');
					if (homeLastSigninEl2) {
						const raw = user.last_sign_in_at;
						if (raw) {
							const d = new Date(raw);
							homeLastSigninEl2.textContent = `Last sign-in: ${d.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' })}`;
							homeLastSigninEl2.style.display = '';
						}
					}
					// Render home greeting + quick-actions immediately on login
					renderHomeGreeting(user);
					const qa = document.getElementById('home-quick-actions');
					if (qa) qa.hidden = false;
					if (acctUsernameEl) acctUsernameEl.value = '';
					if (acctPasswordEl) acctPasswordEl.value = '';
					setAccountStatus('');
					// Load and apply this account's saved preferences
					loadPrefs(user.id);
						// Update tab indicators after app becomes visible
						requestAnimationFrame(() => {
							const activeAppTab = tabs.find(t => t.tab?.getAttribute('aria-selected') === 'true')?.tab;
							if (activeAppTab) updateTabIndicator('app-tab-indicator', activeAppTab);
						});
						// Session info badge
						updateSessionInfo();
						// Start idle timer
						resetIdleTimer();
						return true;
					}

				async function restDeleteByUserId(table, userId, accessToken) {
					const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?user_id=eq.${encodeURIComponent(userId)}`, {
						method: 'DELETE',
						headers: {
							apikey: SUPABASE_ANON_KEY,
							Authorization: `Bearer ${accessToken}`,
							Prefer: 'return=minimal',
						},
					});
					if (!res.ok) throw new Error(`Failed to delete from ${table} (HTTP ${res.status})`);
				}

				async function restSaveUsernameMapping(username, userId, email, accessToken) {
					// Try update-by-user_id first; if no row exists, fall back to insert.
					const patchRes = await fetch(`${SUPABASE_URL}/rest/v1/usernames?user_id=eq.${encodeURIComponent(userId)}`, {
						method: 'PATCH',
						headers: {
							apikey: SUPABASE_ANON_KEY,
							Authorization: `Bearer ${accessToken}`,
							'Content-Type': 'application/json',
							Prefer: 'return=representation',
							Accept: 'application/json',
						},
						body: JSON.stringify({ username, email, user_id: userId }),
					});
					if (patchRes.ok) {
						const arr = await patchRes.json().catch(() => []);
						if (Array.isArray(arr) && arr.length) return;
					}
					await restUpsertUsernameMapping(username, userId, email, accessToken);
				}

				// ── Multi-doc notes ──────────────────────────────────────

				// In-memory store: [{ id, title, content, updated_at }]
				let noteDocs = [];
				let activeDocId = null;
				let docSaveTimer = null;

				const docListEl      = document.getElementById('doc-list');
				const docTitleEl     = document.getElementById('doc-title');
				const newDocBtn      = document.getElementById('btn-new-doc');
				const renameDocBtn   = document.getElementById('btn-rename-doc');
				const deleteDocBtn   = document.getElementById('btn-delete-doc');
				const dlDocBtn       = document.getElementById('btn-dl-doc');
				const dlAllBtn       = document.getElementById('btn-dl-all');
				const notesSearchEl  = document.getElementById('notes-search');
				const wordCountEl    = document.getElementById('notes-word-count');
				const acctBadgesEl   = document.getElementById('acct-badges');
				const homeLastSigninEl = document.getElementById('home-last-signin');

				function notesLocalKey(userId) { return `ectl_notedocs_${userId}`; }

				function saveDocsLocally(userId) {
					try { localStorage.setItem(notesLocalKey(userId), JSON.stringify(noteDocs)); } catch { /* ignore */ }
				}

				function loadDocsLocally(userId) {
					try {
						const raw = localStorage.getItem(notesLocalKey(userId));
						return raw ? JSON.parse(raw) : null;
					} catch { return null; }
				}

				function genId() {
					return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
				}

				function fmtDate(iso) {
					if (!iso) return '';
					const d = new Date(iso);
					const now = new Date();
					const sameDay = d.toDateString() === now.toDateString();
					if (sameDay) return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
					return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
				}

				let noteSearchQuery = '';
				let noteColorFilter = 'all'; // 'all' | 'red' | 'yellow' | 'green' | 'blue' | 'purple'
				let noteSortOrder = 'updated'; // 'updated' | 'created' | 'az' | 'za' | 'words'

				let _dragSrcDocId = null;

				// ── Tiny markdown renderer (no dependencies) ─────────────────
				function renderMarkdown(raw) {
					if (!raw) return '';
					let s = String(raw);
					// Escape HTML first
					const esc = t => t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
					// Code blocks
					s = s.replace(/```([\s\S]*?)```/g, (_, c) => `<pre><code>${esc(c.trim())}</code></pre>`);
					// Inline code
					s = s.replace(/`([^`]+)`/g, (_, c) => `<code>${esc(c)}</code>`);
					// Headings
					s = s.replace(/^###### (.+)$/gm, '<h6>$1</h6>');
					s = s.replace(/^##### (.+)$/gm, '<h5>$1</h5>');
					s = s.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
					s = s.replace(/^### (.+)$/gm, '<h3>$1</h3>');
					s = s.replace(/^## (.+)$/gm, '<h2>$1</h2>');
					s = s.replace(/^# (.+)$/gm, '<h1>$1</h1>');
					// Blockquote
					s = s.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
					// HR
					s = s.replace(/^---+$/gm, '<hr>');
					// Bold + italic
					s = s.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
					s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
					s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
					s = s.replace(/__(.+?)__/g, '<strong>$1</strong>');
					s = s.replace(/_(.+?)_/g, '<em>$1</em>');
					// Strikethrough
					s = s.replace(/~~(.+?)~~/g, '<del>$1</del>');
					// Links
					s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
					// Task lists
					s = s.replace(/^- \[x\] (.+)$/gim, '<li class="task-list-item"><input type="checkbox" checked disabled> $1</li>');
					s = s.replace(/^- \[ \] (.+)$/gim, '<li class="task-list-item"><input type="checkbox" disabled> $1</li>');
					// Unordered lists
					s = s.replace(/^[\*\-] (.+)$/gm, '<li>$1</li>');
					s = s.replace(/(<li>.*<\/li>\n?)+/g, m => `<ul>${m}</ul>`);
					// Ordered lists
					s = s.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
					// Tables (simple)
					s = s.replace(/((?:\|.+\|\n?)+)/g, (block) => {
						const rows = block.trim().split('\n').filter(r => r.trim() && !/^\|[-:| ]+\|$/.test(r.trim()));
						if (rows.length < 1) return block;
						return '<table>' + rows.map((r, i) => {
							const cells = r.split('|').filter((_, ci) => ci > 0 && ci < r.split('|').length - 1);
							const tag = i === 0 ? 'th' : 'td';
							return '<tr>' + cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('') + '</tr>';
						}).join('') + '</table>';
					});
					// Paragraphs — wrap lines that aren't already wrapped in block tags
					const blockTags = /^<(h[1-6]|ul|ol|li|pre|blockquote|hr|table|tr|th|td)/;
					s = s.split('\n').map(line => {
						if (!line.trim()) return '<br>';
						if (blockTags.test(line.trim())) return line;
						return `<p>${line}</p>`;
					}).join('\n');
					// Clean up double <br> inside block elements
					s = s.replace(/<br>\s*<br>/g, '<br>');
					return s;
				}

				function renderDocList() {
					if (!docListEl) return;
					docListEl.innerHTML = '';
					const q = noteSearchQuery.toLowerCase().trim();
					let visible = [...noteDocs];
					if (q) {
						visible = visible.filter(d =>
							(d.title || '').toLowerCase().includes(q) ||
							(d.content || '').toLowerCase().includes(q)
						);
					}
					// Color filter
					if (noteColorFilter !== 'all') {
						visible = visible.filter(d => (d.color || 'none') === noteColorFilter);
					}
					// Sort
					if (!q || noteSortOrder !== 'updated') {
						visible.sort((a, b) => {
							// Always pinned first
							if (a.pinned && !b.pinned) return -1;
							if (!a.pinned && b.pinned) return 1;
							switch (noteSortOrder) {
								case 'created': {
									const ac = a.created_at || a.updated_at || '';
									const bc = b.created_at || b.updated_at || '';
									return new Date(bc) - new Date(ac);
								}
								case 'az': return (a.title || '').localeCompare(b.title || '');
								case 'za': return (b.title || '').localeCompare(a.title || '');
								case 'words': {
									const aw = (a.content || '').trim().split(/\s+/).filter(Boolean).length;
									const bw = (b.content || '').trim().split(/\s+/).filter(Boolean).length;
									return bw - aw;
								}
								default: return new Date(b.updated_at) - new Date(a.updated_at);
							}
						});
					}
					// Update count badge
					const badge = document.getElementById('notes-count-badge');
					if (badge) badge.textContent = String(visible.length);

					for (const doc of visible) {
						const btn = document.createElement('button');
						const colorClass = doc.color && doc.color !== 'none' ? ` color-${doc.color}` : '';
						btn.className = 'doc-item' + (doc.id === activeDocId ? ' active' : '') + colorClass;
						btn.type = 'button';
						btn.setAttribute('role', 'listitem');
						btn.draggable = true;
						btn.dataset.docId = doc.id;
						// Color dot
						const dotHtml = doc.color && doc.color !== 'none'
							? `<span class="doc-color-dot" data-color="${doc.color}" aria-hidden="true"></span>`
							: '';
						// Timestamp tooltip
						const updatedFull = doc.updated_at ? new Date(doc.updated_at).toLocaleString() : '';
						// Search snippet
						let snippetHtml = '';
						if (q && (doc.content || '').toLowerCase().includes(q)) {
							const idx = doc.content.toLowerCase().indexOf(q);
							const start = Math.max(0, idx - 22);
							const raw = doc.content.slice(start, idx + q.length + 38);
							const hilited = raw.replace(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi'),
								m => `<mark>${escHtml(m)}</mark>`);
							snippetHtml = `<span class="doc-item-snippet">${start > 0 ? '…' : ''}${hilited}${raw.length < doc.content.length - start ? '…' : ''}</span>`;
							btn.classList.add('has-snippet');
						}
						btn.innerHTML = `
							<span class="doc-item-left">${dotHtml}<span class="doc-item-name">${escHtml(doc.title || 'Untitled')}</span>${snippetHtml}</span>
							<span style="display:flex;align-items:center;gap:4px;flex-shrink:0">${doc.pinned ? '<span class="doc-item-pin-badge" aria-label="Pinned" title="Pinned">📌</span>' : ''}<span class="doc-item-date" title="${escHtml(updatedFull)}">${fmtDate(doc.updated_at)}</span></span>
						`;
						btn.addEventListener('click', () => switchDoc(doc.id));

						// ── Drag-to-reorder ──
						btn.addEventListener('dragstart', (e) => {
							_dragSrcDocId = doc.id;
							btn.classList.add('dragging');
							e.dataTransfer.effectAllowed = 'move';
							e.dataTransfer.setData('text/plain', doc.id);
						});
						btn.addEventListener('dragend', () => {
							btn.classList.remove('dragging');
							docListEl.querySelectorAll('.doc-item').forEach(el => el.classList.remove('drag-over'));
						});
						btn.addEventListener('dragover', (e) => {
							e.preventDefault();
							e.dataTransfer.dropEffect = 'move';
							docListEl.querySelectorAll('.doc-item').forEach(el => el.classList.remove('drag-over'));
							if (doc.id !== _dragSrcDocId) btn.classList.add('drag-over');
						});
						btn.addEventListener('dragleave', () => btn.classList.remove('drag-over'));
						btn.addEventListener('drop', (e) => {
							e.preventDefault();
							btn.classList.remove('drag-over');
							if (!_dragSrcDocId || _dragSrcDocId === doc.id) return;
							// Reorder noteDocs in memory
							const srcIdx = noteDocs.findIndex(d => d.id === _dragSrcDocId);
							const dstIdx = noteDocs.findIndex(d => d.id === doc.id);
							if (srcIdx === -1 || dstIdx === -1) return;
							const [moved] = noteDocs.splice(srcIdx, 1);
							noteDocs.splice(dstIdx, 0, moved);
							if (activeUserId) saveDocsLocally(activeUserId);
							renderDocList();
							_dragSrcDocId = null;
						});

						// Pin button
						const pinBtn = document.createElement('button');
						pinBtn.className = 'doc-pin-btn' + (doc.pinned ? ' pinned' : '');
						pinBtn.type = 'button';
						pinBtn.title = doc.pinned ? 'Unpin' : 'Pin to top';
						pinBtn.setAttribute('aria-label', doc.pinned ? 'Unpin' : 'Pin');
						pinBtn.textContent = '📌';
						pinBtn.addEventListener('click', (e) => {
							e.stopPropagation();
							doc.pinned = !doc.pinned;
							if (activeUserId) saveDocsLocally(activeUserId);
							if (activeUserId && activeAccessToken) {
								restUpsertDoc(activeUserId, doc, activeAccessToken).catch(() => {});
							}
							renderDocList();
						});

						// Color button
						const colorWrap = document.createElement('span');
						colorWrap.style.cssText = 'position:relative;flex-shrink:0';
						const colorBtn = document.createElement('button');
						colorBtn.className = 'doc-color-btn';
						colorBtn.type = 'button';
						colorBtn.title = 'Set colour label';
						colorBtn.setAttribute('aria-label', 'Set colour label');
						colorBtn.textContent = '●';
						// Colour picker popup
						const colorPop = document.createElement('div');
						colorPop.className = 'color-picker-pop';
						colorPop.hidden = true;
						const COLOR_OPTS = ['none','red','yellow','green','blue','purple'];
						COLOR_OPTS.forEach(c => {
							const sw = document.createElement('button');
							sw.className = 'color-swatch-btn' + ((doc.color || 'none') === c ? ' active' : '');
							sw.dataset.color = c;
							sw.type = 'button';
							sw.title = c === 'none' ? 'No colour' : c.charAt(0).toUpperCase() + c.slice(1);
							sw.addEventListener('click', (e) => {
								e.stopPropagation();
								doc.color = c === 'none' ? undefined : c;
								colorPop.hidden = true;
								if (activeUserId) saveDocsLocally(activeUserId);
								if (activeUserId && activeAccessToken) {
									restUpsertDoc(activeUserId, doc, activeAccessToken).catch(() => {});
								}
								renderDocList();
							});
							colorPop.appendChild(sw);
						});
						colorBtn.addEventListener('click', (e) => {
							e.stopPropagation();
							// Close any other open pickers
							docListEl.querySelectorAll('.color-picker-pop').forEach(p => { if (p !== colorPop) p.hidden = true; });
							if (colorPop.hidden) {
								colorPop.hidden = false;
								// Position using fixed coords so it never clips inside overflow:hidden containers
								requestAnimationFrame(() => {
									const r = colorBtn.getBoundingClientRect();
									const popH = colorPop.offsetHeight;
									const spaceBelow = window.innerHeight - r.bottom;
									const popW = colorPop.offsetWidth;
									if (spaceBelow < popH + 8 && r.top > popH + 8) {
										// Flip above the button
										colorPop.style.top = (r.top - popH - 4) + 'px';
									} else {
										colorPop.style.top = (r.bottom + 4) + 'px';
									}
									colorPop.style.right = (window.innerWidth - r.right) + 'px';
									colorPop.style.left = 'auto';
								});
							} else {
								colorPop.hidden = true;
							}
						});
						colorWrap.appendChild(colorBtn);
						// Append popup to body so it's never clipped by overflow:hidden parents
						document.body.appendChild(colorPop);
						// Close picker when clicking outside
						document.addEventListener('click', () => { colorPop.hidden = true; }, { once: false, capture: false });

						btn.appendChild(pinBtn);
						btn.appendChild(colorWrap);
						docListEl.appendChild(btn);
					}
				}

				function escHtml(s) {
					return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
				}

				function switchDoc(id) {
					// Save snapshot of current content before switching
					if (activeDocId && notesEl) pushSnapshot(activeDocId, notesEl.value);
					// Flush any pending save to the old doc first
					if (docSaveTimer) { clearTimeout(docSaveTimer); docSaveTimer = null; }
					if (activeDocId && notesEl) {
						const prev = noteDocs.find(d => d.id === activeDocId);
						if (prev) prev.content = notesEl.value;
					}
					activeDocId = id;
					const doc = noteDocs.find(d => d.id === id);
					if (!doc) return;
					if (notesEl)    { notesEl.value = doc.content ?? ''; }
					if (docTitleEl) { docTitleEl.value = doc.title ?? ''; }
					notesEl?.focus();
					renderDocList();
				}

			function createDoc(title, content = '') {
				return { id: genId(), title: title || 'Untitled', content, updated_at: new Date().toISOString() };
			}				// ── REST helpers for note_docs table ──
				async function restGetDocs(userId, accessToken) {
					const url = `${SUPABASE_URL}/rest/v1/note_docs?select=id,title,content,updated_at&user_id=eq.${encodeURIComponent(userId)}&order=updated_at.desc`;
					const res = await fetch(url, {
						headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${accessToken}`, Accept: 'application/json' },
					});
					if (!res.ok) throw new Error(`Docs load failed (HTTP ${res.status})`);
					return res.json();
				}

				async function restUpsertDoc(userId, doc, accessToken) {
					const res = await fetch(`${SUPABASE_URL}/rest/v1/note_docs?on_conflict=id`, {
						method: 'POST',
						headers: {
							apikey: SUPABASE_ANON_KEY,
							Authorization: `Bearer ${accessToken}`,
							'Content-Type': 'application/json',
							Prefer: 'resolution=merge-duplicates',
							Accept: 'application/json',
						},
						body: JSON.stringify([{ id: doc.id, user_id: userId, title: doc.title, content: doc.content, updated_at: doc.updated_at }]),
					});
					if (!res.ok) {
						let d = ''; try { d = await res.text(); } catch { /* ignore */ }
						throw new Error(`HTTP ${res.status}${d ? ': ' + d : ''}`);
					}
				}

				async function restDeleteDoc(userId, docId, accessToken) {
					const res = await fetch(`${SUPABASE_URL}/rest/v1/note_docs?id=eq.${encodeURIComponent(docId)}&user_id=eq.${encodeURIComponent(userId)}`, {
						method: 'DELETE',
						headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${accessToken}`, Prefer: 'return=minimal' },
					});
					if (!res.ok) throw new Error(`Doc delete failed (HTTP ${res.status})`);
				}

				// ── Load / save ──
				async function loadNotes(userId) {
					if (!notesEl) return;
					notesEl.disabled = true;
					setSaveStatus('Loading…');
					try {
						const rows = await withTimeout(restGetDocs(userId, activeAccessToken), AUTH_TIMEOUT_MS, 'Docs load');
						noteDocs = Array.isArray(rows) ? rows : [];
						saveDocsLocally(userId);
					} catch (e) {
						console.warn('Cloud docs load failed, using localStorage:', e?.message);
						const local = loadDocsLocally(userId);
						noteDocs = Array.isArray(local) ? local : [];
					}
					// Ensure at least one document
					if (noteDocs.length === 0) { const d = createDoc('My Notes'); noteDocs.push(d); }
					notesEl.disabled = false;
					notesEl.placeholder = 'Write your notes here…';
					switchDoc(noteDocs[0].id);
					renderDocList();
					setSaveStatus('');
					renderStats();
				}

				// ── Dashboard stats ───────────────────────────────────
				// ── Home: greeting ────────────────────────────────────
				function renderHomeGreeting(user) {
					const wrap    = document.getElementById('home-greeting');
					const textEl  = document.getElementById('home-greeting-text');
					const dateEl  = document.getElementById('home-greeting-date');
					const signOut = document.getElementById('home-signed-out');
					if (!wrap) return;
					// Hide the signed-out placeholder
					if (signOut) signOut.hidden = true;
					// Greeting text
					const hour = new Date().getHours();
					const tod  = hour < 12 ? '☀️ Good morning' : hour < 17 ? '🌤 Good afternoon' : '🌙 Good evening';
					const name = user?.user_metadata?.username ? `@${user.user_metadata.username}` : (user?.email?.split('@')[0] || '');
					if (textEl) textEl.textContent = `${tod}${name ? ', ' + name : ''}`;
					// Date string
					if (dateEl) {
						dateEl.textContent = new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
					}
					wrap.hidden = false;
				}

				// ── Home: recent + pinned notes ───────────────────────
				function renderHomeRecentNotes() {
					const recentSec  = document.getElementById('home-recent-notes');
					const recentList = document.getElementById('home-recent-notes-list');
					const pinnedSec  = document.getElementById('home-pinned-notes');
					const pinnedList = document.getElementById('home-pinned-list');
					if (!recentSec || !recentList) return;

					function noteCard(doc, pinned) {
						const card  = document.createElement('div');
						card.className = 'home-note-card';
						const color  = doc.color || '';
						const words  = (doc.content || '').trim().split(/\s+/).filter(Boolean).length;
						const snippet = (doc.content || '').replace(/\s+/g, ' ').trim().slice(0, 80);
						card.innerHTML = `
							<span class="home-note-card-dot${color ? ' color-' + color : ''}" aria-hidden="true"></span>
							${pinned ? '<span class="home-note-pin" aria-hidden="true">📌</span>' : ''}
							<span class="home-note-card-title">${escHtml(doc.title || 'Untitled')}</span>
							<span class="home-note-card-snippet">${escHtml(snippet)}</span>
							<span class="home-note-card-meta">
								<span class="home-note-card-words">${words.toLocaleString()}w</span>
								<span class="home-note-card-date">${fmtDate(doc.updated_at || doc.created_at)}</span>
							</span>
						`;
						card.addEventListener('click', () => {
							selectTab('tab-notes');
							switchDoc(doc.id);
						});
						return card;
					}

					// Pinned notes
					const pinned = noteDocs.filter(d => d.pinned);
					if (pinnedSec && pinnedList) {
						if (pinned.length > 0) {
							pinnedList.innerHTML = '';
							pinned.slice(0, 5).forEach(d => pinnedList.appendChild(noteCard(d, true)));
							pinnedSec.hidden = false;
						} else {
							pinnedSec.hidden = true;
						}
					}

					// Recent notes (most recently updated, skip pinned if already shown)
					const recent = [...noteDocs]
						.sort((a, b) => new Date(b.updated_at || 0) - new Date(a.updated_at || 0))
						.slice(0, 6);
					if (recent.length === 0) { recentSec.hidden = true; return; }
					recentList.innerHTML = '';
					recent.forEach(d => recentList.appendChild(noteCard(d, false)));
					recentSec.hidden = false;
				}

				// ── Home: 7-day activity ──────────────────────────────
				function renderHomeActivity() {
					const section   = document.getElementById('home-activity');
					const dotsEl    = document.getElementById('home-activity-dots');
					const labelEl   = document.getElementById('home-activity-label');
					const streakEl  = document.getElementById('home-streak-badge');
					if (!section || !dotsEl) return;

					// Build per-day edit counts for the last 7 days
					const days = [];
					for (let i = 6; i >= 0; i--) {
						const d = new Date();
						d.setDate(d.getDate() - i);
						days.push(d.toDateString());
					}
					const counts = days.map(dayStr =>
						noteDocs.filter(doc => {
							const u = doc.updated_at || doc.created_at;
							return u && new Date(u).toDateString() === dayStr;
						}).length
					);
					const maxCount = Math.max(...counts, 1);
					const totalActive = counts.filter(c => c > 0).length;
					const totalEdits  = counts.reduce((s, c) => s + c, 0);

					// Render dots
					dotsEl.innerHTML = '';
					const dayLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
					days.forEach((dayStr, i) => {
						const dot = document.createElement('div');
						const h = Math.max(4, Math.round((counts[i] / maxCount) * 28));
						dot.className = 'home-activity-day' +
							(counts[i] >= 3 ? ' many-edits' : counts[i] > 0 ? ' has-edits' : '');
						dot.style.height = `${h}px`;
						dot.title = `${dayLabels[new Date(dayStr).getDay()]}: ${counts[i]} note${counts[i] !== 1 ? 's' : ''} edited`;
						dotsEl.appendChild(dot);
					});

					if (labelEl) {
						labelEl.textContent = totalEdits === 0
							? 'No edits this week'
							: `${totalEdits} note edit${totalEdits !== 1 ? 's' : ''} across ${totalActive} day${totalActive !== 1 ? 's' : ''} this week`;
					}

					// Streak badge: consecutive days up to today with at least 1 edit
					let streak = 0;
					for (let i = counts.length - 1; i >= 0; i--) {
						if (counts[i] > 0) streak++; else break;
					}
					if (streakEl) {
						if (streak >= 2) {
							streakEl.textContent = `🔥 ${streak}-day streak`;
							streakEl.hidden = false;
						} else {
							streakEl.hidden = true;
						}
					}
					section.hidden = false;
				}

				// ── Home: full refresh ────────────────────────────────
				function refreshHome() {
					renderHomeGreeting(activeUser);
					renderHomeRecentNotes();
					renderHomeActivity();
					// Show quick actions
					const qa = document.getElementById('home-quick-actions');
					if (qa) qa.hidden = false;
				}

				// ── Dashboard stats ───────────────────────────────────
				function renderStats() {
					const statsSection = document.getElementById('home-stats');
					const statsGrid = document.getElementById('stats-grid');
					if (!statsSection || !statsGrid) return;
					const totalDocs = noteDocs.length;
					const totalWords = noteDocs.reduce((sum, d) => {
						const text = (d.content || '').trim();
						return sum + (text ? text.split(/\s+/).length : 0);
					}, 0);
					const acctAge = activeUser?.created_at
						? Math.floor((Date.now() - new Date(activeUser.created_at)) / (1000 * 60 * 60 * 24))
						: null;
					const fileCount = _cachedFiles.length;
					// Additional metrics
					const avgWords = totalDocs > 0 ? Math.round(totalWords / totalDocs) : 0;
					const thisWeek = noteDocs.filter(d => {
						const age = (Date.now() - new Date(d.updated_at)) / (1000 * 60 * 60 * 24);
						return age <= 7;
					}).length;
					const longestDoc = noteDocs.reduce((best, d) => {
						const w = (d.content || '').trim().split(/\s+/).filter(Boolean).length;
						return w > (best?.w || 0) ? { w, title: d.title } : best;
					}, null);
					const totalChars = noteDocs.reduce((sum, d) => sum + (d.content || '').length, 0);
					statsGrid.innerHTML = '';
					const items = [
						{ label: 'Notes', value: totalDocs, tab: 'tab-notes', title: 'Go to Notes' },
						{ label: 'Total Words', value: totalWords.toLocaleString(), tab: 'tab-notes', title: 'Go to Notes' },
						{ label: 'Avg Words/Note', value: avgWords, tab: null, title: null },
						{ label: 'Edited This Week', value: thisWeek, tab: 'tab-notes', title: 'Go to Notes' },
						...(totalChars > 0 ? [{ label: 'Total Chars', value: totalChars.toLocaleString(), tab: null, title: null }] : []),
						...(fileCount > 0 ? [{ label: 'Files', value: fileCount, tab: 'tab-files', title: 'Go to Files' }] : []),
						...(acctAge !== null ? [{ label: 'Days Active', value: acctAge, tab: null, title: null }] : []),
						...(longestDoc ? [{ label: 'Longest Note', value: longestDoc.w + ' w', tab: null, title: longestDoc.title || 'Untitled' }] : []),
					];
					for (const item of items) {
						const card = document.createElement('div');
						card.className = 'stat-card' + (item.tab ? ' clickable' : '');
						if (item.title) card.setAttribute('title', item.title);
						card.innerHTML = `<div class="stat-card-value">${item.value}</div><div class="stat-card-label">${item.label}</div>`;
						if (item.tab) {
							card.addEventListener('click', () => selectTab(item.tab));
						}
						statsGrid.appendChild(card);
					}
					statsSection.hidden = false;
					// Refresh home dynamic sections now that note data is available
					refreshHome();
				}

				// ── Sort select ──────────────────────────────────────
				document.getElementById('notes-sort-select')?.addEventListener('change', (e) => {
					noteSortOrder = e.target.value;
					renderDocList();
				});

				// ── Markdown preview toggle ──────────────────────────
				let mdPreviewOn = false;
				document.getElementById('btn-md-preview')?.addEventListener('click', () => {
					mdPreviewOn = !mdPreviewOn;
					const col = document.getElementById('notes-editor-col');
					const pane = document.getElementById('md-preview-pane');
					const btn = document.getElementById('btn-md-preview');
					col?.classList.toggle('preview-mode', mdPreviewOn);
					if (pane) pane.hidden = !mdPreviewOn;
					if (btn) btn.setAttribute('aria-pressed', String(mdPreviewOn));
					if (btn) btn.style.opacity = mdPreviewOn ? '1' : '';
					if (mdPreviewOn && notesEl && pane) pane.innerHTML = renderMarkdown(notesEl.value);
				});

				// ── Duplicate note ───────────────────────────────────
				document.getElementById('btn-duplicate-doc')?.addEventListener('click', () => {
					const doc = noteDocs.find(d => d.id === activeDocId);
					if (!doc) return;
					if (notesEl) doc.content = notesEl.value;
					const copy = createDoc((doc.title || 'Untitled') + ' (copy)', doc.content);
					copy.color = doc.color;
					noteDocs.unshift(copy);
					renderDocList();
					switchDoc(copy.id);
					if (activeUserId) saveDocsLocally(activeUserId);
					if (activeUserId && activeAccessToken) {
						restUpsertDoc(activeUserId, copy, activeAccessToken).catch(() => {});
					}
					showToast('Note duplicated', 'success');
				});

				// ── Export all notes as single .md ────────────────────
				document.getElementById('btn-export-all-md')?.addEventListener('click', () => {
					if (activeDocId && notesEl) {
						const cur = noteDocs.find(d => d.id === activeDocId);
						if (cur) cur.content = notesEl.value;
					}
					const md = noteDocs
						.map(d => `## ${d.title || 'Untitled'}\n\n${d.content || ''}`)
						.join('\n\n---\n\n');
					const blob = new Blob([md], { type: 'text/markdown' });
					const a = document.createElement('a');
					a.href = URL.createObjectURL(blob);
					a.download = 'all-notes.md';
					a.click();
					setTimeout(() => URL.revokeObjectURL(a.href), 10000);
					showToast(`Exported ${noteDocs.length} note${noteDocs.length !== 1 ? 's' : ''}`, 'success');
				});

				// ── File search ──────────────────────────────────────
				// ── Home quick-action buttons ─────────────────────────
				document.getElementById('btn-home-new-note')?.addEventListener('click', () => {
					selectTab('tab-notes');
					document.getElementById('btn-new-doc')?.click();
				});
				document.getElementById('btn-home-go-notes')?.addEventListener('click', () => selectTab('tab-notes'));
				document.getElementById('btn-home-go-files')?.addEventListener('click', () => selectTab('tab-files'));
				document.getElementById('btn-home-journal')?.addEventListener('click', () => {
					selectTab('tab-notes');
					// Create a dated journal note
					const today = new Date().toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
					const doc = createDoc(`Journal — ${today}`);
					doc.content = `# ${today}\n\n`;
					noteDocs.unshift(doc);
					saveDocsLocally(activeUserId);
					renderDocList();
					switchDoc(doc.id);
					if (notesEl) {
						notesEl.focus();
						notesEl.selectionStart = notesEl.selectionEnd = notesEl.value.length;
					}
				});

				// ── File search ──────────────────────────────────────
				document.getElementById('file-search-input')?.addEventListener('input', (e) => {
					const q = e.target.value.toLowerCase().trim();
					const rows = document.querySelectorAll('#file-list .file-row');
					rows.forEach(row => {
						const name = row.querySelector('.file-row-name')?.textContent?.toLowerCase() ?? '';
						row.hidden = q ? !name.includes(q) : false;
					});
				});

				// ════════════════════════════════════════════════════
				// ── TOOLS PANEL ──────────────────────────────────────
				// ════════════════════════════════════════════════════

				// Helper: copy text + brief button feedback
				function toolCopy(text, btn) {
					navigator.clipboard?.writeText(text).catch(() => {});
					if (btn) {
						const orig = btn.textContent;
						btn.textContent = '✓ Copied';
						setTimeout(() => { btn.textContent = orig; }, 1200);
					}
				}

				// ── Password Generator ────────────────────────────────
				(function() {
					const upper = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
					const lower = 'abcdefghijklmnopqrstuvwxyz';
					const nums  = '0123456789';
					const syms  = '!@#$%^&*()-_=+[]{}|;:,.<>?';

					function pwStrength(pw) {
						let score = 0;
						if (pw.length >= 12) score++;
						if (pw.length >= 16) score++;
						if (/[A-Z]/.test(pw)) score++;
						if (/[a-z]/.test(pw)) score++;
						if (/[0-9]/.test(pw)) score++;
						if (/[^A-Za-z0-9]/.test(pw)) score++;
						if (score <= 2) return { label: 'Weak',   cls: 'weak' };
						if (score <= 3) return { label: 'Fair',   cls: 'fair' };
						if (score <= 4) return { label: 'Strong', cls: 'strong' };
						return            { label: 'Great',  cls: 'great' };
					}

					function generate() {
						const lenEl     = document.getElementById('tool-pw-len');
						const outputEl  = document.getElementById('tool-pw-output');
						const strengthEl= document.getElementById('tool-pw-strength');
						const useUpper  = document.getElementById('tool-pw-upper')?.checked;
						const useLower  = document.getElementById('tool-pw-lower')?.checked;
						const useNum    = document.getElementById('tool-pw-num')?.checked;
						const useSym    = document.getElementById('tool-pw-sym')?.checked;
						const len       = parseInt(lenEl?.value || '16', 10);
						let charset = '';
						if (useUpper) charset += upper;
						if (useLower) charset += lower;
						if (useNum)   charset += nums;
						if (useSym)   charset += syms;
						if (!charset) charset = lower + nums;
						let pw = '';
						const arr = new Uint32Array(len);
						crypto.getRandomValues(arr);
						for (let i = 0; i < len; i++) pw += charset[arr[i] % charset.length];
						if (outputEl) outputEl.value = pw;
						if (strengthEl) {
							const s = pwStrength(pw);
							strengthEl.textContent = s.label;
							strengthEl.className = 'tool-pw-strength ' + s.cls;
						}
					}

					document.getElementById('tool-pw-gen')?.addEventListener('click', generate);
					document.getElementById('tool-pw-len')?.addEventListener('input', (e) => {
						const v = document.getElementById('tool-pw-len-val');
						if (v) v.textContent = e.target.value;
					});
					document.getElementById('tool-pw-copy')?.addEventListener('click', (e) => {
						const val = document.getElementById('tool-pw-output')?.value;
						if (val) toolCopy(val, e.currentTarget);
					});
					// Generate one immediately
					generate();
				})();

				// ── Text Analyser ─────────────────────────────────────
				(function() {
					function analyse() {
						const text  = document.getElementById('tool-wc-input')?.value || '';
						const words = text.trim() ? text.trim().split(/\s+/).length : 0;
						const chars = text.length;
						const charsNsp = text.replace(/\s/g, '').length;
						const sents = text.trim() ? (text.match(/[.!?]+/g) || []).length || 1 : 0;
						const paras = text.trim() ? text.split(/\n\s*\n/).filter(p => p.trim()).length || 1 : 0;
						const readMin = Math.max(0, Math.ceil(words / 238));
						const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
						set('tool-wc-words',    words.toLocaleString() + ' words');
						set('tool-wc-chars',    chars.toLocaleString() + ' chars');
						set('tool-wc-chars-nsp',charsNsp.toLocaleString() + ' no-space');
						set('tool-wc-sents',    sents.toLocaleString() + ' sentences');
						set('tool-wc-paras',    paras.toLocaleString() + ' paragraphs');
						set('tool-wc-read',     '~' + readMin + ' min read');
					}
					document.getElementById('tool-wc-input')?.addEventListener('input', analyse);
					document.getElementById('tool-wc-clear')?.addEventListener('click', () => {
						const el = document.getElementById('tool-wc-input');
						if (el) { el.value = ''; analyse(); }
					});
					document.getElementById('tool-wc-copy-stats')?.addEventListener('click', (e) => {
						const stats = ['tool-wc-words','tool-wc-chars','tool-wc-chars-nsp','tool-wc-sents','tool-wc-paras','tool-wc-read']
							.map(id => document.getElementById(id)?.textContent || '').join(' · ');
						toolCopy(stats, e.currentTarget);
					});
				})();

				// ── Pomodoro Timer ────────────────────────────────────
				(function() {
					let _pomoInterval = null;
					let _pomoSecsLeft = 25 * 60;
					let _pomoTotalSecs = 25 * 60;
					let _pomoPhase = 'work'; // 'work' | 'break'
					let _pomoRunning = false;
					let _pomoSessions = 0;
					const CIRC = 2 * Math.PI * 34; // 213.6

					function pomoRender() {
						const timeEl  = document.getElementById('pomo-time');
						const phaseEl = document.getElementById('pomo-phase');
						const ringEl  = document.getElementById('pomo-ring-fill');
						const wrap    = document.querySelector('.tool-pomo-ring-wrap');
						const m = Math.floor(_pomoSecsLeft / 60);
						const s = _pomoSecsLeft % 60;
						if (timeEl) timeEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
						if (phaseEl) phaseEl.textContent = _pomoPhase === 'work' ? 'Work' : 'Break';
						if (wrap) wrap.classList.toggle('pomo-break', _pomoPhase === 'break');
						const pct = _pomoTotalSecs > 0 ? _pomoSecsLeft / _pomoTotalSecs : 1;
						if (ringEl) ringEl.style.strokeDashoffset = CIRC * (1 - pct);
					}

					function pomoLog(msg) {
						const el = document.getElementById('pomo-log');
						if (el) el.textContent = msg;
					}

					function pomoStop() {
						if (_pomoInterval) clearInterval(_pomoInterval);
						_pomoInterval = null;
						_pomoRunning = false;
						const btn = document.getElementById('btn-pomo-start');
						if (btn) btn.textContent = '▶ Start';
					}

					function pomoNextPhase() {
						if (_pomoPhase === 'work') {
							_pomoSessions++;
							_pomoPhase = 'break';
							const bMin = parseInt(document.getElementById('pomo-break-min')?.value || '5', 10);
							_pomoSecsLeft = _pomoTotalSecs = bMin * 60;
							pomoLog(`✅ Session ${_pomoSessions} done! Break time.`);
						} else {
							_pomoPhase = 'work';
							const wMin = parseInt(document.getElementById('pomo-work-min')?.value || '25', 10);
							_pomoSecsLeft = _pomoTotalSecs = wMin * 60;
							pomoLog(`⏳ Session ${_pomoSessions + 1} starting…`);
						}
						try { new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=').play().catch(()=>{}); } catch { /* no audio */ }
					}

					document.getElementById('btn-pomo-start')?.addEventListener('click', () => {
						if (_pomoRunning) {
							pomoStop();
							pomoLog('Paused.');
						} else {
							_pomoRunning = true;
							const btn = document.getElementById('btn-pomo-start');
							if (btn) btn.textContent = '⏸ Pause';
							_pomoInterval = setInterval(() => {
								if (_pomoSecsLeft <= 0) {
									pomoNextPhase();
									pomoRender();
									return;
								}
								_pomoSecsLeft--;
								pomoRender();
							}, 1000);
							pomoLog(_pomoPhase === 'work' ? '⏳ Focus!' : '☕ Break!');
						}
					});

					document.getElementById('btn-pomo-reset')?.addEventListener('click', () => {
						pomoStop();
						_pomoPhase = 'work';
						const wMin = parseInt(document.getElementById('pomo-work-min')?.value || '25', 10);
						_pomoSecsLeft = _pomoTotalSecs = wMin * 60;
						pomoRender();
						pomoLog('');
					});

					pomoRender();
				})();

				// ── Base64 Encoder / Decoder ──────────────────────────
				(function() {
					function b64Out(val) {
						const el = document.getElementById('tool-b64-output');
						if (el) el.value = val;
					}
					document.getElementById('tool-b64-enc')?.addEventListener('click', () => {
						const txt = document.getElementById('tool-b64-input')?.value || '';
						try { b64Out(btoa(unescape(encodeURIComponent(txt)))); } catch { b64Out('Encode error'); }
					});
					document.getElementById('tool-b64-dec')?.addEventListener('click', () => {
						const txt = document.getElementById('tool-b64-input')?.value || '';
						try { b64Out(decodeURIComponent(escape(atob(txt.trim())))); } catch { b64Out('Invalid Base64'); }
					});
					document.getElementById('tool-b64-copy')?.addEventListener('click', (e) => {
						const val = document.getElementById('tool-b64-output')?.value;
						if (val) toolCopy(val, e.currentTarget);
					});
				})();

				// ── UUID Generator ────────────────────────────────────
				(function() {
					function genUUID() {
						if (crypto.randomUUID) return crypto.randomUUID();
						// fallback
						return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
							const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 0xf);
							return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
						});
					}
					function renderUUIDs() {
						const count = parseInt(document.getElementById('tool-uuid-count')?.value || '5', 10);
						const list  = document.getElementById('tool-uuid-list');
						if (!list) return;
						list.innerHTML = '';
						const uuids = Array.from({ length: count }, genUUID);
						uuids.forEach(u => {
							const row = document.createElement('div');
							row.className = 'tool-uuid-row';
							const val = document.createElement('span');
							val.className = 'tool-uuid-val';
							val.textContent = u;
							const btn = document.createElement('button');
							btn.className = 'tool-uuid-copy-btn';
							btn.type = 'button';
							btn.textContent = 'Copy';
							btn.addEventListener('click', (e) => toolCopy(u, e.currentTarget));
							row.append(val, btn);
							list.appendChild(row);
						});
						list._uuids = uuids;
					}
					document.getElementById('tool-uuid-gen')?.addEventListener('click', renderUUIDs);
					document.getElementById('tool-uuid-copy-all')?.addEventListener('click', (e) => {
						const list = document.getElementById('tool-uuid-list');
						const uuids = list?._uuids;
						if (uuids) toolCopy(uuids.join('\n'), e.currentTarget);
					});
					renderUUIDs();
				})();

				// ── JSON Formatter ────────────────────────────────────
				(function() {
					const inEl  = () => document.getElementById('tool-json-input');
					const outEl = () => document.getElementById('tool-json-output');
					const stEl  = () => document.getElementById('tool-json-status');

					function jsonStatus(msg, ok) {
						const el = stEl();
						if (!el) return;
						el.textContent = msg;
						el.className = 'tool-json-status ' + (ok ? 'ok' : 'err');
					}

					document.getElementById('tool-json-fmt')?.addEventListener('click', () => {
						try {
							const parsed = JSON.parse(inEl()?.value || '');
							const out = outEl();
							if (out) out.value = JSON.stringify(parsed, null, 2);
							jsonStatus('✓ Valid JSON', true);
						} catch (e) {
							jsonStatus('✗ ' + e.message, false);
							const out = outEl();
							if (out) out.value = '';
						}
					});
					document.getElementById('tool-json-min')?.addEventListener('click', () => {
						try {
							const parsed = JSON.parse(inEl()?.value || '');
							const out = outEl();
							if (out) out.value = JSON.stringify(parsed);
							jsonStatus('✓ Minified', true);
						} catch (e) {
							jsonStatus('✗ ' + e.message, false);
						}
					});
					document.getElementById('tool-json-copy')?.addEventListener('click', (e) => {
						const val = outEl()?.value;
						if (val) toolCopy(val, e.currentTarget);
					});
				})();

				// ── Unix Timestamp Converter ──────────────────────────
				(function() {
					function tsConvert(raw) {
						const resultsEl = document.getElementById('tool-ts-results');
						if (!resultsEl) return;
						resultsEl.innerHTML = '';
						if (!raw.trim()) return;

						let d = null;
						// Try as pure number (unix seconds or ms)
						const num = Number(raw.trim());
						if (!isNaN(num) && num > 0) {
							// Heuristic: if > 1e12 treat as milliseconds
							d = new Date(num > 1e12 ? num : num * 1000);
						} else {
							d = new Date(raw.trim());
						}

						if (isNaN(d?.getTime())) {
							const row = document.createElement('div');
							row.className = 'tool-ts-row';
							row.innerHTML = '<span class="tool-ts-label">Error</span><span class="tool-ts-val" style="color:#dc2626">Invalid date</span>';
							resultsEl.appendChild(row);
							return;
						}

						const rows = [
							['Unix (seconds)',  Math.floor(d.getTime() / 1000)],
							['Unix (ms)',        d.getTime()],
							['ISO 8601',         d.toISOString()],
							['Local date/time',  d.toLocaleString()],
							['UTC date/time',    d.toUTCString()],
							['Day of week',      d.toLocaleDateString(undefined, { weekday: 'long' })],
						];
						rows.forEach(([label, val]) => {
							const row = document.createElement('div');
							row.className = 'tool-ts-row';
							row.innerHTML = `<span class="tool-ts-label">${label}</span><span class="tool-ts-val">${val}</span>`;
							resultsEl.appendChild(row);
						});
					}

					document.getElementById('tool-ts-input')?.addEventListener('input', (e) => tsConvert(e.target.value));
					document.getElementById('tool-ts-now')?.addEventListener('click', () => {
						const inp = document.getElementById('tool-ts-input');
						if (inp) {
							inp.value = String(Math.floor(Date.now() / 1000));
							tsConvert(inp.value);
						}
					});
				})();

				// ════════════════════════════════════════════════════

				// ════════════════════════════════════════════════════
				// ── WORK PANEL ───────────────────────────────────────
				// ════════════════════════════════════════════════════

				// ── Ticket / Job Log ──────────────────────────────────
				(function() {
					const STORAGE_KEY = 'ectl_work_tickets';
					let tickets = [];
					try { tickets = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { tickets = []; }

					const STATUS_META = {
						open:    { label: '🔴 Open',              cls: 'work-badge-open' },
						inprog:  { label: '🟡 In Progress',        cls: 'work-badge-inprog' },
						waiting: { label: '🔵 Waiting on parts',   cls: 'work-badge-waiting' },
						done:    { label: '🟢 Done',               cls: 'work-badge-done' },
					};
					const TYPE_META = {
						diag:'Diagnostics', os:'OS/Software', hw:'Hardware', net:'Network',
						data:'Data Recovery', virus:'Virus/Malware', setup:'New Setup', other:'Other',
					};

					function saveTickets() {
						try { localStorage.setItem(STORAGE_KEY, JSON.stringify(tickets)); } catch { /* quota */ }
					}

					function renderTickets() {
						const listEl = document.getElementById('work-ticket-list');
						const countEl= document.getElementById('work-ticket-count');
						if (!listEl) return;
						listEl.innerHTML = '';
						if (countEl) countEl.textContent = tickets.length ? `${tickets.length} entr${tickets.length === 1 ? 'y' : 'ies'}` : '';
						if (tickets.length === 0) {
							listEl.innerHTML = '<p style="font-size:0.8rem;color:var(--muted);padding:6px 2px">No entries yet.</p>';
							return;
						}
						[...tickets].reverse().forEach((t, ri) => {
							const idx = tickets.length - 1 - ri;
							const row = document.createElement('div');
							row.className = 'work-ticket-row';
							const sm = STATUS_META[t.status] || STATUS_META.open;
							row.innerHTML = `
								<div class="work-ticket-row-meta">
									<div class="work-ticket-row-top">
										<span class="work-ticket-id">${escHtml(t.id || 'No ID')}</span>
										<span class="work-ticket-badge ${sm.cls}">${sm.label}</span>
										<span class="work-ticket-badge" style="background:var(--panel-border);color:var(--muted)">${escHtml(TYPE_META[t.type] || t.type)}</span>
									</div>
									${t.notes ? `<div class="work-ticket-notes-text">${escHtml(t.notes)}</div>` : ''}
								</div>
								<span class="work-ticket-date">${new Date(t.created).toLocaleString(undefined,{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span>
								<button class="work-ticket-del" data-idx="${idx}" type="button" title="Delete entry">✕</button>
							`;
							listEl.appendChild(row);
						});
						listEl.querySelectorAll('.work-ticket-del').forEach(btn => {
							btn.addEventListener('click', () => {
								tickets.splice(parseInt(btn.dataset.idx, 10), 1);
								saveTickets();
								renderTickets();
							});
						});
					}

					document.getElementById('btn-work-ticket-add')?.addEventListener('click', () => {
						const idEl    = document.getElementById('work-ticket-id');
						const statusEl= document.getElementById('work-ticket-status');
						const typeEl  = document.getElementById('work-ticket-type');
						const notesEl = document.getElementById('work-ticket-notes');
						const entry = {
							id:      (idEl?.value || '').trim() || 'Untitled',
							status:  statusEl?.value || 'open',
							type:    typeEl?.value   || 'other',
							notes:   (notesEl?.value || '').trim(),
							created: new Date().toISOString(),
						};
						tickets.push(entry);
						saveTickets();
						renderTickets();
						if (idEl)    idEl.value    = '';
						if (notesEl) notesEl.value = '';
					});

					document.getElementById('btn-work-ticket-export')?.addEventListener('click', () => {
						if (!tickets.length) return;
						const header = 'ID,Status,Type,Notes,Created\n';
						const rows = tickets.map(t =>
							[t.id, t.status, t.type, `"${(t.notes||'').replace(/"/g,'""')}"`, t.created].join(',')
						).join('\n');
						const blob = new Blob([header + rows], { type: 'text/csv' });
						const a = document.createElement('a');
						a.href = URL.createObjectURL(blob);
						a.download = `tickets-${new Date().toISOString().slice(0,10)}.csv`;
						a.click();
						setTimeout(() => URL.revokeObjectURL(a.href), 10000);
					});

					renderTickets();
				})();

				// ── Network Toolkit ───────────────────────────────────
				(function() {
					// Subnet calculator
					function ipToInt(ip) {
						const parts = ip.split('.').map(Number);
						if (parts.length !== 4 || parts.some(p => isNaN(p) || p < 0 || p > 255)) return null;
						return (parts[0] << 24 | parts[1] << 16 | parts[2] << 8 | parts[3]) >>> 0;
					}
					function intToIp(n) {
						return [(n >>> 24) & 255, (n >>> 16) & 255, (n >>> 8) & 255, n & 255].join('.');
					}
					function calcSubnet() {
						const ipRaw   = (document.getElementById('work-subnet-ip')?.value || '').trim();
						const cidrRaw = (document.getElementById('work-subnet-cidr')?.value || '').trim();
						const resultsEl = document.getElementById('work-subnet-results');
						if (!resultsEl) return;
						const cidr = parseInt(cidrRaw, 10);
						if (!ipRaw || isNaN(cidr) || cidr < 0 || cidr > 32) {
							resultsEl.innerHTML = '<span style="color:#dc2626;font-size:0.8rem">Enter a valid IP and CIDR (0–32)</span>';
							return;
						}
						const ipInt   = ipToInt(ipRaw);
						if (ipInt === null) { resultsEl.innerHTML = '<span style="color:#dc2626;font-size:0.8rem">Invalid IP address</span>'; return; }
						const mask    = cidr === 0 ? 0 : (0xFFFFFFFF << (32 - cidr)) >>> 0;
						const network = (ipInt & mask) >>> 0;
						const bcast   = (network | (~mask >>> 0)) >>> 0;
						const first   = cidr >= 31 ? network : network + 1;
						const last    = cidr >= 31 ? bcast   : bcast  - 1;
						const total   = cidr >= 32 ? 1 : cidr >= 31 ? 2 : Math.pow(2, 32 - cidr) - 2;
						const rows = [
							['Network',           `${intToIp(network)}/${cidr}`],
							['Subnet mask',        intToIp(mask)],
							['Broadcast',          intToIp(bcast)],
							['First usable host',  first <= last ? intToIp(first) : 'N/A'],
							['Last usable host',   first <= last ? intToIp(last)  : 'N/A'],
							['Usable hosts',       total.toLocaleString()],
							['Wildcard mask',      intToIp(~mask >>> 0)],
						];
						resultsEl.innerHTML = rows.map(([label, val]) =>
							`<div class="work-subnet-row"><span class="work-subnet-label">${label}</span><span class="work-subnet-val">${val}</span></div>`
						).join('');
					}
					document.getElementById('btn-work-subnet-calc')?.addEventListener('click', calcSubnet);
					document.getElementById('work-subnet-cidr')?.addEventListener('keydown', e => { if (e.key === 'Enter') calcSubnet(); });
					document.getElementById('work-subnet-ip')?.addEventListener('keydown', e => { if (e.key === 'Enter') calcSubnet(); });

					// Common ports
					const PORTS = [
						[20,  'FTP data'],  [21, 'FTP control'], [22, 'SSH'],
						[23, 'Telnet'], [25, 'SMTP'], [53, 'DNS'],
						[67, 'DHCP server'], [68, 'DHCP client'], [80, 'HTTP'],
						[110, 'POP3'], [123, 'NTP'], [143, 'IMAP'],
						[161, 'SNMP'], [389, 'LDAP'], [443, 'HTTPS'],
						[445, 'SMB/CIFS'], [3389, 'RDP'], [3306, 'MySQL'],
						[5900, 'VNC'], [8080, 'HTTP alt'], [8443, 'HTTPS alt'],
					];
					const portsGrid = document.getElementById('work-ports-grid');
					if (portsGrid) {
						portsGrid.innerHTML = PORTS.map(([port, desc]) =>
							`<div class="work-port-chip"><span class="work-port-num">${port}</span><span class="work-port-desc">${desc}</span></div>`
						).join('');
					}

					// Private IP ranges
					const IP_RANGES = [
						['10.0.0.0 – 10.255.255.255',     '/8  (Class A)'],
						['172.16.0.0 – 172.31.255.255',   '/12 (Class B)'],
						['192.168.0.0 – 192.168.255.255', '/16 (Class C)'],
						['169.254.0.0 – 169.254.255.255', 'APIPA / link-local'],
						['127.0.0.0 – 127.255.255.255',   'Loopback'],
					];
					const rangesEl = document.getElementById('work-ip-ranges');
					if (rangesEl) {
						rangesEl.innerHTML = IP_RANGES.map(([range, desc]) =>
							`<div class="work-ip-row"><span class="work-ip-range">${range}</span><span class="work-ip-desc">${desc}</span></div>`
						).join('');
					}
				})();

				// ── Repair Checklist ──────────────────────────────────
				(function() {
					const CHECKLISTS = {
						general: [
							{ cat:'Intake',   text:'Record client name, device model, serial number' },
							{ cat:'Intake',   text:'Document reported symptoms in writing' },
							{ cat:'Intake',   text:'Agree on data backup responsibility with client' },
							{ cat:'Diagnose', text:'Run POST and check for beep codes / LED errors' },
							{ cat:'Diagnose', text:'Check Device Manager for driver/hardware errors' },
							{ cat:'Diagnose', text:'Run SMART test on storage drive' },
							{ cat:'Diagnose', text:'Test RAM with MemTest86 or Windows Memory Diagnostic' },
							{ cat:'Diagnose', text:'Check CPU & GPU temps under load (HWMonitor)' },
							{ cat:'Diagnose', text:'Inspect capacitors, fans, and connectors visually' },
							{ cat:'Software', text:'Check for Windows / driver updates' },
							{ cat:'Software', text:'Run SFC /scannow and DISM to repair system files' },
							{ cat:'Software', text:'Scan for malware (Malwarebytes, Windows Defender)' },
							{ cat:'Cleanup',  text:'Clean dust from vents, fans, and heatsinks' },
							{ cat:'Cleanup',  text:'Re-seat RAM and GPU if applicable' },
							{ cat:'Handoff',  text:'Document all work performed' },
							{ cat:'Handoff',  text:'Test with client before closing ticket' },
						],
						virus: [
							{ cat:'Isolate',  text:'Disconnect from network immediately' },
							{ cat:'Isolate',  text:'Back up uninfected user files if safe to do so' },
							{ cat:'Scan',     text:'Boot into Safe Mode with Networking' },
							{ cat:'Scan',     text:'Run Malwarebytes full scan' },
							{ cat:'Scan',     text:'Run Windows Defender Offline Scan' },
							{ cat:'Scan',     text:'Run AdwCleaner for adware / PUPs' },
							{ cat:'Scan',     text:'Check startup items via Task Manager / Autoruns' },
							{ cat:'Scan',     text:'Inspect browser extensions for hijackers' },
							{ cat:'Cleanup',  text:'Remove all flagged items' },
							{ cat:'Cleanup',  text:'Clear browser caches and stored passwords' },
							{ cat:'Cleanup',  text:'Reset DNS settings if hijacked' },
							{ cat:'Verify',   text:'Re-run scans after cleanup — confirm clean' },
							{ cat:'Handoff',  text:'Educate client on safe browsing / phishing' },
						],
						os: [
							{ cat:'Prep',     text:'Back up all client data to external drive' },
							{ cat:'Prep',     text:'Note all software licences and activation keys' },
							{ cat:'Prep',     text:'Create Windows installation media (Rufus + ISO)' },
							{ cat:'Install',  text:'Set BIOS to boot from USB' },
							{ cat:'Install',  text:'Wipe and format drive (clean install)' },
							{ cat:'Install',  text:'Install Windows and complete OOBE setup' },
							{ cat:'Drivers',  text:'Install motherboard / chipset drivers' },
							{ cat:'Drivers',  text:'Install GPU, audio, and network drivers' },
							{ cat:'Drivers',  text:'Run Windows Update until fully current' },
							{ cat:'Software', text:'Install antivirus and configure' },
							{ cat:'Software', text:'Restore client data and reinstall apps' },
							{ cat:'Handoff',  text:'Confirm activation — check Settings > Activation' },
						],
						laptop: [
							{ cat:'Safety',   text:'Power off fully — remove battery if possible' },
							{ cat:'Safety',   text:'Ground yourself — use ESD mat/wrist strap' },
							{ cat:'Disassem', text:'Photograph screw positions before removal' },
							{ cat:'Disassem', text:'Document cable routing and connector types' },
							{ cat:'Inspect',  text:'Inspect for liquid damage or burnt components' },
							{ cat:'Inspect',  text:'Check screen hinges, connector, and backlight' },
							{ cat:'Inspect',  text:'Test keyboard and trackpad individually' },
							{ cat:'Thermal',  text:'Clean heatsink and fans' },
							{ cat:'Thermal',  text:'Replace thermal paste on CPU / GPU die' },
							{ cat:'Reassem',  text:'Re-seat all connectors and cables firmly' },
							{ cat:'Test',     text:'Power on before full reassembly — verify fix' },
							{ cat:'Handoff',  text:'Stress test at full load for 30 minutes' },
						],
						network: [
							{ cat:'Identify', text:'Confirm scope — one device or entire network?' },
							{ cat:'Identify', text:'Check physical cables and indicator lights' },
							{ cat:'Identify', text:'Reboot modem → router → device in sequence' },
							{ cat:'Diagnose', text:'Run ipconfig /all — check IP, gateway, DNS' },
							{ cat:'Diagnose', text:'Ping 127.0.0.1 — test loopback' },
							{ cat:'Diagnose', text:'Ping gateway — test local network' },
							{ cat:'Diagnose', text:'Ping 8.8.8.8 — test internet connectivity' },
							{ cat:'Diagnose', text:'nslookup google.com — test DNS resolution' },
							{ cat:'Diagnose', text:'Tracert to identify where packets are dropping' },
							{ cat:'Fix',      text:'Update network adapter driver' },
							{ cat:'Fix',      text:'Reset TCP/IP stack: netsh int ip reset' },
							{ cat:'Fix',      text:'Flush DNS: ipconfig /flushdns' },
							{ cat:'Fix',      text:'Check firewall / antivirus blocking' },
							{ cat:'Handoff',  text:'Document final IP config and test all devices' },
						],
						data: [
							{ cat:'Assess',   text:'Determine failure type: logical or physical?' },
							{ cat:'Assess',   text:'Run SMART test — note reallocated sectors' },
							{ cat:'Assess',   text:'Do NOT write to a failing drive unnecessarily' },
							{ cat:'Image',    text:'Clone failing drive with Clonezilla or ddrescue first' },
							{ cat:'Image',    text:'Work from the clone, not the original' },
							{ cat:'Recovery', text:'Use Recuva or PhotoRec for deleted files' },
							{ cat:'Recovery', text:'Use TestDisk for lost partitions' },
							{ cat:'Recovery', text:'Mount read-only where possible' },
							{ cat:'Handoff',  text:'Give client recovered files on new drive / USB' },
							{ cat:'Handoff',  text:'Recommend backup solution (cloud + external)' },
						],
					};

					let _checkState = [];

					function loadChecklist() {
						const type = document.getElementById('work-checklist-type')?.value || 'general';
						const items = CHECKLISTS[type] || [];
						_checkState = items.map(() => false);
						renderChecklist(items);
					}

					function renderChecklist(items) {
						const el = document.getElementById('work-checklist');
						if (!el) return;
						el.innerHTML = '';
						if (!items || items.length === 0) { el.innerHTML = '<p style="font-size:0.8rem;color:var(--muted)">No checklist loaded.</p>'; return; }
						items.forEach((item, i) => {
							const div = document.createElement('div');
							div.className = 'work-check-item' + (_checkState[i] ? ' done' : '');
							div.innerHTML = `
								<input type="checkbox" ${_checkState[i] ? 'checked' : ''} id="wchk-${i}" />
								<label class="work-check-text" for="wchk-${i}">${escHtml(item.text)}</label>
								<span class="work-check-cat">${escHtml(item.cat)}</span>
							`;
							div.querySelector('input')?.addEventListener('change', (e) => {
								_checkState[i] = e.target.checked;
								div.classList.toggle('done', _checkState[i]);
							});
							el.appendChild(div);
						});
					}

					document.getElementById('btn-work-checklist-load')?.addEventListener('click', loadChecklist);
					document.getElementById('btn-work-checklist-reset')?.addEventListener('click', () => {
						_checkState = _checkState.map(() => false);
						const type = document.getElementById('work-checklist-type')?.value || 'general';
						renderChecklist(CHECKLISTS[type] || []);
					});
					document.getElementById('btn-work-checklist-copy')?.addEventListener('click', (e) => {
						const type = document.getElementById('work-checklist-type')?.value || 'general';
						const items = CHECKLISTS[type] || [];
						const text = items.map((item, i) => `[${_checkState[i] ? 'x' : ' '}] [${item.cat}] ${item.text}`).join('\n');
						toolCopy(text, e.currentTarget);
					});
					loadChecklist();
				})();

				// ── Storage / RAM Converter ───────────────────────────
				(function() {
					const UNITS = {
						B:   1,
						KB:  1e3,        MB:  1e6,        GB:  1e9,        TB:  1e12,
						KiB: 1024,       MiB: 1024**2,    GiB: 1024**3,    TiB: 1024**4,
					};
					const ALL_UNITS = ['B','KB','KiB','MB','MiB','GB','GiB','TB','TiB'];

					function convert() {
						const val   = parseFloat(document.getElementById('work-storage-val')?.value);
						const from  = document.getElementById('work-storage-from')?.value || 'MB';
						const resEl = document.getElementById('work-storage-results');
						if (!resEl) return;
						if (isNaN(val) || val < 0) { resEl.innerHTML = ''; return; }
						const bytes = val * (UNITS[from] || 1);
						resEl.innerHTML = ALL_UNITS.map(unit => {
							const converted = bytes / (UNITS[unit] || 1);
							const display   = converted >= 1000 ? converted.toLocaleString(undefined, { maximumFractionDigits: 2 })
							                : converted < 0.0001 ? converted.toExponential(2)
							                : +converted.toPrecision(6);
							return `<div class="work-storage-chip">
								<div class="work-storage-chip-unit">${unit}</div>
								<div class="work-storage-chip-val">${display}</div>
							</div>`;
						}).join('');
					}

					document.getElementById('work-storage-val')?.addEventListener('input', convert);
					document.getElementById('work-storage-from')?.addEventListener('change', convert);
				})();

				// ── Windows / CMD Quick Reference ─────────────────────
				(function() {
					const CMDS = [
						// Networking
						{ cmd:'ipconfig /all',              desc:'Show full IP configuration',           tag:'Net' },
						{ cmd:'ipconfig /flushdns',         desc:'Flush DNS resolver cache',             tag:'Net' },
						{ cmd:'ipconfig /release && ipconfig /renew', desc:'Release & renew DHCP lease', tag:'Net' },
						{ cmd:'netsh int ip reset',         desc:'Reset TCP/IP stack',                   tag:'Net' },
						{ cmd:'netsh winsock reset',        desc:'Reset Winsock catalogue',              tag:'Net' },
						{ cmd:'ping -t 8.8.8.8',            desc:'Continuous ping to Google DNS',        tag:'Net' },
						{ cmd:'tracert google.com',         desc:'Trace route to host',                  tag:'Net' },
						{ cmd:'nslookup google.com',        desc:'DNS lookup for a hostname',            tag:'Net' },
						{ cmd:'netstat -ano',               desc:'Show all active connections + PIDs',   tag:'Net' },
						{ cmd:'arp -a',                     desc:'Show ARP table (IP ↔ MAC)',            tag:'Net' },
						// Disk
						{ cmd:'chkdsk C: /f /r',            desc:'Check disk for errors and bad sectors',tag:'Disk' },
						{ cmd:'sfc /scannow',               desc:'Scan & repair protected system files', tag:'Disk' },
						{ cmd:'DISM /Online /Cleanup-Image /RestoreHealth', desc:'Repair Windows image', tag:'Disk' },
						{ cmd:'diskpart',                   desc:'Open disk partition tool (CLI)',        tag:'Disk' },
						{ cmd:'diskmgmt.msc',               desc:'Open Disk Management GUI',             tag:'Disk' },
						{ cmd:'wmic diskdrive get status',  desc:'Quick SMART status of all drives',     tag:'Disk' },
						// System info
						{ cmd:'msinfo32',                   desc:'Full system information window',       tag:'Info' },
						{ cmd:'winver',                     desc:'Show Windows version dialog',          tag:'Info' },
						{ cmd:'systeminfo',                 desc:'Detailed OS and hardware info',        tag:'Info' },
						{ cmd:'dxdiag',                     desc:'DirectX diagnostics (GPU, sound)',     tag:'Info' },
						{ cmd:'wmic cpu get name',          desc:'Show CPU model name',                  tag:'Info' },
						{ cmd:'wmic memorychip get capacity,speed', desc:'Show RAM sticks capacity & speed', tag:'Info' },
						{ cmd:'wmic bios get serialnumber', desc:'Get system serial number',             tag:'Info' },
						// Startup / services
						{ cmd:'msconfig',                   desc:'System configuration & startup items', tag:'Boot' },
						{ cmd:'services.msc',               desc:'Open Services manager',                tag:'Boot' },
						{ cmd:'taskmgr',                    desc:'Open Task Manager',                    tag:'Boot' },
						{ cmd:'shell:startup',              desc:'Open user Startup folder',             tag:'Boot' },
						{ cmd:'sc query type= all',         desc:'List all services and drivers',        tag:'Boot' },
						// User / security
						{ cmd:'net user',                   desc:'List local user accounts',             tag:'User' },
						{ cmd:'net user USERNAME /active:yes', desc:'Enable a disabled user account',   tag:'User' },
						{ cmd:'lusrmgr.msc',                desc:'Local Users and Groups manager',       tag:'User' },
						{ cmd:'gpupdate /force',            desc:'Force Group Policy refresh',           tag:'User' },
						{ cmd:'eventvwr',                   desc:'Open Event Viewer for error logs',     tag:'Log' },
						// Remote
						{ cmd:'mstsc',                      desc:'Open Remote Desktop Connection',       tag:'Remote' },
						{ cmd:'mstsc /v:IP_ADDRESS',        desc:'RDP to a specific IP address',         tag:'Remote' },
						{ cmd:'psexec \\\\PC cmd',          desc:'Run remote command (PSTools)',         tag:'Remote' },
						// Power
						{ cmd:'powercfg /batteryreport',    desc:'Generate battery health report',       tag:'Power' },
						{ cmd:'powercfg /energy',           desc:'Run 60s power efficiency trace',       tag:'Power' },
						{ cmd:'shutdown /r /f /t 0',        desc:'Force immediate restart',              tag:'Power' },
					];

					let _filteredCmds = [...CMDS];

					function renderCmds() {
						const el = document.getElementById('work-cmd-grid');
						if (!el) return;
						el.innerHTML = '';
						_filteredCmds.forEach(c => {
							const row = document.createElement('div');
							row.className = 'work-cmd-row';
							row.title = 'Click to copy command';
							row.innerHTML = `<span class="work-cmd-cmd">${escHtml(c.cmd)}</span><span class="work-cmd-desc">${escHtml(c.desc)}</span><span class="work-cmd-tag">${c.tag}</span>`;
							row.addEventListener('click', () => toolCopy(c.cmd, null));
							el.appendChild(row);
						});
					}

					document.getElementById('work-cmd-search')?.addEventListener('input', (e) => {
						const q = e.target.value.toLowerCase();
						_filteredCmds = q ? CMDS.filter(c => c.cmd.toLowerCase().includes(q) || c.desc.toLowerCase().includes(q) || c.tag.toLowerCase().includes(q)) : [...CMDS];
						renderCmds();
					});

					renderCmds();
				})();

				// ── Chromebook / ChromeOS Quick Reference ────────────
				(function() {
					const CROSH = [
						// Crosh shell (Ctrl+Alt+T)
						{ cmd:'ping google.com',                  desc:'Test internet connectivity',              tag:'Network' },
						{ cmd:'tracepath google.com',             desc:'Trace network route to host',             tag:'Network' },
						{ cmd:'connectivity',                     desc:'Show network connectivity status',        tag:'Network' },
						{ cmd:'connectivity show-portals',        desc:'Show captive portal info',                tag:'Network' },
						{ cmd:'ipaddrs',                          desc:'Show all IP addresses',                   tag:'Network' },
						{ cmd:'route print',                      desc:'Show routing table',                      tag:'Network' },
						{ cmd:'network_diag --http https://google.com', desc:'Run full network diagnostics',      tag:'Network' },
						{ cmd:'ssh [user@host]',                  desc:'SSH into another machine',                tag:'Network' },
						// System info (crosh)
						{ cmd:'help',                             desc:'List all available crosh commands',       tag:'Crosh' },
						{ cmd:'help_advanced',                    desc:'List advanced crosh commands',            tag:'Crosh' },
						{ cmd:'battery_test [secs]',              desc:'Run battery discharge test',              tag:'Crosh' },
						{ cmd:'battery_firmware check',           desc:'Check battery firmware status',           tag:'Crosh' },
						{ cmd:'memory_test',                      desc:'Run a quick memory test',                 tag:'Crosh' },
						{ cmd:'storage_test_1',                   desc:'Quick read-speed storage test',           tag:'Crosh' },
						{ cmd:'storage_test_2',                   desc:'Extended storage test (slow)',            tag:'Crosh' },
						{ cmd:'top',                              desc:'Live process/CPU/RAM monitor',            tag:'Crosh' },
						{ cmd:'free',                             desc:'Show memory usage',                       tag:'Crosh' },
						{ cmd:'uname -a',                         desc:'Show kernel / ChromeOS version info',     tag:'Crosh' },
						{ cmd:'cat /etc/lsb-release',             desc:'Show ChromeOS build details',             tag:'Crosh' },
						{ cmd:'vmc list',                         desc:'List Linux VMs (Crostini)',               tag:'Crosh' },
						{ cmd:'vmc start termina',                desc:'Start the Linux VM',                      tag:'Crosh' },
						{ cmd:'rollback',                         desc:'Roll back to previous OS version',        tag:'Crosh' },
						// Keyboard shortcuts
						{ cmd:'Ctrl + Alt + T',                   desc:'Open crosh terminal',                     tag:'Shortcut' },
						{ cmd:'Alt + [',                          desc:'Dock window to the left',                 tag:'Shortcut' },
						{ cmd:'Alt + ]',                          desc:'Dock window to the right',                tag:'Shortcut' },
						{ cmd:'Ctrl + Shift + L',                 desc:'Lock the screen',                         tag:'Shortcut' },
						{ cmd:'Ctrl + Alt + Z',                   desc:'Toggle accessibility features',           tag:'Shortcut' },
						{ cmd:'Ctrl + Shift + Q (x2)',            desc:'Sign out of account',                     tag:'Shortcut' },
						{ cmd:'Alt + E',                          desc:'Open Files app',                          tag:'Shortcut' },
						{ cmd:'Ctrl + Shift + I',                 desc:'Open Chrome DevTools',                    tag:'Shortcut' },
						{ cmd:'Ctrl + Shift + N',                 desc:'Open Incognito window',                   tag:'Shortcut' },
						{ cmd:'Esc (held)',                       desc:'Open Task Manager',                       tag:'Shortcut' },
						{ cmd:'Power + Vol Down',                 desc:'Take a screenshot',                       tag:'Shortcut' },
						{ cmd:'Ctrl + Show Windows key',          desc:'Take a full screenshot',                  tag:'Shortcut' },
						{ cmd:'Ctrl + Shift + Show Windows key',  desc:'Take a partial screenshot',               tag:'Shortcut' },
						// Recovery / maintenance
						{ cmd:'chrome://system',                  desc:'Full system diagnostic info page',        tag:'Chrome' },
						{ cmd:'chrome://net-internals',           desc:'Network internals & DNS flush',           tag:'Chrome' },
						{ cmd:'chrome://net-internals/#dns',      desc:'Flush DNS cache',                         tag:'Chrome' },
						{ cmd:'chrome://flags',                   desc:'Experimental Chrome features',            tag:'Chrome' },
						{ cmd:'chrome://memory-internals',        desc:'Detailed memory usage by tab',            tag:'Chrome' },
						{ cmd:'chrome://gpu',                     desc:'GPU info and hardware acceleration',      tag:'Chrome' },
						{ cmd:'chrome://extensions',              desc:'Manage installed extensions',             tag:'Chrome' },
						{ cmd:'chrome://policy',                  desc:'View enforced MDM / admin policies',      tag:'Chrome' },
						{ cmd:'chrome://device-log',              desc:'Low-level device event log',              tag:'Chrome' },
						{ cmd:'chrome://bluetooth-internals',     desc:'Bluetooth device diagnostics',            tag:'Chrome' },
						// Powerwash / recovery
						{ cmd:'Ctrl + Alt + Shift + R',           desc:'Powerwash (factory reset) dialog',        tag:'Reset' },
						{ cmd:'Esc + Refresh + Power',            desc:'Enter Recovery Mode',                     tag:'Reset' },
						{ cmd:'Ctrl + D (in Recovery)',           desc:'Enable Developer Mode',                   tag:'Reset' },
						{ cmd:'Space (in Recovery)',              desc:'Return to Verified Mode',                 tag:'Reset' },
					];

					let _filteredCrosh = [...CROSH];

					function renderCrosh() {
						const el = document.getElementById('work-crosh-grid');
						if (!el) return;
						el.innerHTML = '';
						_filteredCrosh.forEach(c => {
							const row = document.createElement('div');
							row.className = 'work-cmd-row';
							row.title = 'Click to copy';
							row.innerHTML = `<span class="work-cmd-cmd">${escHtml(c.cmd)}</span><span class="work-cmd-desc">${escHtml(c.desc)}</span><span class="work-cmd-tag">${escHtml(c.tag)}</span>`;
							row.addEventListener('click', () => toolCopy(c.cmd, null));
							el.appendChild(row);
						});
					}

					document.getElementById('work-crosh-search')?.addEventListener('input', (e) => {
						const q = e.target.value.toLowerCase();
						_filteredCrosh = q
							? CROSH.filter(c => c.cmd.toLowerCase().includes(q) || c.desc.toLowerCase().includes(q) || c.tag.toLowerCase().includes(q))
							: [...CROSH];
						renderCrosh();
					});

					renderCrosh();
				})();

				// ── Client Report Generator (panel-reports) ──────────
					(function() {
						const SAVED_KEY      = 'ectl_rpt_saved_clients';
						const SAVED_TECH_KEY = 'ectl_rpt_saved_techs';
						
						function pad(label, value, width) {
							return label.padEnd(width) + ': ' + value;
						}
						function bulletLines(raw) {
							if (!raw || raw.trim() === '' || raw.trim() === 'N/A') return '  N/A';
							return raw.split('\n').map(l => l.trim()).filter(Boolean).map(l => `  • ${l}`).join('\n');
						}
						function refNumber() {
							const n = Math.floor(1000 + Math.random() * 9000);
							return `QBS-${n}`;
						}

						// ── Clients ─────────────────────────────────────────
						function getSaved() {
							try { return JSON.parse(localStorage.getItem(SAVED_KEY) || '[]'); } catch { return []; }
						}
						function putSaved(arr) {
							try { localStorage.setItem(SAVED_KEY, JSON.stringify(arr)); } catch {}
							pushContactsToCloud();
						}
						function renderSavedClients() {
							const saved = getSaved();
							const sel   = document.getElementById('rpt-client-select');
							if (!sel) return;
							const cur = sel.value;
							sel.innerHTML = '<option value="">— Select a saved client —</option>';
							saved.forEach((c, i) => {
								const opt = document.createElement('option');
								opt.value = i;
								opt.textContent = c.client + (c.city ? ' — ' + c.city : '');
								opt.title = [c.email, c.phone].filter(Boolean).join(' | ') || '';
								sel.appendChild(opt);
							});
							if (cur !== '' && sel.options[parseInt(cur, 10) + 1]) sel.value = cur;
						}
						function loadClient(c) {
							const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
							set('rpt-client', c.client);
							set('rpt-email',  c.email);
							set('rpt-phone',  c.phone);
							set('rpt-street', c.street);
							set('rpt-postal', c.postal);
							set('rpt-city',   c.city);
							set('rpt-device', c.device);
							set('rpt-serial', c.serial);
							// clear job-specific fields
							set('rpt-issue',           '');
							set('rpt-findings',        '');
							set('rpt-recommendations', '');
							const outEl   = document.getElementById('rpt-output');
							const copyBtn = document.getElementById('btn-rpt-copy');
							const clrBtn  = document.getElementById('btn-rpt-clear');
							if (outEl)   { outEl.style.display = 'none'; outEl.value = ''; }
							if (copyBtn) copyBtn.style.display = 'none';
							if (clrBtn)  clrBtn.style.display  = 'none';
						}
						function saveClientIfNew() {
							const get = id => (document.getElementById(id)?.value || '').trim();
							const entry = {
								client: get('rpt-client'),
								email:  get('rpt-email'),
								phone:  get('rpt-phone'),
								street: get('rpt-street'),
								postal: get('rpt-postal'),
								city:   get('rpt-city'),
								device: get('rpt-device'),
								serial: get('rpt-serial'),
							};
							if (!entry.client) return;
							const arr = getSaved();
							const idx = arr.findIndex(c => c.client.toLowerCase() === entry.client.toLowerCase());
							if (idx === -1) { arr.unshift(entry); if (arr.length > 20) arr.length = 20; }
							else { arr[idx] = { ...arr[idx], ...entry }; }
							putSaved(arr);
							renderSavedClients();
						}

						// ── Technicians ──────────────────────────────────────
						function getSavedTechs() {
							try { return JSON.parse(localStorage.getItem(SAVED_TECH_KEY) || '[]'); } catch { return []; }
						}
						function putSavedTechs(arr) {
							try { localStorage.setItem(SAVED_TECH_KEY, JSON.stringify(arr)); } catch {}
							pushContactsToCloud();
						}
						function renderSavedTechs() {
							const saved = getSavedTechs();
							const sel   = document.getElementById('rpt-tech-select');
							if (!sel) return;
							const cur = sel.value;
							sel.innerHTML = '<option value="">— Select a saved technician —</option>';
							saved.forEach((t, i) => {
								const opt = document.createElement('option');
								opt.value = i;
								opt.textContent = t.tech + (t.techCity ? ' — ' + t.techCity : '');
								opt.title = [t.techEmail, t.techPhone].filter(Boolean).join(' | ') || '';
								sel.appendChild(opt);
							});
							if (cur !== '' && sel.options[parseInt(cur, 10) + 1]) sel.value = cur;
						}
						function loadTech(t) {
							const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
							set('rpt-tech',        t.tech);
							set('rpt-tech-email',  t.techEmail);
							set('rpt-tech-phone',  t.techPhone);
							set('rpt-tech-street', t.techStreet);
							set('rpt-tech-postal', t.techPostal);
							set('rpt-tech-city',   t.techCity);
						}
						function saveTechIfNew() {
							const get = id => (document.getElementById(id)?.value || '').trim();
							const entry = {
								tech:       get('rpt-tech'),
								techEmail:  get('rpt-tech-email'),
								techPhone:  get('rpt-tech-phone'),
								techStreet: get('rpt-tech-street'),
								techPostal: get('rpt-tech-postal'),
								techCity:   get('rpt-tech-city'),
							};
							if (!entry.tech) return;
							const arr = getSavedTechs();
							const idx = arr.findIndex(t => t.tech.toLowerCase() === entry.tech.toLowerCase());
							if (idx === -1) { arr.unshift(entry); if (arr.length > 20) arr.length = 20; }
							else { arr[idx] = { ...arr[idx], ...entry }; }
							putSavedTechs(arr);
							renderSavedTechs();
						}

						// ── Cloud sync for contacts ──────────────────────────────
						async function pushContactsToCloud() {
							if (!activeUserId || !activeAccessToken) return;
							try {
								const getUrl = `${SUPABASE_URL}/rest/v1/preferences?select=prefs&user_id=eq.${encodeURIComponent(activeUserId)}&limit=1`;
								const getRes = await fetch(getUrl, {
									headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${activeAccessToken}`, Accept: 'application/json' },
								});
								const rows = getRes.ok ? await getRes.json() : [];
								const existing = (Array.isArray(rows) && rows[0]?.prefs) ? rows[0].prefs : {};
								const merged = { ...existing, rpt_clients: getSaved(), rpt_techs: getSavedTechs() };
								await fetch(`${SUPABASE_URL}/rest/v1/preferences?on_conflict=user_id`, {
									method: 'POST',
									headers: {
										apikey: SUPABASE_ANON_KEY,
										Authorization: `Bearer ${activeAccessToken}`,
										'Content-Type': 'application/json',
										Prefer: 'resolution=merge-duplicates',
										Accept: 'application/json',
									},
									body: JSON.stringify([{ user_id: activeUserId, prefs: merged }]),
								});
							} catch { /* silent — localStorage still has data */ }
						}

						async function loadContactsFromCloud() {
							if (!activeUserId || !activeAccessToken) return;
							try {
								const url = `${SUPABASE_URL}/rest/v1/preferences?select=prefs&user_id=eq.${encodeURIComponent(activeUserId)}&limit=1`;
								const res = await fetch(url, {
									headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${activeAccessToken}`, Accept: 'application/json' },
								});
								if (!res.ok) return;
								const rows = await res.json();
								const prefs = Array.isArray(rows) && rows[0]?.prefs ? rows[0].prefs : null;
								if (!prefs) return;
								if (Array.isArray(prefs.rpt_clients)) {
									try { localStorage.setItem(SAVED_KEY, JSON.stringify(prefs.rpt_clients)); } catch {}
									renderSavedClients();
								}
								if (Array.isArray(prefs.rpt_techs)) {
									try { localStorage.setItem(SAVED_TECH_KEY, JSON.stringify(prefs.rpt_techs)); } catch {}
									renderSavedTechs();
								}
							} catch { /* silent */ }
						}

						window._loadRptContacts = loadContactsFromCloud;

						// ── Jira paste import ────────────────────────────────
					document.getElementById('btn-rpt-jira-toggle')?.addEventListener('click', () => {
						const panel = document.getElementById('rpt-jira-panel');
						if (panel) { panel.style.display = panel.style.display === 'none' ? '' : 'none'; }
					});
					document.getElementById('btn-rpt-jira-cancel')?.addEventListener('click', () => {
						const panel = document.getElementById('rpt-jira-panel');
						if (panel) panel.style.display = 'none';
						const ta = document.getElementById('rpt-jira-paste');
						if (ta) ta.value = '';
						const fb = document.getElementById('rpt-jira-feedback');
						if (fb) fb.textContent = '';
					});

					document.getElementById('btn-rpt-jira-import')?.addEventListener('click', () => {
						const raw  = (document.getElementById('rpt-jira-paste')?.value || '').trim();
						const fb   = document.getElementById('rpt-jira-feedback');
						if (!raw) { if (fb) fb.textContent = '⚠ Nothing pasted yet.'; return; }

						const set = (id, val) => { if (!val) return; const el = document.getElementById(id); if (el) el.value = val; };
						const find = (patterns) => {
							for (const p of patterns) {
								const m = raw.match(p);
								if (m && m[1] && m[1].trim()) return m[1].trim();
							}
							return '';
						};

						// ── Field extraction heuristics ──────────────────
						// Summary / title — often first bold line, or after "Summary"
						const summary = find([
							/Summary\s*[:\-]?\s*(.+)/i,
							/^([^\n]{10,120})/m,   // fallback: first substantial line
						]);

						// Reporter / customer
						const reporter = find([
							/Reporter\s*[:\-]?\s*([^\n]+)/i,
							/Raised by\s*[:\-]?\s*([^\n]+)/i,
							/Customer\s*[:\-]?\s*([^\n]+)/i,
						]);

						// Assignee / technician
						const assignee = find([
							/Assignee\s*[:\-]?\s*([^\n]+)/i,
							/Assigned to\s*[:\-]?\s*([^\n]+)/i,
						]);

						// Issue type → repair type
						const issueType = find([
							/Issue Type\s*[:\-]?\s*([^\n]+)/i,
							/Type\s*[:\-]?\s*([^\n]+)/i,
						]);

						// Status
						const status = find([
							/Status\s*[:\-]?\s*([^\n]+)/i,
						]);

						// Description block — everything after "Description" until next section header
						const descMatch = raw.match(/Description\s*[:\-]?\s*\n?([\s\S]{10,800?}?)(?:\n[A-Z][a-z][\w ]+\s*[:\-]|$)/);
						const description = descMatch ? descMatch[1].trim() : '';

						// Device / component
						const device = find([
							/Component[s]?\s*[:\-]?\s*([^\n]+)/i,
							/Hardware\s*[:\-]?\s*([^\n]+)/i,
							/Device\s*[:\-]?\s*([^\n]+)/i,
						]);

						// Serial
						const serial = find([
							/Serial\s*(?:No|Number|#)?\s*[:\-]?\s*([^\n]+)/i,
							/S\/N\s*[:\-]?\s*([^\n]+)/i,
						]);

						// ── Apply to form ────────────────────────────────
						let filled = 0;
						if (summary)     { set('rpt-issue',   summary);     filled++; }
						if (reporter)    { set('rpt-client',  reporter);    filled++; }
						if (assignee)    { set('rpt-tech',    assignee);    filled++; }
						if (device)      { set('rpt-device',  device);      filled++; }
						if (serial)      { set('rpt-serial',  serial);      filled++; }
						if (description) { set('rpt-findings', description); filled++; }
						if (status) {
							const sel = document.getElementById('rpt-status');
							if (sel) {
								const match = [...sel.options].find(o => o.value.toLowerCase().includes(status.toLowerCase()) || status.toLowerCase().includes(o.value.toLowerCase()));
								if (match) { sel.value = match.value; filled++; }
							}
						}
						if (issueType) {
							const sel = document.getElementById('rpt-repairtype');
							if (sel) {
								const match = [...sel.options].find(o => o.value.toLowerCase().includes(issueType.toLowerCase()) || issueType.toLowerCase().includes(o.value.toLowerCase()));
								if (match) { sel.value = match.value; filled++; }
							}
						}

						if (fb) fb.textContent = filled > 0
							? `✅ Imported ${filled} field${filled > 1 ? 's' : ''}. Review and adjust as needed.`
							: '⚠ Couldn\'t extract any fields — try copying more of the Jira issue page.';

						if (filled > 0) {
							setTimeout(() => {
								const panel = document.getElementById('rpt-jira-panel');
								if (panel) panel.style.display = 'none';
							}, 1800);
						}
					});

						// Saved clients dropdown interactions
						document.getElementById('rpt-client-select')?.addEventListener('change', (e) => {
							const idx = parseInt(e.target.value, 10);
							if (!isNaN(idx)) { const arr = getSaved(); if (arr[idx]) loadClient(arr[idx]); }
						});
						document.getElementById('btn-rpt-del-saved')?.addEventListener('click', () => {
							const sel = document.getElementById('rpt-client-select');
							const idx = parseInt(sel?.value, 10);
							if (isNaN(idx)) return;
							const arr = getSaved(); arr.splice(idx, 1); putSaved(arr); renderSavedClients();
							if (sel) sel.value = '';
						});

						// Saved technicians dropdown interactions
						document.getElementById('rpt-tech-select')?.addEventListener('change', (e) => {
							const idx = parseInt(e.target.value, 10);
							if (!isNaN(idx)) { const arr = getSavedTechs(); if (arr[idx]) loadTech(arr[idx]); }
						});
						document.getElementById('btn-rpt-del-saved-tech')?.addEventListener('click', () => {
							const sel = document.getElementById('rpt-tech-select');
							const idx = parseInt(sel?.value, 10);
							if (isNaN(idx)) return;
							const arr = getSavedTechs(); arr.splice(idx, 1); putSavedTechs(arr); renderSavedTechs();
							if (sel) sel.value = '';
						});

					// ── Regen reference button
					document.getElementById('btn-rpt-ref-regen')?.addEventListener('click', () => {
						const el = document.getElementById('rpt-ref-input');
						if (el) el.value = refNumber();
					});

					document.getElementById('btn-rpt-gen')?.addEventListener('click', () => {
						const get = id => (document.getElementById(id)?.value || '').trim();
						// ensure ref is set
						const refEl2 = document.getElementById('rpt-ref-input');
						if (refEl2 && !refEl2.value.trim()) refEl2.value = refNumber();
						const client     = get('rpt-client')          || 'N/A';
						const tech       = get('rpt-tech')            || 'N/A';
						const techEmail  = get('rpt-tech-email')      || '';
						const techPhone  = get('rpt-tech-phone')      || '';
						const techStreet = get('rpt-tech-street')     || '';
						const techPostal = get('rpt-tech-postal')     || '';
						const techCity   = get('rpt-tech-city')       || '';
						const email      = get('rpt-email')           || '';
						const phone      = get('rpt-phone')           || '';
						const street     = get('rpt-street')          || '';
						const postal     = get('rpt-postal')          || '';
						const city       = get('rpt-city')            || '';
						const device     = get('rpt-device')          || 'N/A';
						const serial     = get('rpt-serial')          || 'N/A';
						const dateRec    = get('rpt-date-received')   || '';
						const issue      = get('rpt-issue')           || 'N/A';
						const findings   = get('rpt-findings')        || 'N/A';
						const recs       = get('rpt-recommendations') || 'N/A';
						const troubleshootDate = get('rpt-troubleshoot-date') || '';
						const solutionDate     = get('rpt-solution-date')     || '';
						const fmtDate = iso => { if (!iso) return ''; try { return new Date(iso).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); } catch { return iso; } };
						const status     = get('rpt-status')          || 'Completed';
						const repairType = get('rpt-repairtype')      || 'N/A';
						const now        = new Date();
						const dateStr    = now.toLocaleDateString('en-GB', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
						const timeStr    = now.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
						const ref        = get('rpt-ref-input') || refNumber();
						const address    = [street, postal, city].filter(Boolean).join(', ');
						const W          = 50;
						const LINE       = '─'.repeat(W);
						const DLINE      = '═'.repeat(W);

						const report = [
							DLINE,
							'  SERVICE REPORT',
							DLINE,
							pad('  Reference',   ref,        14),
							pad('  Date',        dateStr,    14),
							pad('  Time',        timeStr,    14),
							pad('  Technician',  tech,       14),
							...(techEmail  ? [pad('  Tech Email',  techEmail,  14)] : []),
							...(techPhone  ? [pad('  Tech Phone',  techPhone,  14)] : []),
							...([techStreet,techPostal,techCity].filter(Boolean).length ? [pad('  Return Addr', [techStreet,techPostal,techCity].filter(Boolean).join(', '), 14)] : []),
							LINE,
							'  CLIENT',
							LINE,
							pad('  Name',        client,     14),
							...(email   ? [pad('  Email',    email,  14)] : []),
							...(phone   ? [pad('  Phone',    phone,  14)] : []),
							...(address ? [pad('  Address',  address, 14)] : []),
							LINE,
							'  DEVICE',
							LINE,
							pad('  Device',      device,     14),
							pad('  Serial No',   serial,     14),
							...(dateRec ? [pad('  Received',  fmtDate(dateRec), 14)] : []),
							LINE,
							'  REPORTED ISSUE',
							LINE,
							`  ${issue}`,
							LINE,
							`  TROUBLESHOOTING${troubleshootDate ? '  (' + fmtDate(troubleshootDate) + ')' : ''}`,
							LINE,
							bulletLines(findings),
							LINE,
							`  SOLUTION${solutionDate ? '  (' + fmtDate(solutionDate) + ')' : ''}`,
							LINE,
							bulletLines(recs),
							LINE,
							'  JOB SUMMARY',
							LINE,
							pad('  Status',      status,     14),
							pad('  Repair Type', repairType, 14),
							DLINE,
							'  Thank you for choosing our service.',
							DLINE,
						].join('\n');

						const outEl   = document.getElementById('rpt-output');
						const copyBtn = document.getElementById('btn-rpt-copy');
						const clrBtn  = document.getElementById('btn-rpt-clear');
						const prtBtn  = document.getElementById('btn-rpt-print');
						if (outEl)   { outEl.value = report; outEl.style.display = ''; outEl.rows = report.split('\n').length + 2; }
						if (copyBtn) copyBtn.style.display = '';
						if (clrBtn)  clrBtn.style.display  = '';
						if (prtBtn)  prtBtn.style.display  = '';

							// Save client and technician entries for quick re-use
							saveClientIfNew();
							saveTechIfNew();
						});

						document.getElementById('btn-rpt-copy')?.addEventListener('click', (e) => {
						const val = document.getElementById('rpt-output')?.value;
						if (val) toolCopy(val, e.currentTarget);
					});

					document.getElementById('btn-rpt-clear')?.addEventListener('click', () => {
						['rpt-client','rpt-tech','rpt-tech-email','rpt-tech-phone','rpt-tech-street','rpt-tech-postal','rpt-tech-city',
						 'rpt-email','rpt-phone','rpt-street','rpt-postal','rpt-city',
						 'rpt-device','rpt-serial','rpt-date-received',
						 'rpt-issue','rpt-troubleshoot-date','rpt-findings','rpt-solution-date','rpt-recommendations'].forEach(id => {
							const el = document.getElementById(id); if (el) el.value = '';
						});
						// generate a fresh ref for the next report
						const refClrEl = document.getElementById('rpt-ref-input');
						if (refClrEl) refClrEl.value = refNumber();
						const outEl   = document.getElementById('rpt-output');
						const copyBtn = document.getElementById('btn-rpt-copy');
						const clrBtn  = document.getElementById('btn-rpt-clear');
						const prtBtn  = document.getElementById('btn-rpt-print');
						if (outEl)   { outEl.style.display = 'none'; outEl.value = ''; }
						if (copyBtn) copyBtn.style.display = 'none';
						if (clrBtn)  clrBtn.style.display  = 'none';
						if (prtBtn)  prtBtn.style.display  = 'none';
					});

					// ── Print / Preview ───────────────────────────────
					function buildA4Html(data) {
						function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
						function bulletHtml(raw) {
							if (!raw || raw.trim() === '') return '<p style="color:#aaa;font-style:italic">None provided.</p>';
							const items = raw.split('\n').map(l => l.trim()).filter(Boolean);
							return `<ul>${items.map(i => `<li>${esc(i)}</li>`).join('')}</ul>`;
						}
						const now     = new Date();
						const dateStr = now.toLocaleDateString('en-GB', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
						const timeStr = now.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
						return `
						<div class="rpt-header">
							<h1>Service Report</h1>
							<div class="rpt-ref">Ref: ${esc(data.ref)} &nbsp;|&nbsp; ${esc(dateStr)} &nbsp;|&nbsp; ${esc(timeStr)}</div>
						</div>

						<div class="rpt-meta-grid">
							<div class="rpt-meta-box">
								<h2>Client Information</h2>
								<div class="rpt-meta-row"><span class="rpt-meta-label">Client</span><span class="rpt-meta-val">${esc(data.client)}</span></div>
								${data.email  ? `<div class="rpt-meta-row"><span class="rpt-meta-label">Email</span><span class="rpt-meta-val">${esc(data.email)}</span></div>` : ''}
								${data.phone  ? `<div class="rpt-meta-row"><span class="rpt-meta-label">Phone</span><span class="rpt-meta-val">${esc(data.phone)}</span></div>` : ''}
								${(data.street||data.postal||data.city) ? `<div class="rpt-meta-row"><span class="rpt-meta-label">Address</span><span class="rpt-meta-val">${esc([data.street,data.postal,data.city].filter(Boolean).join(', '))}</span></div>` : ''}
							</div>
							<div class="rpt-meta-box">
								<h2>Technician</h2>
								<div class="rpt-meta-row"><span class="rpt-meta-label">Name</span><span class="rpt-meta-val">${esc(data.tech)}</span></div>
								${data.techEmail ? `<div class="rpt-meta-row"><span class="rpt-meta-label">Email</span><span class="rpt-meta-val">${esc(data.techEmail)}</span></div>` : ''}
								${data.techPhone ? `<div class="rpt-meta-row"><span class="rpt-meta-label">Phone</span><span class="rpt-meta-val">${esc(data.techPhone)}</span></div>` : ''}
								${(data.techStreet||data.techPostal||data.techCity) ? `<div class="rpt-meta-row"><span class="rpt-meta-label">Return Address</span><span class="rpt-meta-val">${esc([data.techStreet,data.techPostal,data.techCity].filter(Boolean).join(', '))}</span></div>` : ''}
							</div>
							<div class="rpt-meta-box" style="grid-column:1/-1">
								<h2>Device</h2>
								<div class="rpt-meta-row"><span class="rpt-meta-label">Model</span><span class="rpt-meta-val">${esc(data.device)}</span></div>
								<div class="rpt-meta-row"><span class="rpt-meta-label">Serial Number</span><span class="rpt-meta-val">${esc(data.serial)}</span></div>
								${data.dateReceived ? `<div class="rpt-meta-row"><span class="rpt-meta-label">Date Received</span><span class="rpt-meta-val">${esc(data.dateReceived)}</span></div>` : ''}
							</div>
						</div>

						<div class="rpt-sections">
							<div class="rpt-section">
								<div class="rpt-section-title">Reported Issue</div>
								<div class="rpt-section-body"><p>${esc(data.issue)}</p></div>
							</div>
							<div class="rpt-section">
								<div class="rpt-section-title">Troubleshooting${data.troubleshootDate ? ' <span style="font-weight:400;opacity:0.7;font-size:7pt"> — ' + esc(data.troubleshootDate) + '</span>' : ''}</div>
								<div class="rpt-section-body">${bulletHtml(data.findings)}</div>
							</div>
							<div class="rpt-section">
								<div class="rpt-section-title">Solution${data.solutionDate ? ' <span style="font-weight:400;opacity:0.7;font-size:7pt"> — ' + esc(data.solutionDate) + '</span>' : ''}</div>
								<div class="rpt-section-body">${bulletHtml(data.recs)}</div>
							</div>
						</div>

						<div class="rpt-summary-bar">
							<div class="rpt-summary-chip">
								<div class="rpt-chip-label">Job Status</div>
								<div class="rpt-chip-val">${esc(data.status)}</div>
							</div>
							<div class="rpt-summary-chip">
								<div class="rpt-chip-label">Repair Type</div>
								<div class="rpt-chip-val">${esc(data.repairType)}</div>
							</div>
							<div class="rpt-summary-chip">
								<div class="rpt-chip-label">Reference</div>
								<div class="rpt-chip-val">${esc(data.ref)}</div>
							</div>
						</div>

						<div class="rpt-sig-block">
							<div><div class="rpt-sig-line">Technician Signature</div></div>
							<div><div class="rpt-sig-line">Customer Signature &amp; Date</div></div>
						</div>

						<div class="rpt-footer">
							<span>Generated ${esc(dateStr)} at ${esc(timeStr)}</span>
							<span>Ref: ${esc(data.ref)}</span>
						</div>
					`;
					}

					document.getElementById('btn-rpt-print')?.addEventListener('click', () => {
						const get = id => (document.getElementById(id)?.value || '').trim();
						const fmtD = iso => { if (!iso) return ''; try { return new Date(iso).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); } catch { return iso; } };
						const d = {
							client:          get('rpt-client')          || 'N/A',
							tech:            get('rpt-tech')            || 'N/A',
							techEmail:       get('rpt-tech-email')      || '',
							techPhone:       get('rpt-tech-phone')      || '',
							techStreet:      get('rpt-tech-street')     || '',
							techPostal:      get('rpt-tech-postal')     || '',
							techCity:        get('rpt-tech-city')       || '',
							email:           get('rpt-email')           || '',
							phone:           get('rpt-phone')           || '',
							street:          get('rpt-street')          || '',
							postal:          get('rpt-postal')          || '',
							city:            get('rpt-city')            || '',
							device:          get('rpt-device')          || 'N/A',
							serial:          get('rpt-serial')          || 'N/A',
							dateReceived:    fmtD(get('rpt-date-received')),
							issue:           get('rpt-issue')           || 'N/A',
							findings:        get('rpt-findings')        || '',
							recs:            get('rpt-recommendations') || '',
							status:          get('rpt-status')          || 'Completed',
							repairType:      get('rpt-repairtype')      || 'N/A',
							troubleshootDate: fmtD(get('rpt-troubleshoot-date')),
							solutionDate:     fmtD(get('rpt-solution-date')),
							ref:             get('rpt-ref-input') || refNumber(),
						};
						const a4 = document.getElementById('rpt-a4');
						if (a4) a4.innerHTML = buildA4Html(d);
						const overlay = document.getElementById('rpt-print-overlay');
						if (overlay) overlay.hidden = false;
					});

					document.getElementById('btn-rpt-print-close')?.addEventListener('click', () => {
						const overlay = document.getElementById('rpt-print-overlay');
						if (overlay) overlay.hidden = true;
					});

					document.getElementById('btn-rpt-do-print')?.addEventListener('click', () => {
						const a4Content = document.getElementById('rpt-a4')?.innerHTML || '';
						const pw = window.open('', '_blank', 'width=900,height=700');
						if (!pw) { alert('Pop-up blocked — please allow pop-ups for this page and try again.'); return; }
						pw.document.write(`<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Service Report</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
@page { size: A4 portrait; margin: 0; }
html { width: 210mm; height: 297mm; }
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 10pt;
  color: #111;
  background: white;
  width: 210mm;
  height: 297mm;
  padding: 14mm 16mm;
  display: flex;
  flex-direction: column;
}
.rpt-page {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  flex: 1;
  height: 100%;
}
.rpt-header { text-align: center; border-bottom: 3px solid #1a1a2e; padding-bottom: 8px; margin-bottom: 10px; }
.rpt-header h1 { font-size: 22pt; font-weight: 900; color: #1a1a2e; letter-spacing: -1px; margin-bottom: 3px; }
.rpt-ref { font-size: 7.5pt; color: #333; }
.rpt-meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; margin-bottom: 10px; }
.rpt-meta-box { border: 1.5px solid #999; border-radius: 4px; padding: 7px 10px; }
.rpt-meta-box h2 { font-size: 6.5pt; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #444; margin-bottom: 5px; border-bottom: 1.5px solid #bbb; padding-bottom: 3px; }
.rpt-meta-row { display: flex; justify-content: space-between; font-size: 8.5pt; margin-bottom: 3px; }
.rpt-meta-label { color: #222; font-weight: 700; }
.rpt-meta-val { color: #111; text-align: right; max-width: 60%; word-break: break-word; }
.rpt-sections { display: flex; flex-direction: column; gap: 7px; flex: 1; }
.rpt-section { border: 1.5px solid #999; border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; flex: 1; }
.rpt-section-title { background: #1a1a2e; color: white; font-size: 7.5pt; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; padding: 5px 10px; flex-shrink: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
.rpt-section-body { padding: 8px 10px; font-size: 8.5pt; line-height: 1.6; flex: 1; }
.rpt-section-body p { color: #111; }
.rpt-section-body ul { padding-left: 16px; }
.rpt-section-body li { margin-bottom: 3px; color: #111; }
.rpt-summary-bar { display: flex; gap: 7px; margin-top: 10px; flex-shrink: 0; }
.rpt-summary-chip { flex: 1; border: 1.5px solid #999; border-radius: 4px; padding: 7px 10px; text-align: center; }
.rpt-chip-label { font-size: 6pt; font-weight: 700; text-transform: uppercase; letter-spacing: 0.7px; color: #444; margin-bottom: 3px; }
.rpt-chip-val { font-size: 9pt; font-weight: 700; color: #1a1a2e; }
.rpt-sig-block { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 14px; flex-shrink: 0; }
.rpt-sig-line { border-top: 1.5px solid #555; padding-top: 4px; font-size: 7pt; color: #333; text-align: center; margin-top: 28px; }
.rpt-footer { border-top: 1.5px solid #999; padding-top: 5px; display: flex; justify-content: space-between; font-size: 6.5pt; color: #444; margin-top: 10px; flex-shrink: 0; }
</style>
</head>
<body><div class="rpt-page">${a4Content}</div></body>
</html>`);
						pw.document.close();
						pw.focus();
						pw.onload = () => { pw.print(); };
						// fallback if onload already fired
						setTimeout(() => { try { pw.print(); } catch(e) {} }, 600);
					});

					// Close on overlay background click
					document.getElementById('rpt-print-overlay')?.addEventListener('click', (e) => {
						if (e.target === document.getElementById('rpt-print-overlay')) {
							document.getElementById('rpt-print-overlay').hidden = true;
						}
					});

					// Pre-fill reference on load
					const refInitEl = document.getElementById('rpt-ref-input');
					if (refInitEl && !refInitEl.value) refInitEl.value = refNumber();

						renderSavedClients();
						renderSavedTechs();
						loadContactsFromCloud();
					})();				// ════════════════════════════════════════════════════
				function insertWrapping(before, after) {
					if (!notesEl) return;
					const start = notesEl.selectionStart;
					const end   = notesEl.selectionEnd;
					const sel   = notesEl.value.slice(start, end);
					const repl  = sel ? `${before}${sel}${after}` : `${before}${after}`;
					notesEl.setRangeText(repl, start, end, 'end');
					if (!sel) notesEl.selectionStart = notesEl.selectionEnd = start + before.length;
					notesEl.dispatchEvent(new Event('input'));
					notesEl.focus();
				}
				document.getElementById('btn-fmt-bold')?.addEventListener('click', () => insertWrapping('**', '**'));
				document.getElementById('btn-fmt-italic')?.addEventListener('click', () => insertWrapping('_', '_'));
				document.getElementById('btn-fmt-code')?.addEventListener('click', () => insertWrapping('`', '`'));
				document.getElementById('btn-fmt-strike')?.addEventListener('click', () => insertWrapping('~~', '~~'));

				// Keyboard shortcuts for formatting (⌘B / ⌘I)
				// These are added inside the textarea to avoid conflicts with browser defaults

				// ── Note history / snapshots ──────────────────────────
				const HISTORY_KEY_PREFIX = 'ectl_hist_';
				const HISTORY_MAX = 12;
				let _historyDocId = null;
				let _historyTimer = null;

				function historyKey(docId) { return HISTORY_KEY_PREFIX + docId; }

				function pushSnapshot(docId, content) {
					if (!docId || content === undefined) return;
					const key = historyKey(docId);
					let snaps = [];
					try { snaps = JSON.parse(sessionStorage.getItem(key) || '[]'); } catch { snaps = []; }
					// Skip if identical to most recent
					if (snaps.length > 0 && snaps[snaps.length - 1].c === content) return;
					snaps.push({ ts: new Date().toISOString(), c: content });
					if (snaps.length > HISTORY_MAX) snaps = snaps.slice(-HISTORY_MAX);
					try { sessionStorage.setItem(key, JSON.stringify(snaps)); } catch { /* quota */ }
				}

				function scheduleSnapshot() {
					if (_historyTimer) clearTimeout(_historyTimer);
					_historyTimer = setTimeout(() => {
						if (activeDocId && notesEl) pushSnapshot(activeDocId, notesEl.value);
					}, 30000); // every 30 s of inactivity
				}

				// Hook into textarea input to schedule snapshot
				if (notesEl) notesEl.addEventListener('input', scheduleSnapshot);

				document.getElementById('btn-history')?.addEventListener('click', (e) => {
					e.stopPropagation();
					const pop = document.getElementById('history-pop');
					if (!pop) return;
					if (!pop.hidden) { pop.hidden = true; return; }
					// Populate
					pop.innerHTML = '';
					const snaps = (() => {
						try { return JSON.parse(sessionStorage.getItem(historyKey(activeDocId)) || '[]'); } catch { return []; }
					})().reverse(); // newest first
					if (snaps.length === 0) {
						pop.innerHTML = '<div class="history-pop-empty">No snapshots yet.<br><small>Saved every 30 s while editing.</small></div>';
					} else {
						for (const snap of snaps) {
							const item = document.createElement('button');
							item.className = 'history-pop-item';
							item.type = 'button';
							const words = snap.c.trim().split(/\s+/).filter(Boolean).length;
							const preview = snap.c.trim().slice(0, 60).replace(/\n/g, ' ');
							item.innerHTML = `<span class="hist-ts">${new Date(snap.ts).toLocaleString()}</span><span class="hist-preview">${escHtml(preview)}${snap.c.length > 60 ? '…' : ''} <em style="font-size:0.7em">(${words} words)</em></span>`;
							item.addEventListener('click', () => {
								if (!confirm(`Restore this snapshot? Current content will be replaced.`)) return;
								if (notesEl) { notesEl.value = snap.c; notesEl.dispatchEvent(new Event('input')); }
								pop.hidden = true;
								showToast('Snapshot restored', 'success');
							});
							pop.appendChild(item);
						}
					}
					pop.hidden = false;
					// Position below button
					requestAnimationFrame(() => {
						const btn = document.getElementById('btn-history');
						if (!btn) return;
						const r = btn.getBoundingClientRect();
						const popH = pop.offsetHeight;
						const spaceBelow = window.innerHeight - r.bottom;
						pop.style.right = (window.innerWidth - r.right) + 'px';
						pop.style.left = 'auto';
						if (spaceBelow < popH + 8 && r.top > popH + 8) {
							pop.style.top = (r.top - popH - 4) + 'px';
						} else {
							pop.style.top = (r.bottom + 4) + 'px';
						}
					});
				});
				document.addEventListener('click', (e) => {
					const pop = document.getElementById('history-pop');
					const btn = document.getElementById('btn-history');
					if (pop && !pop.hidden && !pop.contains(e.target) && e.target !== btn) pop.hidden = true;
				});

				// ── Quick-insert text macros (:date, :time, :now, :hr, :todo) ──
				const MACROS = [
					{ trigger: ':date', label: ':date', desc: 'Today\'s date', expand: () => new Date().toLocaleDateString([], { year:'numeric', month:'long', day:'numeric' }) },
					{ trigger: ':time', label: ':time', desc: 'Current time', expand: () => new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }) },
					{ trigger: ':now',  label: ':now',  desc: 'Date + time',  expand: () => new Date().toLocaleString([], { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }) },
					{ trigger: ':hr',   label: ':hr',   desc: 'Horizontal rule', expand: () => '\n---\n' },
					{ trigger: ':todo', label: ':todo', desc: 'Task checkbox', expand: () => '- [ ] ' },
				];
				let _macroActive = false;
				let _macroIdx = 0;
				const macroHint = document.getElementById('macro-hint');

				function hideMacroHint() {
					if (macroHint) { macroHint.classList.remove('visible'); macroHint.innerHTML = ''; }
					_macroActive = false;
				}

				function showMacroHint(matches, triggerStart, caretRect) {
					if (!macroHint || matches.length === 0) { hideMacroHint(); return; }
					_macroActive = true;
					_macroIdx = 0;
					macroHint.innerHTML = '';
					matches.forEach((m, i) => {
						const item = document.createElement('div');
						item.className = 'macro-hint-item' + (i === 0 ? ' active' : '');
						item.dataset.idx = String(i);
						item.innerHTML = `<kbd>${escHtml(m.label)}</kbd> <span>${escHtml(m.desc)}</span>`;
						item.addEventListener('mousedown', (e) => { e.preventDefault(); applyMacro(m, triggerStart); });
						macroHint.appendChild(item);
					});
					macroHint.classList.add('visible');
					// Position above or below caret
					const rect = caretRect;
					const popH = macroHint.offsetHeight || 120;
					const spaceBelow = window.innerHeight - rect.bottom;
					macroHint.style.left = Math.min(rect.left, window.innerWidth - 200) + 'px';
					if (spaceBelow < popH + 8) {
						macroHint.style.top = (rect.top - popH - 4) + 'px';
					} else {
						macroHint.style.top = (rect.bottom + 4) + 'px';
					}
				}

				function applyMacro(macro, triggerStart) {
					if (!notesEl) return;
					const expanded = macro.expand();
					notesEl.setRangeText(expanded, triggerStart, notesEl.selectionStart, 'end');
					notesEl.dispatchEvent(new Event('input'));
					hideMacroHint();
					notesEl.focus();
				}

				function getCaretCoords(el) {
					// Use a hidden mirror div to compute caret pixel position
					const mirror = document.createElement('div');
					const cs = getComputedStyle(el);
					['fontFamily','fontSize','fontWeight','letterSpacing','lineHeight','padding','border',
					 'boxSizing','width','wordBreak','whiteSpace','overflowWrap'].forEach(p => mirror.style[p] = cs[p]);
					mirror.style.cssText += ';position:fixed;top:-9999px;left:-9999px;overflow:hidden;white-space:pre-wrap;';
					const text = el.value.slice(0, el.selectionStart);
					mirror.textContent = text;
					const span = document.createElement('span');
					span.textContent = el.value.slice(el.selectionStart) || '.';
					mirror.appendChild(span);
					document.body.appendChild(mirror);
					const elRect = el.getBoundingClientRect();
					const spanRect = span.getBoundingClientRect();
					document.body.removeChild(mirror);
					return {
						left: elRect.left + spanRect.left - mirror.getBoundingClientRect?.()?.left || elRect.left,
						top: spanRect.top,
						bottom: spanRect.bottom,
					};
				}

				if (notesEl) {
					notesEl.addEventListener('keydown', (e) => {
						// Formatting shortcuts inside textarea
						const mod = e.metaKey || e.ctrlKey;
						if (mod && e.key === 'b') { e.preventDefault(); insertWrapping('**', '**'); return; }
						if (mod && e.key === 'i') { e.preventDefault(); insertWrapping('_', '_'); return; }

						if (_macroActive) {
							const items = macroHint?.querySelectorAll('.macro-hint-item') ?? [];
							if (e.key === 'ArrowDown') {
								e.preventDefault();
								_macroIdx = (_macroIdx + 1) % items.length;
								items.forEach((el, i) => el.classList.toggle('active', i === _macroIdx));
								return;
							}
							if (e.key === 'ArrowUp') {
								e.preventDefault();
								_macroIdx = (_macroIdx - 1 + items.length) % items.length;
								items.forEach((el, i) => el.classList.toggle('active', i === _macroIdx));
								return;
							}
							if (e.key === 'Enter' || e.key === 'Tab') {
								e.preventDefault();
								const triggerStart = notesEl.value.lastIndexOf(':', notesEl.selectionStart - 1);
								const matches = MACROS.filter(m => notesEl.value.slice(triggerStart, notesEl.selectionStart) === m.trigger || m.trigger.startsWith(notesEl.value.slice(triggerStart, notesEl.selectionStart)));
								if (items[_macroIdx]) {
									const macro = MACROS[parseInt(items[_macroIdx].dataset.idx, 10)];
									if (macro) applyMacro(macro, triggerStart);
								}
								return;
							}
							if (e.key === 'Escape') { hideMacroHint(); return; }
						}
					});

					notesEl.addEventListener('input', () => {
						// Macro trigger detection
						const pos = notesEl.selectionStart;
						const textBefore = notesEl.value.slice(0, pos);
						const colonIdx = textBefore.lastIndexOf(':');
						if (colonIdx !== -1 && pos - colonIdx <= 6) {
							const typed = textBefore.slice(colonIdx);
							const matches = MACROS.filter(m => m.trigger.startsWith(typed) && typed.length >= 1);
							if (matches.length > 0) {
								// Get approximate caret rect via getBoundingClientRect of textarea
								const rect = notesEl.getBoundingClientRect();
								showMacroHint(matches, colonIdx, { left: rect.left + 40, top: rect.top, bottom: rect.top + 24 });
								return;
							}
						}
						hideMacroHint();
					});
				}

				// ── File sort ─────────────────────────────────────────
				let fileSortOrder = 'date-desc';
				document.getElementById('files-sort-select')?.addEventListener('change', (e) => {
					fileSortOrder = e.target.value;
					if (_cachedFiles.length) renderFileList(_cachedFiles);
				});

				// ── File bulk delete ──────────────────────────────────
				function updateBulkDeleteBtn() {
					const btn = document.getElementById('btn-bulk-delete');
					if (!btn) return;
					const checked = document.querySelectorAll('.file-row-check:checked');
					if (checked.length > 0) {
						btn.classList.add('visible');
						btn.textContent = `🗑 Delete ${checked.length} file${checked.length !== 1 ? 's' : ''}`;
					} else {
						btn.classList.remove('visible');
					}
				}

				document.getElementById('btn-bulk-delete')?.addEventListener('click', async () => {
					const checked = [...document.querySelectorAll('.file-row-check:checked')];
					if (checked.length === 0) return;
					const names = checked.map(cb => cb.dataset.filename);
					if (!confirm(`Delete ${names.length} file${names.length !== 1 ? 's' : ''}?\n${names.join('\n')}`)) return;
					const btn = document.getElementById('btn-bulk-delete');
					if (btn) btn.disabled = true;
					let failed = 0;
					for (const name of names) {
						try { await withTimeout(storageDeleteFile(name), AUTH_TIMEOUT_MS, 'Delete'); }
						catch { failed++; }
					}
					if (failed > 0) showToast(`${failed} file(s) failed to delete`, 'error');
					else showToast(`${names.length} file${names.length !== 1 ? 's' : ''} deleted`, 'success');
					if (btn) btn.disabled = false;
					await refreshFileList();
				});

				// ── Recent files on Home ──────────────────────────────
				let _cachedFiles = [];
				function renderRecentFiles(files) {
					if (files) _cachedFiles = files;
					const section = document.getElementById('home-recent-files');
					const listEl = document.getElementById('recent-files-list');
					if (!section || !listEl) return;
					const recent = [..._cachedFiles].slice(0, 5);
					if (recent.length === 0) { section.hidden = true; return; }
					listEl.innerHTML = '';
					for (const f of recent) {
						const row = document.createElement('div');
						row.className = 'recent-file-row';
						const date = f.created_at || f.updated_at || '';
						row.innerHTML = `
							<span class="recent-file-icon" aria-hidden="true">${fileTypeIcon(f.name)}</span>
							<span class="recent-file-name">${escHtml(f.name)}</span>
							<span class="recent-file-date">${formatDate(date)}</span>
						`;
						listEl.appendChild(row);
					}
					section.hidden = false;
					// Update stats so file count shows correctly
					renderStats();
				}

				async function saveCurrentDoc() {
					if (!activeDocId || !activeUserId) return;
					const doc = noteDocs.find(d => d.id === activeDocId);
					if (!doc) return;
					if (notesEl) doc.content = notesEl.value;
					doc.updated_at = new Date().toISOString();
					saveDocsLocally(activeUserId);
					renderDocList();
					setSaveStatus('Saving…');
					try {
						await withTimeout(restUpsertDoc(activeUserId, doc, activeAccessToken), AUTH_TIMEOUT_MS, 'Doc save');
						setSaveStatus('Saved');
					} catch (e) {
						console.warn('Cloud save failed, kept locally:', e?.message);
						setSaveStatus('Saved locally');
					}
					window.setTimeout(() => setSaveStatus(''), 1400);
				}

				function scheduleDocSave() {
					if (docSaveTimer) clearTimeout(docSaveTimer);
					docSaveTimer = setTimeout(saveCurrentDoc, 600);
				}

				if (notesEl) notesEl.addEventListener('input', () => {
					scheduleDocSave();
					updateWordCount();
					updateCharWarning();
					updateWordGoal();
					if (mdPreviewOn) {
						const pane = document.getElementById('md-preview-pane');
						if (pane) pane.innerHTML = renderMarkdown(notesEl.value);
					}
				});

				// ── Word-goal ──────────────────────────────────────────
				let wordGoal = 0;

				function updateWordGoal() {
					const row   = document.getElementById('word-goal-row');
					const fill  = document.getElementById('word-goal-fill');
					const label = document.getElementById('word-goal-label');
					if (!row) return;
					if (!wordGoal) { row.hidden = true; return; }
					row.hidden = false;
					const text  = notesEl?.value ?? '';
					const words = text.trim() ? text.trim().split(/\s+/).length : 0;
					const pct   = Math.min(100, Math.round((words / wordGoal) * 100));
					if (fill)  { fill.style.width = pct + '%'; fill.classList.toggle('goal-met', words >= wordGoal); }
					if (label) label.textContent = `${words.toLocaleString()} / ${wordGoal.toLocaleString()} words`;
				}

				document.getElementById('btn-word-goal')?.addEventListener('click', () => {
					const val = prompt('Word goal for this session (0 to disable):', String(wordGoal));
					if (val === null) return;
					wordGoal = Math.max(0, parseInt(val, 10) || 0);
					currentPrefs.wordGoal = wordGoal;
					updateWordGoal();
					showToast(wordGoal ? `Word goal set: ${wordGoal}` : 'Word goal disabled', 'info');
				});

				function updateWordCount() {
					if (!wordCountEl || !notesEl) return;
					const text = notesEl.value;
					const words = text.trim() ? text.trim().split(/\s+/).length : 0;
					const chars = text.length;
					const mins = Math.max(1, Math.round(words / 200));
					const readTime = words >= 50 ? ` · ~${mins} min read` : '';
					wordCountEl.textContent = `${words} words · ${chars} chars${readTime}`;
				}

				if (notesSearchEl) {
					notesSearchEl.addEventListener('input', () => {
						noteSearchQuery = notesSearchEl.value;
						renderDocList();
					});
				}

				// ── Keyboard shortcuts ────────────────────────────────
				document.addEventListener('keydown', (e) => {
					if (!activeUserId) return;
					const mod = e.metaKey || e.ctrlKey;
					const tag = document.activeElement?.tagName;
					const inField = tag === 'INPUT' || tag === 'TEXTAREA';
					// Tab switching shortcuts (safe on macOS + Safari)
					// ⌘⇧H: Home | ⌘⇧N: Notes | ⌘⇧,: Settings | ⌘⇧F: Files
					if (mod && e.shiftKey) {
						if (e.key === 'H' || e.key === 'h') { e.preventDefault(); selectTab('tab-home'); }
						if (e.key === 'N' || e.key === 'n') { e.preventDefault(); selectTab('tab-notes'); }
						if (e.key === ',' || e.key === '<') { e.preventDefault(); selectTab('tab-settings'); }
						if (e.key === 'F' || e.key === 'f') { e.preventDefault(); selectTab('tab-files'); }
						if (e.key === 'X' || e.key === 'x') { e.preventDefault(); selectTab('tab-tools'); }
						if (e.key === 'W' || e.key === 'w') { e.preventDefault(); selectTab('tab-work'); }
						if (e.key === 'R' || e.key === 'r') { e.preventDefault(); selectTab('tab-reports'); }
						// ⌘⇧P: toggle markdown preview
						if (e.key === 'P' || e.key === 'p') { e.preventDefault(); document.getElementById('btn-md-preview')?.click(); }
					}
					// ⌘S: save note
					if (mod && e.key === 's') {
						e.preventDefault();
						if (docSaveTimer) { clearTimeout(docSaveTimer); docSaveTimer = null; }
						saveCurrentDoc().then(() => showToast('Note saved', 'success'));
					}
					// ⌘T: new note
					if (mod && e.key === 't') {
						e.preventDefault();
						if (newDocBtn) newDocBtn.click();
					}
					// ⌘D: duplicate note
					if (mod && !e.shiftKey && e.key === 'd') {
						e.preventDefault();
						document.getElementById('btn-duplicate-doc')?.click();
					}
					// ⌘P: toggle pin on active note
					if (mod && !e.shiftKey && e.key === 'p') {
						e.preventDefault();
						const doc = noteDocs.find(d => d.id === activeDocId);
						if (doc) {
							doc.pinned = !doc.pinned;
							if (activeUserId) saveDocsLocally(activeUserId);
							if (activeUserId && activeAccessToken) restUpsertDoc(activeUserId, doc, activeAccessToken).catch(() => {});
							renderDocList();
							showToast(doc.pinned ? 'Note pinned' : 'Note unpinned', 'info');
						}
					}
					// ⌘.: toggle focus mode
					if (mod && e.key === '.') {
						e.preventDefault();
						toggleFocusMode();
					}
					// /: focus notes search (only when not in a text field)
					if (!mod && e.key === '/' && !inField) {
						e.preventDefault();
						selectTab('tab-notes');
						requestAnimationFrame(() => notesSearchEl?.focus());
					}
					// ?: open shortcut modal (not in a field)
					if (!mod && e.key === '?' && !inField) {
						e.preventDefault();
						openKbModal();
					}
					// Escape: close modals, clear search
					if (e.key === 'Escape') {
						const lb = document.getElementById('lightbox-overlay');
						const km = document.getElementById('kb-modal-overlay');
						if (lb && !lb.hidden) { closeLightbox(); return; }
						if (km && !km.hidden) { closeKbModal(); return; }
						if (document.activeElement === notesSearchEl) {
							notesSearchEl.value = '';
							noteSearchQuery = '';
							renderDocList();
							notesSearchEl.blur();
						}
					}
				});

				// ── Color filter row wiring ──────────────────────────────────
				document.getElementById('color-filter-row')?.addEventListener('click', (e) => {
					const btn = e.target.closest('.color-filter-btn');
					if (!btn) return;
					noteColorFilter = btn.dataset.color;
					document.querySelectorAll('.color-filter-btn').forEach(b =>
						b.classList.toggle('active', b.dataset.color === noteColorFilter)
					);
					renderDocList();
				});

				// ── Focus / writing mode ─────────────────────────────────────
				function toggleFocusMode(forceOff) {
					const on = forceOff === true ? false : !document.body.classList.contains('focus-mode');
					document.body.classList.toggle('focus-mode', on);
					const btn = document.getElementById('btn-focus-mode');
					if (btn) btn.title = on ? 'Exit focus mode (⌘.)' : 'Focus mode (⌘.)';
					if (on) {
						selectTab('tab-notes');
						requestAnimationFrame(() => notesEl?.focus());
					}
				}
				document.getElementById('btn-focus-mode')?.addEventListener('click', () => toggleFocusMode());

				// ── Paste & create ───────────────────────────────────────────
				document.getElementById('btn-paste-create')?.addEventListener('click', async () => {
					try {
						let text = '';
						if (navigator.clipboard?.readText) {
							text = await navigator.clipboard.readText();
						} else {
							text = prompt('Paste your text here:') ?? '';
						}
						if (!text.trim()) { showToast('Clipboard is empty', 'info'); return; }
						// Title = first non-empty line (truncated to 60 chars)
						const firstLine = text.split('\n').find(l => l.trim()) ?? 'Pasted note';
						const title = firstLine.replace(/^#+\s*/, '').slice(0, 60).trim() || 'Pasted note';
						const doc = createDoc(title, text);
						noteDocs.unshift(doc);
						renderDocList();
						switchDoc(doc.id);
						if (activeUserId) saveDocsLocally(activeUserId);
						if (activeUserId && activeAccessToken) {
							restUpsertDoc(activeUserId, doc, activeAccessToken).catch(e => console.warn('Paste-create cloud save:', e?.message));
						}
						showToast('Pasted as new note', 'success');
					} catch (err) {
						showToast('Could not read clipboard: ' + (err?.message ?? 'permission denied'), 'error');
					}
				});

				// ── Keyboard shortcut cheatsheet modal ───────────────────────
				function openKbModal() {
					const el = document.getElementById('kb-modal-overlay');
					if (el) { el.hidden = false; document.getElementById('btn-kb-modal-close')?.focus(); }
				}
				function closeKbModal() {
					const el = document.getElementById('kb-modal-overlay');
					if (el) el.hidden = true;
				}
				document.getElementById('btn-shortcuts-help')?.addEventListener('click', openKbModal);
				document.getElementById('btn-kb-modal-close')?.addEventListener('click', closeKbModal);
				document.getElementById('kb-modal-overlay')?.addEventListener('click', (e) => {
					if (e.target === document.getElementById('kb-modal-overlay')) closeKbModal();
				});

				// ── File preview lightbox ────────────────────────────────────
				function openLightbox(content, filename) {
					const overlay = document.getElementById('lightbox-overlay');
					const inner   = document.getElementById('lightbox-inner');
					const fname   = document.getElementById('lightbox-fname');
					if (!overlay || !inner) return;
					// Remove previous content (keep close button)
					Array.from(inner.children).forEach(c => { if (!c.classList.contains('lightbox-close')) c.remove(); });
					inner.appendChild(content);
					if (fname) fname.textContent = filename;
					overlay.hidden = false;
				}
				function closeLightbox() {
					const overlay = document.getElementById('lightbox-overlay');
					if (overlay) overlay.hidden = true;
				}
				document.getElementById('lightbox-close')?.addEventListener('click', closeLightbox);
				document.getElementById('lightbox-overlay')?.addEventListener('click', (e) => {
					if (e.target === document.getElementById('lightbox-overlay')) closeLightbox();
				});

				// ── Note templates ───────────────────────────────────────
				const NOTE_TEMPLATES = {
					blank: {
						title: 'Untitled',
						content: '',
					},
					meeting: {
						title: 'Meeting Notes',
						content: (d => `## Meeting – ${d}\n\n**Attendees:**\n- \n\n**Agenda:**\n1. \n\n**Notes:**\n\n\n**Action items:**\n- [ ] `)(new Date().toLocaleDateString()),
					},
					todo: {
						title: 'To-Do List',
						content: '## Tasks\n\n- [ ] \n- [ ] \n- [ ] \n',
					},
					journal: {
						title: `Journal – ${new Date().toLocaleDateString()}`,
						content: (d => `## ${d}\n\n**Mood:** \n\n**Today:**\n\n\n**Grateful for:**\n\n\n**Tomorrow:**\n\n`)(new Date().toLocaleDateString()),
					},
				};

				function createDocFromTemplate(tplKey) {
					const tpl = NOTE_TEMPLATES[tplKey] ?? NOTE_TEMPLATES.blank;
					// Refresh date-sensitive templates each time
					const dateStr = new Date().toLocaleDateString();
					const content = tpl.content.replaceAll('DATE', dateStr);
					const title   = tpl.title.replaceAll('DATE', dateStr);
					const doc = createDoc(title, content);
					noteDocs.unshift(doc);
					renderDocList();
					switchDoc(doc.id);
					if (activeUserId) saveDocsLocally(activeUserId);
					if (activeUserId && activeAccessToken) {
						restUpsertDoc(activeUserId, doc, activeAccessToken).catch(e => console.warn('New doc cloud save:', e?.message));
					}
				}

				// ── New doc button → toggle template picker ──
				const templatePicker = document.getElementById('template-picker');
				if (newDocBtn && templatePicker) {
					newDocBtn.addEventListener('click', (e) => {
						e.stopPropagation();
						templatePicker.hidden = !templatePicker.hidden;
					});
					templatePicker.addEventListener('click', (e) => {
						const btn = e.target.closest('[data-template]');
						if (!btn) return;
						templatePicker.hidden = true;
						createDocFromTemplate(btn.dataset.template);
					});
					// Close picker when clicking outside
					document.addEventListener('click', (e) => {
						if (!templatePicker.hidden && !document.getElementById('btn-new-doc-wrap')?.contains(e.target)) {
							templatePicker.hidden = true;
						}
					});
				} else if (newDocBtn) {
					// Fallback if picker element missing
					newDocBtn.addEventListener('click', () => createDocFromTemplate('blank'));
				}

				// ── Session info ─────────────────────────────────────
				let activeRefreshToken = null;

				function updateSessionInfo() {
					const row   = document.getElementById('session-info-row');
					const badge = document.getElementById('session-expiry-badge');
					if (!row || !badge || !activeAccessToken) { if (row) row.hidden = true; return; }
					try {
						const payload  = JSON.parse(atob(activeAccessToken.split('.')[1]));
						const minsLeft = Math.round((payload.exp * 1000 - Date.now()) / 60000);
						badge.textContent = minsLeft > 0
							? `🔒 Session expires in ${minsLeft} min`
							: '⚠️ Session expired';
						badge.classList.toggle('expiring-soon', minsLeft < 15);
						row.hidden = false;
					} catch { row.hidden = true; }
				}

				document.getElementById('btn-refresh-session')?.addEventListener('click', async () => {
					if (!activeRefreshToken) { showToast('No refresh token available', 'info'); return; }
					try {
						const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=refresh_token`, {
							method: 'POST',
							headers: { apikey: SUPABASE_ANON_KEY, 'Content-Type': 'application/json' },
							body: JSON.stringify({ refresh_token: activeRefreshToken }),
						});
						if (!res.ok) throw new Error(`HTTP ${res.status}`);
						const data = await res.json();
						if (data.access_token)  { activeAccessToken  = data.access_token;  }
						if (data.refresh_token) { activeRefreshToken = data.refresh_token; }
						updateSessionInfo();
						showToast('Session refreshed', 'success');
					} catch (err) {
						showToast('Session refresh failed: ' + (err?.message ?? 'unknown'), 'error');
					}
				});

				// ── Auto-lock idle timer ───────────────────────────────
				let _idleTimer = null;

				function resetIdleTimer() {
					if (_idleTimer) { clearTimeout(_idleTimer); _idleTimer = null; }
					const mins = parseInt(currentPrefs.autoLock, 10);
					if (!mins || !activeUserId) return;
					_idleTimer = setTimeout(() => {
						showToast('Signed out due to inactivity', 'info');
						document.getElementById('btn-sign-out')?.click();
					}, mins * 60 * 1000);
				}

				['mousemove','keydown','pointerdown','scroll'].forEach(ev =>
					document.addEventListener(ev, resetIdleTimer, { passive: true })
				);

				// ── Rename doc ──
				if (renameDocBtn) {
					renameDocBtn.addEventListener('click', () => {
						const doc = noteDocs.find(d => d.id === activeDocId);
						if (!doc) return;
						const newTitle = (docTitleEl?.value ?? '').trim();
						if (!newTitle) return;
						doc.title = newTitle;
						doc.updated_at = new Date().toISOString();
						renderDocList();
						if (activeUserId) saveDocsLocally(activeUserId);
						if (activeUserId && activeAccessToken) {
							restUpsertDoc(activeUserId, doc, activeAccessToken).catch(e => console.warn('Rename cloud save:', e?.message));
						}
					});
				}

				// ── Delete doc (with undo toast) ──
				let _lastDeletedDoc = null;
				let _undoDeleteTimer = null;

				function showUndoToast(docTitle) {
					if (!toastContainer) return;
					// Cancel previous undo if still pending
					if (_undoDeleteTimer) { clearTimeout(_undoDeleteTimer); _undoDeleteTimer = null; }
					const el = document.createElement('div');
					el.className = 'toast';
					el.setAttribute('role', 'status');
					el.innerHTML = `<span>"${escHtml(docTitle)}" deleted</span>`;
					const undoBtn = document.createElement('button');
					undoBtn.className = 'toast-undo-btn';
					undoBtn.textContent = 'Undo';
					undoBtn.type = 'button';
					const dismiss = () => {
						el.classList.add('toast-out');
						el.addEventListener('animationend', () => el.remove(), { once: true });
						setTimeout(() => el.remove(), 400);
					};
					undoBtn.addEventListener('click', () => {
						// Restore doc
						if (_lastDeletedDoc) {
							noteDocs.unshift(_lastDeletedDoc);
							if (activeUserId) saveDocsLocally(activeUserId);
							if (activeUserId && activeAccessToken) {
								restUpsertDoc(activeUserId, _lastDeletedDoc, activeAccessToken).catch(() => {});
							}
							renderDocList();
							switchDoc(_lastDeletedDoc.id);
							_lastDeletedDoc = null;
						}
						if (_undoDeleteTimer) { clearTimeout(_undoDeleteTimer); _undoDeleteTimer = null; }
						dismiss();
					});
					el.appendChild(undoBtn);
					toastContainer.appendChild(el);
					el.addEventListener('click', (e) => {
						if (e.target !== undoBtn) dismiss();
					});
					_undoDeleteTimer = setTimeout(() => {
						// Permanently delete from cloud after undo window
						if (_lastDeletedDoc && activeUserId && activeAccessToken) {
							restDeleteDoc(activeUserId, _lastDeletedDoc.id, activeAccessToken).catch(e => console.warn('Delete cloud:', e?.message));
						}
						_lastDeletedDoc = null;
						_undoDeleteTimer = null;
						dismiss();
					}, 5000);
				}

				if (deleteDocBtn) {
					deleteDocBtn.addEventListener('click', async () => {
						const doc = noteDocs.find(d => d.id === activeDocId);
						if (!doc) return;
						// Flush current content
						if (notesEl) doc.content = notesEl.value;
						_lastDeletedDoc = { ...doc };
						noteDocs = noteDocs.filter(d => d.id !== activeDocId);
						if (activeUserId) saveDocsLocally(activeUserId);
						// Don't delete from cloud yet — wait for undo window
						if (noteDocs.length === 0) { const d = createDoc('My Notes'); noteDocs.push(d); }
						switchDoc(noteDocs[0].id);
						renderDocList();
						showUndoToast(doc.title || 'Untitled');
					});
				}

				// ── Char limit warning ────────────────────────────────
				const CHAR_WARN_THRESHOLD  = 40000;
				const CHAR_LIMIT           = 50000;
				const charWarningEl = document.getElementById('notes-char-warning');

				function updateCharWarning() {
					if (!notesEl || !charWarningEl) return;
					const len = notesEl.value.length;
					notesEl.classList.remove('char-limit-near', 'char-limit-at');
					if (len >= CHAR_LIMIT) {
						notesEl.classList.add('char-limit-at');
						charWarningEl.textContent = `Character limit reached (${len} / ${CHAR_LIMIT})`;
						charWarningEl.classList.add('visible');
					} else if (len >= CHAR_WARN_THRESHOLD) {
						notesEl.classList.add('char-limit-near');
						charWarningEl.textContent = `${CHAR_LIMIT - len} characters remaining`;
						charWarningEl.classList.add('visible');
					} else {
						charWarningEl.classList.remove('visible');
					}
				}

				// ── Download single doc as .txt ──
				if (dlDocBtn) {
					dlDocBtn.addEventListener('click', () => {
						const doc = noteDocs.find(d => d.id === activeDocId);
						if (!doc) return;
						if (notesEl) doc.content = notesEl.value;
						const blob = new Blob([doc.content ?? ''], { type: 'text/plain' });
						const a = document.createElement('a');
						a.href = URL.createObjectURL(blob);
						a.download = `${(doc.title || 'note').replace(/[^\w\s-]/g, '')}.txt`;
						a.click();
						URL.revokeObjectURL(a.href);
					});
				}

				// ── Download single doc as .md ──
				const dlDocMdBtn = document.getElementById('btn-dl-doc-md');
				if (dlDocMdBtn) {
					dlDocMdBtn.addEventListener('click', () => {
						const doc = noteDocs.find(d => d.id === activeDocId);
						if (!doc) return;
						if (notesEl) doc.content = notesEl.value;
						// Prepend a simple markdown title heading
						const title = (doc.title || 'Note').replace(/[^\w\s-]/g, '');
						const mdContent = `# ${title}\n\n${doc.content ?? ''}`;
						const blob = new Blob([mdContent], { type: 'text/markdown' });
						const a = document.createElement('a');
						a.href = URL.createObjectURL(blob);
						a.download = `${title}.md`;
						a.click();
						URL.revokeObjectURL(a.href);
					});
				}

				// ── Download all docs as .zip (pure JS, no library needed) ──
				if (dlAllBtn) {
					dlAllBtn.addEventListener('click', async () => {
						// Flush current editor content
						if (activeDocId && notesEl) {
							const cur = noteDocs.find(d => d.id === activeDocId);
							if (cur) cur.content = notesEl.value;
						}
						const zip = buildZip(noteDocs.map(doc => ({
							name: `${(doc.title || 'note').replace(/[^\w\s-]/g, '') || 'note'}.txt`,
							data: doc.content ?? '',
						})));
						const blob = new Blob([zip], { type: 'application/zip' });
						const a = document.createElement('a');
						a.href = URL.createObjectURL(blob);
						a.download = 'notes.zip';
						a.click();
						URL.revokeObjectURL(a.href);
					});
				}

				// Minimal pure-JS ZIP builder (STORE method, no compression – fine for text)
				function buildZip(files) {
					const enc = new TextEncoder();
					const parts = [];
					const centralDir = [];
					let offset = 0;

					function u16(n) { const b = new Uint8Array(2); new DataView(b.buffer).setUint16(0, n, true); return b; }
					function u32(n) { const b = new Uint8Array(4); new DataView(b.buffer).setUint32(0, n, true); return b; }

					function crc32(data) {
						let crc = 0xFFFFFFFF;
						for (const byte of data) {
							crc ^= byte;
							for (let i = 0; i < 8; i++) crc = (crc & 1) ? (crc >>> 1) ^ 0xEDB88320 : crc >>> 1;
						}
						return (crc ^ 0xFFFFFFFF) >>> 0;
					}

					for (const file of files) {
						const nameBytes = enc.encode(file.name);
						const dataBytes = enc.encode(file.data);
						const crc = crc32(dataBytes);
						const local = new Uint8Array([
							...u32(0x04034b50), // local file header sig
							...u16(20), ...u16(0), ...u16(0), // version, flags, method (STORE)
							...u16(0), ...u16(0),             // mod time/date
							...u32(crc),
							...u32(dataBytes.length), ...u32(dataBytes.length), // compressed = uncompressed
							...u16(nameBytes.length), ...u16(0),
							...nameBytes,
							...dataBytes,
						]);
						parts.push(local);
						centralDir.push(new Uint8Array([
							...u32(0x02014b50), // central dir sig
							...u16(20), ...u16(20), ...u16(0), ...u16(0), ...u16(0),
							...u16(0), ...u16(0),
							...u32(crc),
							...u32(dataBytes.length), ...u32(dataBytes.length),
							...u16(nameBytes.length), ...u16(0), ...u16(0), ...u16(0), ...u16(0),
							...u32(0), ...u32(offset),
							...nameBytes,
						]));
						offset += local.length;
					}

					const cdSize = centralDir.reduce((s, b) => s + b.length, 0);
					const eocd = new Uint8Array([
						...u32(0x06054b50),
						...u16(0), ...u16(0),
						...u16(files.length), ...u16(files.length),
						...u32(cdSize), ...u32(offset),
						...u16(0),
					]);

					const total = [...parts, ...centralDir, eocd].reduce((s,b) => s+b.length, 0);
					const out = new Uint8Array(total);
					let pos = 0;
					for (const b of [...parts, ...centralDir, eocd]) { out.set(b, pos); pos += b.length; }
					return out;
				}

				// ── end multi-doc notes ─────────────────────────────────

				async function applySession(session, label) {
					if (applySessionInFlight) return applySessionInFlight;
					applySessionRun += 1;
					const runId = applySessionRun;
					const authLabel = label ? String(label) : 'unknown';
					applySessionInFlight = (async () => {
						try {
							const user = session?.user ?? null;
							if (!user) {
								activeUserId = null;
								const persistNote = canPersist ? '' : ' Storage blocked; session will not persist.';
								showLogin(`Signed out (auth ${authLabel} #${runId}).${persistNote}`);
								return;
							}

							activeUserId = user.id;
							const displayName = user.user_metadata?.username || user.email || 'Account';
							if (activeUsingRest) {
								showApp(`${displayName} (REST mode)`, user.email);
							} else {
							showApp(displayName, user.email);
							}
							await loadNotes(user.id);
						} catch (e) {
							activeUserId = null;
							showLogin(friendlyAuthError(e?.message || String(e)));
						} finally {
							applySessionInFlight = null;
						}
					})();
					return applySessionInFlight;
				}

				async function bootstrap() {
					const stopTick = startStatusTicker('Bootstrapping…');
					try {
						const status = await withTimeout(pingSupabase(), 6000, 'Supabase ping');
						const persistNote = canPersist ? '' : ' Storage blocked; session will not persist.';
						if (!inApp) setLoginDebugText(`Supabase ping: HTTP ${status}. Ready.${persistNote}`);
					} catch (e) {
						if (!inApp) setLoginDebugText(`Supabase error: ${friendlyAuthError(e?.message || String(e))}`);
					} finally {
						stopTick();
						// Hide splash screen after bootstrap completes
						if (window.__hideSplash) window.__hideSplash();
					}
				}

				function friendlyAuthError(messageRaw) {
					const message = String(messageRaw || 'Unknown error');
					if (message.toLowerCase().includes('email not confirmed')) {
						return 'Email not confirmed. Confirm it, or disable “Confirm email” in Supabase Auth settings.';
					}
					return message;
				}

				if (loginBtn) {
					loginBtn.addEventListener('click', async () => {
						setButtonsDisabled(true);
						try {
							const identifier = String(loginIdentifierEl?.value || '');
							const emailDirect = normalizeEmail(identifier);
							const username = emailDirect ? null : normalizeUsername(identifier);
							const password = String(loginPasswordEl?.value || '');
							if ((!emailDirect && !username) || !password) {
								showLogin('Enter username/email + password');
								return;
							}

							let email = emailDirect;
							if (!email && username) {
								try {
									const stopTick = startStatusTicker('Looking up username…');
									email = await withTimeout(lookupEmailForUsernameRest(username), AUTH_TIMEOUT_MS, 'Username lookup').finally(stopTick);
								} catch (e) {
									showLogin(friendlyAuthError(e?.message || String(e)));
									return;
								}
								if (!email) {
									showLogin('Username not found');
									return;
								}
							}

							showLogin('Signing in…');
							const tokenData = await signInWithPasswordXHR(email, password, AUTH_TIMEOUT_MS, (msg) => {
								if (!inApp) setLoginDebugText(`Signing in… ${msg}`);
							});

							const access_token = tokenData?.access_token;
							const refresh_token = tokenData?.refresh_token;
							if (!access_token || !refresh_token) {
								showLogin('Sign in failed: missing tokens from Supabase');
								return;
							}
							// Use REST mode directly (supabase-js session restore/apply is hanging in this environment)
							activeUsingRest = true;
							activeAccessToken  = access_token;
							activeRefreshToken = refresh_token;
							if (loginPasswordEl) loginPasswordEl.value = '';
							const user = tokenData?.user ?? null;
							setLoginStatusText('Entering app…');
							if (!enterRestMode(user, access_token)) return;
							// Allow the UI to paint before the notes fetch
							await new Promise((r) => window.requestAnimationFrame(() => r()));
							await loadNotes(user.id);
						} catch (e) {
							showLogin(friendlyAuthError(e?.message || String(e)));
						} finally {
							setButtonsDisabled(false);
						}
					});
				}

				if (signOutBtn) {
					signOutBtn.addEventListener('click', async () => {
						try {
							if (!activeUsingRest) {
								try {
									await withTimeout(supabase.auth.signOut(), AUTH_TIMEOUT_MS, 'Sign out');
								} catch {
									// ignore supabase sign-out errors; we clear local state regardless
								}
							}
						} finally {
							// Clear all local auth state immediately.
							activeUsingRest = false;
							activeUser = null;
							activeAccessToken  = null;
							activeRefreshToken = null;
							activeUserId = null;
							if (_idleTimer) { clearTimeout(_idleTimer); _idleTimer = null; }
							// Reset the in-flight guard so a second sign-out/login is never blocked.
							applySessionInFlight = null;
							// Clear notes search
							noteSearchQuery = '';
							if (notesSearchEl) notesSearchEl.value = '';
							if (wordCountEl) wordCountEl.textContent = '';
							// Clear account badges and home info
							if (acctBadgesEl) acctBadgesEl.innerHTML = '';
							if (homeLastSigninEl) { homeLastSigninEl.hidden = true; homeLastSigninEl.textContent = ''; }
							// Hide home dashboard sections
							const homeStats = document.getElementById('home-stats');
							const homeRecent = document.getElementById('home-recent-files');
							if (homeStats) homeStats.hidden = true;
							if (homeRecent) homeRecent.hidden = true;
							// Hide new home sections
							['home-greeting','home-quick-actions','home-activity','home-pinned-notes','home-recent-notes'].forEach(id => {
								const el = document.getElementById(id);
								if (el) el.hidden = true;
							});
							const signedOut = document.getElementById('home-signed-out');
							if (signedOut) signedOut.hidden = false;
							_cachedFiles = [];
							// Reset preferences to defaults
							applyPrefs({ accentIndex: 0, fontSize: 'medium', cardWidth: 'regular', bgStyle: 'aurora', density: 'normal' });
							showLogin('Signed out.');
						}
					});
				}

				if (updateUsernameBtn) {
					updateUsernameBtn.addEventListener('click', async () => {
						try {
							if (!activeUserId || !activeAccessToken || !activeUser) {
								setAccountStatus('Not signed in');
								return;
							}
							const newUsername = normalizeUsername(acctUsernameEl?.value);
							if (!newUsername) {
								setAccountStatus('Enter a valid username');
								return;
							}

							setAccountStatus('Checking username…');
							const takenByEmail = await withTimeout(lookupEmailForUsernameRest(newUsername), AUTH_TIMEOUT_MS, 'Username lookup');
							if (takenByEmail && String(takenByEmail).toLowerCase() !== String(activeUser.email || '').toLowerCase()) {
								setAccountStatus('That username is taken');
								return;
							}

							setAccountStatus('Updating username…');
							const updated = await authUpdateUserXHR(activeAccessToken, { data: { username: newUsername } }, AUTH_TIMEOUT_MS);
							activeUser = updated || activeUser;
							if (!activeUser.user_metadata) activeUser.user_metadata = {};
							activeUser.user_metadata.username = newUsername;

							setAccountStatus('Saving username mapping…');
							await withTimeout(restSaveUsernameMapping(newUsername, activeUserId, activeUser.email, activeAccessToken), AUTH_TIMEOUT_MS, 'Saving username');

							enterRestMode(activeUser, activeAccessToken);
							setAccountStatus('Username updated');
							if (acctUsernameEl) acctUsernameEl.value = '';
						} catch (e) {
							setAccountStatus(friendlyAuthError(e?.message || String(e)));
						}
					});
				}

				if (updatePasswordBtn) {
					updatePasswordBtn.addEventListener('click', async () => {
						try {
							if (!activeAccessToken) {
								setAccountStatus('Not signed in');
								return;
							}
							const newPassword = String(acctPasswordEl?.value || '');
							if (!newPassword) {
								setAccountStatus('Enter a new password');
								return;
							}
							setAccountStatus('Updating password…');
							await authUpdateUserXHR(activeAccessToken, { password: newPassword }, AUTH_TIMEOUT_MS);
							if (acctPasswordEl) acctPasswordEl.value = '';
							setAccountStatus('Password updated');
						} catch (e) {
							setAccountStatus(friendlyAuthError(e?.message || String(e)));
						}
					});
				}

				if (deleteAccountBtn) {
					deleteAccountBtn.addEventListener('click', async () => {
						try {
							if (!activeUserId || !activeAccessToken) {
								setAccountStatus('Not signed in');
								return;
							}
							const ok = window.confirm('Delete your account? This will delete your notes and username mapping too.');
							if (!ok) return;

							setAccountStatus('Deleting notes…');
							await withTimeout(restDeleteByUserId('notes', activeUserId, activeAccessToken), AUTH_TIMEOUT_MS, 'Delete notes');
							setAccountStatus('Deleting username mapping…');
							await withTimeout(restDeleteByUserId('usernames', activeUserId, activeAccessToken), AUTH_TIMEOUT_MS, 'Delete usernames');
							setAccountStatus('Deleting auth account…');
							try {
								await withTimeout(deleteAccountViaFunction(activeAccessToken), AUTH_TIMEOUT_MS, 'Delete account');
							} catch (e) {
								setAccountStatus(
									`Deleted your data, but could not delete the auth user. ${friendlyAuthError(e?.message || String(e))}`,
								);
								return;
							}

							activeUsingRest = false;
							activeUser = null;
							activeAccessToken = null;
							activeUserId = null;
							showLogin('Account deleted');
						} catch (e) {
							setAccountStatus(friendlyAuthError(e?.message || String(e)));
						}
					});
				}

				// ── Files tab ────────────────────────────────────────────────────────
				const FILES_BUCKET = 'user-files';

				const filesUploadZoneEl = document.getElementById('files-upload-zone');
				const filesInputEl = document.getElementById('files-input');
				const filesUploadProgressEl = document.getElementById('files-upload-progress');
				const filesUploadBarEl = document.getElementById('files-upload-bar');
				const filesStatusEl = document.getElementById('files-status');
				const fileListEl = document.getElementById('file-list');

				function setFilesStatus(text) {
					if (filesStatusEl) filesStatusEl.textContent = text || '';
				}

				function formatBytes(bytes) {
					if (bytes == null) return '';
					if (bytes < 1024) return `${bytes} B`;
					if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
					return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
				}

				function formatDate(iso) {
					if (!iso) return '';
					try {
						return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
					} catch {
						return '';
					}
				}

				// Storage path is user-scoped so RLS/policies can gate by prefix.
				function storagePath(fileName) {
					return `${activeUserId}/${fileName}`;
				}

				async function storageListFiles() {
					const res = await fetch(
						`${SUPABASE_URL}/storage/v1/object/list/${FILES_BUCKET}`,
						{
							method: 'POST',
							headers: {
								apikey: SUPABASE_ANON_KEY,
								Authorization: `Bearer ${activeAccessToken}`,
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({ prefix: `${activeUserId}/`, limit: 200, offset: 0, sortBy: { column: 'created_at', order: 'desc' } }),
						},
					);
					if (!res.ok) throw new Error(`List files failed (HTTP ${res.status})`);
					const items = await res.json();
					// Filter out placeholder folders (name ends with /)
					return (Array.isArray(items) ? items : []).filter((f) => f.name && !f.name.endsWith('/'));
				}

				async function storageUploadFile(file, onProgress) {
					// Use XHR so we can get upload progress.
					const path = storagePath(file.name);
					return new Promise((resolve, reject) => {
						const xhr = new XMLHttpRequest();
						// Use PUT with upsert header so re-uploading the same file works.
						xhr.open('POST', `${SUPABASE_URL}/storage/v1/object/${FILES_BUCKET}/${encodeURIComponent(path)}`, true);
						xhr.setRequestHeader('apikey', SUPABASE_ANON_KEY);
						xhr.setRequestHeader('Authorization', `Bearer ${activeAccessToken}`);
						xhr.setRequestHeader('x-upsert', 'true');
						xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
						xhr.upload.onprogress = (e) => {
							if (e.lengthComputable) onProgress?.(e.loaded / e.total);
						};
						xhr.onload = () => {
							if (xhr.status >= 200 && xhr.status < 300) {
								resolve();
							} else {
								let msg = `Upload failed (HTTP ${xhr.status})`;
								try { const b = JSON.parse(xhr.responseText); if (b?.message) msg = b.message; } catch {}
								reject(new Error(msg));
							}
						};
						xhr.onerror = () => reject(new Error('Upload network error'));
						xhr.send(file);
					});
				}

				async function storageDeleteFile(fileName) {
					const path = storagePath(fileName);
					const res = await fetch(
						`${SUPABASE_URL}/storage/v1/object/${FILES_BUCKET}/${encodeURIComponent(path)}`,
						{
							method: 'DELETE',
							headers: {
								apikey: SUPABASE_ANON_KEY,
								Authorization: `Bearer ${activeAccessToken}`,
							},
						},
					);
					if (!res.ok) throw new Error(`Delete failed (HTTP ${res.status})`);
				}

				function storageDownloadUrl(fileName) {
					// Authenticated download via signed URL approach — just link directly with the token.
					const path = storagePath(fileName);
					return `${SUPABASE_URL}/storage/v1/object/authenticated/${FILES_BUCKET}/${encodeURIComponent(path)}`;
				}

				async function storageDownloadFile(fileName) {
					const path = storagePath(fileName);
					const res = await fetch(
						`${SUPABASE_URL}/storage/v1/object/${FILES_BUCKET}/${encodeURIComponent(path)}`,
						{
							headers: {
								apikey: SUPABASE_ANON_KEY,
								Authorization: `Bearer ${activeAccessToken}`,
							},
						},
					);
					if (!res.ok) throw new Error(`Download failed (HTTP ${res.status})`);
					const blob = await res.blob();
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = fileName;
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);
				}

				async function refreshFileList() {
					if (!activeUserId || !activeAccessToken) return;
					setFilesStatus('Loading…');
					try {
						const files = await withTimeout(storageListFiles(), AUTH_TIMEOUT_MS, 'List files');
						renderFileList(files);
						setFilesStatus(files.length === 0 ? 'No files yet.' : '');
					} catch (e) {
						console.error('Files list error', e);
						setFilesStatus(`Failed to load files: ${e?.message || e}`);
					}
				}

				function fileTypeIcon(name) {
					const ext = (name.split('.').pop() || '').toLowerCase();
					const map = {
						pdf: '📄', doc: '📓', docx: '📓', txt: '📝', md: '📝',
						xls: '📊', xlsx: '📊', csv: '📊',
						ppt: '📈', pptx: '📈',
						zip: '🗂', rar: '🗂', gz: '🗂', tar: '🗂',
						js: '💻', ts: '💻', py: '💻', html: '💻', css: '💻', json: '💻',
						mp3: '🎵', wav: '🎵', ogg: '🎵', flac: '🎵',
						mp4: '🎥', mov: '🎥', avi: '🎥', mkv: '🎥',
						png: '🖼', jpg: '🖼', jpeg: '🖼', gif: '🖼', webp: '🖼', svg: '🖼', ico: '🖼', avif: '🖼',
					};
					return map[ext] || '📁';
				}

				const IMAGE_EXTS = new Set(['png','jpg','jpeg','gif','webp','avif','svg']);
				function isImageFile(name) {
					return IMAGE_EXTS.has((name.split('.').pop() || '').toLowerCase());
				}

				function renderFileList(files) {
					if (!fileListEl) return;
					fileListEl.innerHTML = '';

					// Show/hide file search bar and controls row
					const fileSearchRow = document.getElementById('file-search-row');
					const fileSearchInput = document.getElementById('file-search-input');
					const filesControlsRow = document.getElementById('files-controls-row');
					if (fileSearchRow) fileSearchRow.hidden = files.length === 0;
					if (filesControlsRow) filesControlsRow.hidden = files.length === 0;
					if (fileSearchInput) fileSearchInput.value = '';
					updateBulkDeleteBtn();

					// Apply sort
					const sorted = [...files];
					sorted.sort((a, b) => {
						const getSize = f => Number(f.metadata?.size ?? f.metadata?.contentLength ?? 0);
						const getDate = f => new Date(f.created_at || f.updated_at || 0);
						switch (fileSortOrder) {
							case 'name-asc':  return (a.name || '').localeCompare(b.name || '');
							case 'name-desc': return (b.name || '').localeCompare(a.name || '');
							case 'size-desc': return getSize(b) - getSize(a);
							case 'size-asc':  return getSize(a) - getSize(b);
							case 'date-asc':  return getDate(a) - getDate(b);
							default:          return getDate(b) - getDate(a); // date-desc
						}
					});

					// Storage usage bar
					const storageWrap = document.getElementById('storage-bar-wrap');
					const storageFill = document.getElementById('storage-bar-fill');
					const storageUsedEl = document.getElementById('storage-bar-used');
					if (storageWrap && files.length > 0) {
						const usedBytes = files.reduce((sum, f) => {
							const s = f.metadata?.size ?? f.metadata?.contentLength ?? 0;
							return sum + (Number(s) || 0);
						}, 0);
						const LIMIT = 1024 * 1024 * 1024; // 1 GB
						const pct = Math.min(100, (usedBytes / LIMIT) * 100);
						if (storageUsedEl) storageUsedEl.textContent = formatBytes(usedBytes) + ' used';
						if (storageFill) storageFill.style.width = `${pct.toFixed(1)}%`;
						storageWrap.hidden = false;
					} else if (storageWrap) {
						storageWrap.hidden = true;
					}

					// Update recent files on Home
					renderRecentFiles(files);

					for (const f of sorted) {
						const row = document.createElement('div');
						row.className = 'file-row';

						// Checkbox for bulk select
						const checkbox = document.createElement('input');
						checkbox.type = 'checkbox';
						checkbox.className = 'file-row-check';
						checkbox.dataset.filename = f.name;
						checkbox.setAttribute('aria-label', `Select ${f.name}`);
						checkbox.addEventListener('change', updateBulkDeleteBtn);
						row.appendChild(checkbox);

						// Icon or thumbnail
						const TEXT_PREVIEW_EXTS = new Set(['txt','md','json','js','ts','py','html','css','csv','log','xml','yaml','yml']);
						const ext = (f.name.split('.').pop() || '').toLowerCase();
						if (isImageFile(f.name)) {
							const imgWrap = document.createElement('button');
							imgWrap.className = 'file-row-preview-btn';
							imgWrap.type = 'button';
							imgWrap.title = 'Preview';
							imgWrap.style.cssText = 'background:none;border:none;padding:0;cursor:zoom-in;display:contents';
							const img = document.createElement('img');
							img.className = 'file-row-thumb';
							img.alt = f.name;
							img.loading = 'lazy';
							// Load via authenticated fetch then blob URL
							const path = storagePath(f.name);
							let blobUrl = null;
							fetch(`${SUPABASE_URL}/storage/v1/object/${FILES_BUCKET}/${encodeURIComponent(path)}`, {
								headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${activeAccessToken}` }
							}).then(r => r.ok ? r.blob() : null).then(blob => {
								if (blob) { blobUrl = URL.createObjectURL(blob); img.src = blobUrl; }
							}).catch(() => {});
							imgWrap.addEventListener('click', () => {
								const bigImg = document.createElement('img');
								if (blobUrl) { bigImg.src = blobUrl; } else if (img.src) { bigImg.src = img.src; }
								openLightbox(bigImg, f.name);
							});
							imgWrap.appendChild(img);
							row.appendChild(imgWrap);
						} else {
							const iconEl = document.createElement('span');
							iconEl.className = 'file-row-icon';
							iconEl.setAttribute('aria-hidden', 'true');
							iconEl.textContent = fileTypeIcon(f.name);
							row.appendChild(iconEl);
						}

						const nameEl = document.createElement('span');
						nameEl.className = 'file-row-name';
						nameEl.textContent = f.name;

						const metaEl = document.createElement('span');
						metaEl.className = 'file-row-meta';
						const size = f.metadata?.size ?? f.metadata?.contentLength ?? null;
						const date = f.created_at || f.updated_at || null;
						metaEl.textContent = [formatBytes(size), formatDate(date)].filter(Boolean).join(' · ');

						const actionsEl = document.createElement('div');
						actionsEl.className = 'file-row-actions';

						const copyBtn = document.createElement('button');
						copyBtn.className = 'btn btn-small';
						copyBtn.textContent = '🔗';
						copyBtn.title = 'Copy link';
						copyBtn.type = 'button';
						copyBtn.setAttribute('aria-label', 'Copy download link');
						copyBtn.addEventListener('click', async () => {
							try {
								// Generate a signed URL (1 hour)
								const path = storagePath(f.name);
								const res = await fetch(`${SUPABASE_URL}/storage/v1/object/sign/${FILES_BUCKET}/${encodeURIComponent(path)}`, {
									method: 'POST',
									headers: {
										apikey: SUPABASE_ANON_KEY,
										Authorization: `Bearer ${activeAccessToken}`,
										'Content-Type': 'application/json',
									},
									body: JSON.stringify({ expiresIn: 3600 }),
								});
								if (!res.ok) throw new Error(`HTTP ${res.status}`);
								const data = await res.json();
								const signedUrl = data?.signedURL ? `${SUPABASE_URL}/storage/v1${data.signedURL}` : data?.signedUrl;
								if (!signedUrl) throw new Error('No URL returned');
								// Clipboard API is blocked on http:// — fall back to execCommand
								let copied = false;
								if (navigator.clipboard?.writeText) {
									try { await navigator.clipboard.writeText(signedUrl); copied = true; } catch { /* fall through */ }
								}
								if (!copied) {
									const ta = document.createElement('textarea');
									ta.value = signedUrl;
									ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0';
									document.body.appendChild(ta);
									ta.select(); ta.setSelectionRange(0, 99999);
									try { copied = document.execCommand('copy'); } catch { /* ignore */ }
									document.body.removeChild(ta);
								}
								if (copied) {
									showToast('Link copied! Valid for 1 hour.', 'success');
								} else {
									window.prompt('Copy this link (valid 1 hour):', signedUrl);
								}
							} catch (e) {
								showToast(`Copy failed: ${e?.message}`, 'error');
							}
						});

						const dlBtn = document.createElement('button');
						dlBtn.className = 'btn btn-small';
						dlBtn.textContent = 'Download';
						dlBtn.type = 'button';
						dlBtn.addEventListener('click', async () => {
							dlBtn.disabled = true;
							try {
								await storageDownloadFile(f.name);
							} catch (e) {
								showToast(`Download failed: ${e?.message}`, 'error');
							} finally {
								dlBtn.disabled = false;
							}
						});

						const delBtn = document.createElement('button');
						delBtn.className = 'btn btn-small';
						delBtn.textContent = 'Delete';
						delBtn.type = 'button';
						delBtn.addEventListener('click', async () => {
							if (!window.confirm(`Delete "${f.name}"?`)) return;
							delBtn.disabled = true;
							try {
								await withTimeout(storageDeleteFile(f.name), AUTH_TIMEOUT_MS, 'Delete file');
								showToast(`${f.name} deleted`, 'success');
								await refreshFileList();
							} catch (e) {
								showToast(`Delete failed: ${e?.message}`, 'error');
								delBtn.disabled = false;
							}
						});

						actionsEl.appendChild(copyBtn);
						// Preview button for text-like files
						if (TEXT_PREVIEW_EXTS.has(ext)) {
							const previewBtn = document.createElement('button');
							previewBtn.className = 'btn btn-small';
							previewBtn.textContent = '👁';
							previewBtn.title = 'Preview file';
							previewBtn.type = 'button';
							previewBtn.addEventListener('click', async () => {
								try {
									previewBtn.disabled = true;
									const path = storagePath(f.name);
									const res = await fetch(`${SUPABASE_URL}/storage/v1/object/${FILES_BUCKET}/${encodeURIComponent(path)}`, {
										headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${activeAccessToken}` }
									});
									if (!res.ok) throw new Error(`HTTP ${res.status}`);
									const text = await res.text();
									const pre = document.createElement('pre');
									pre.textContent = text.slice(0, 50000);
									openLightbox(pre, f.name);
								} catch (err) {
									showToast('Preview failed: ' + (err?.message ?? err), 'error');
								} finally {
									previewBtn.disabled = false;
								}
							});
							actionsEl.appendChild(previewBtn);
						}
						actionsEl.appendChild(dlBtn);
						actionsEl.appendChild(delBtn);
						row.appendChild(nameEl);
						row.appendChild(metaEl);
						row.appendChild(actionsEl);
						fileListEl.appendChild(row);
					}
				}

				async function handleUploadFiles(fileList) {
					if (!fileList || !fileList.length) return;
					const files = Array.from(fileList);
					if (filesUploadProgressEl) filesUploadProgressEl.classList.add('visible');
					let done = 0;
					const errors = [];
					for (const file of files) {
						setFilesStatus(`Uploading ${file.name}…`);
						try {
							await storageUploadFile(file, (pct) => {
								const overall = (done + pct) / files.length;
								if (filesUploadBarEl) filesUploadBarEl.style.width = `${Math.round(overall * 100)}%`;
							});
							done += 1;
							if (filesUploadBarEl) filesUploadBarEl.style.width = `${Math.round((done / files.length) * 100)}%`;
						} catch (e) {
							console.error('Upload error', e);
							errors.push(`${file.name}: ${e?.message || e}`);
						}
					}
					if (filesUploadProgressEl) filesUploadProgressEl.classList.remove('visible');
					if (filesUploadBarEl) filesUploadBarEl.style.width = '0%';
					if (filesInputEl) filesInputEl.value = '';
					if (errors.length) {
						setFilesStatus(`Errors: ${errors.join('; ')}`);
					} else {
						setFilesStatus(`${done} file${done !== 1 ? 's' : ''} uploaded.`);
					}
					await refreshFileList();
				}

				// Click to open file picker
				if (filesUploadZoneEl && filesInputEl) {
					filesUploadZoneEl.addEventListener('click', (e) => {
						if (e.target === filesInputEl) return;
						filesInputEl.click();
					});
					filesUploadZoneEl.addEventListener('keydown', (e) => {
						if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); filesInputEl.click(); }
					});
					filesInputEl.addEventListener('change', () => handleUploadFiles(filesInputEl.files));
				}

				// Drag-and-drop
				if (filesUploadZoneEl) {
					filesUploadZoneEl.addEventListener('dragover', (e) => { e.preventDefault(); filesUploadZoneEl.classList.add('drag-over'); });
					filesUploadZoneEl.addEventListener('dragleave', () => filesUploadZoneEl.classList.remove('drag-over'));
					filesUploadZoneEl.addEventListener('drop', (e) => {
						e.preventDefault();
						filesUploadZoneEl.classList.remove('drag-over');
						handleUploadFiles(e.dataTransfer?.files);
					});
				}

				// Refresh file list whenever the Files tab becomes active
				const filesTab = document.getElementById('tab-files');
				if (filesTab) {
					filesTab.addEventListener('click', () => {
						if (activeUserId && activeAccessToken) refreshFileList();
					});
				}

				// Refresh stats whenever Home tab becomes active
				const homeTab = document.getElementById('tab-home');
				if (homeTab) {
					homeTab.addEventListener('click', () => {
						if (activeUserId) renderStats();
					});
				}

				// ── Preferences ────────────────────────────────────────────────

				const ACCENT_PRESETS = [
					{ name: 'Indigo',  light: '#5b6ef5', dark: '#818cf8' },
					{ name: 'Violet',  light: '#7c3aed', dark: '#a78bfa' },
					{ name: 'Pink',    light: '#db2777', dark: '#f472b6' },
					{ name: 'Rose',    light: '#e11d48', dark: '#fb7185' },
					{ name: 'Amber',   light: '#d97706', dark: '#fbbf24' },
					{ name: 'Emerald', light: '#059669', dark: '#34d399' },
					{ name: 'Cyan',    light: '#0891b2', dark: '#22d3ee' },
				];

				// Current pref state (defaults)
				let currentPrefs = {
					accentIndex: 0,   // index into ACCENT_PRESETS
					fontSize:    'medium',
					cardWidth:   'regular',
					bgStyle:     'aurora',
					density:     'normal',   // compact | normal | comfortable
					// NEW fields
					appTitle:    '',
					appSubtitle: '',
					autoLock:    'off',
					wordGoal:    0,
				};

				const FONT_SCALE   = { small: 0.88, medium: 1, large: 1.15 };
				const CARD_SCALE   = { compact: 0.72, regular: 1, wide: 1.22 };

				// Base card-max values (read from the stylesheet's --card-max at each bp).
				// We store base values and multiply by CARD_SCALE.
				const BASE_CARD_MAX = { base: 1060, md: 1200, lg: 1420, xl: 1680 };
				const BASE_FONT     = { base: 15, md: 16, lg: 17, xl: 18 };

				function applyPrefs(prefs) {
					currentPrefs = { ...currentPrefs, ...prefs };
					const root = document.documentElement;
					const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
					const preset = ACCENT_PRESETS[currentPrefs.accentIndex] ?? ACCENT_PRESETS[0];

					// Accent colour
					const accentColor  = isDark ? preset.dark  : preset.light;
					const accent2Color = isDark
						? ACCENT_PRESETS[(currentPrefs.accentIndex + 1) % ACCENT_PRESETS.length].dark
						: ACCENT_PRESETS[(currentPrefs.accentIndex + 1) % ACCENT_PRESETS.length].light;

					root.style.setProperty('--accent', accentColor);
					root.style.setProperty('--accent-2', accent2Color);
					// Recompute glow from accent
					root.style.setProperty('--accent-glow',   hexToRgba(accentColor,  isDark ? 0.25 : 0.22));
					root.style.setProperty('--accent-glow-2', hexToRgba(accent2Color, isDark ? 0.16 : 0.14));
					root.style.setProperty('--ring',          hexToRgba(accentColor,  isDark ? 0.40 : 0.35));

					// Font size
					const fs = FONT_SCALE[currentPrefs.fontSize] ?? 1;
					root.style.setProperty('--base-font',   `${Math.round(BASE_FONT.base * fs)}px`);

					// Card width
					const cw = CARD_SCALE[currentPrefs.cardWidth] ?? 1;
					root.style.setProperty('--card-max', `${Math.round(BASE_CARD_MAX.base * cw)}px`);

					// Background style
					applyBgStyle(currentPrefs.bgStyle);

					// Note density
					document.body.classList.remove('density-compact', 'density-normal', 'density-comfortable');
					if (currentPrefs.density && currentPrefs.density !== 'normal') {
						document.body.classList.add(`density-${currentPrefs.density}`);
					}

					// Custom app title / subtitle
					const h1El = document.querySelector('#app h1');
					const subtitleEl = document.querySelector('#app .subtitle');
					if (h1El && currentPrefs.appTitle) h1El.textContent = currentPrefs.appTitle;
					if (subtitleEl && currentPrefs.appSubtitle) subtitleEl.textContent = currentPrefs.appSubtitle;

					// Word-goal
					wordGoal = Number(currentPrefs.wordGoal) || 0;
					updateWordGoal();

					// Auto-lock timer
					resetIdleTimer();

					// Re-apply accent index with correct dark/light palette
					// (already done above, but re-apply accent prefs to handle theme override)
					if (typeof applyTheme === 'function') {
						// Keep accent vars correct after theme toggle
						const newPreset = ACCENT_PRESETS[currentPrefs.accentIndex] ?? ACCENT_PRESETS[0];
						const isDarkNow = document.body.classList.contains('theme-dark') ||
							(!document.body.classList.contains('theme-light') && window.matchMedia('(prefers-color-scheme: dark)').matches);
						root.style.setProperty('--accent', isDarkNow ? newPreset.dark : newPreset.light);
						const next2 = ACCENT_PRESETS[(currentPrefs.accentIndex + 1) % ACCENT_PRESETS.length];
						root.style.setProperty('--accent-2', isDarkNow ? next2.dark : next2.light);
					}

					// Sync UI
					syncPrefsUI();
				}

				function applyBgStyle(style) {
					const body = document.body;
					// Remove any previously set custom bg class
					body.classList.remove('bg-aurora', 'bg-subtle', 'bg-minimal');
					body.classList.add(`bg-${style}`);
				}

				function hexToRgba(hex, alpha) {
					const h = hex.replace('#', '');
					const r = parseInt(h.slice(0,2),16);
					const g = parseInt(h.slice(2,4),16);
					const b = parseInt(h.slice(4,6),16);
					return `rgba(${r},${g},${b},${alpha})`;
				}

				// Inject dynamic bg-style rules once
				(function injectBgStyleRules() {
					const s = document.createElement('style');
					s.id = 'bg-style-rules';
					s.textContent = `
						body.bg-subtle::after { opacity: 0.45 !important; }
						body.bg-minimal::after { display: none !important; }
						body.bg-minimal {
							background: var(--bg) !important;
						}
					`;
					document.head.appendChild(s);
				})();

				// Build swatch row
				(function buildSwatches() {
					const row = document.getElementById('swatch-row');
					if (!row) return;
					const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
					ACCENT_PRESETS.forEach((p, i) => {
						const btn = document.createElement('button');
						btn.className = 'swatch';
						btn.type = 'button';
						btn.title = p.name;
						btn.setAttribute('aria-label', p.name);
						btn.dataset.index = String(i);
						btn.style.background = isDark ? p.dark : p.light;
						btn.addEventListener('click', () => {
							currentPrefs.accentIndex = i;
							applyPrefs(currentPrefs);
						});
						row.appendChild(btn);
					});
				})();

				function syncPrefsUI() {
					// Swatches
					document.querySelectorAll('.swatch').forEach(s => {
						s.classList.toggle('active', Number(s.dataset.index) === currentPrefs.accentIndex);
					});
					// Chips
					[
						{ id: 'chips-fontsize',  key: 'fontSize'  },
						{ id: 'chips-cardwidth', key: 'cardWidth' },
						{ id: 'chips-bgstyle',   key: 'bgStyle'   },
						{ id: 'chips-density',   key: 'density'   },
						{ id: 'chips-autolock',  key: 'autoLock'  },
					].forEach(({ id, key }) => {
						document.querySelectorAll(`#${id} .chip`).forEach(c => {
							c.classList.toggle('active', c.dataset.val === String(currentPrefs[key]));
						});
					});
					// Custom title inputs
					const titleInp = document.getElementById('pref-app-title');
					const subInp   = document.getElementById('pref-app-subtitle');
					if (titleInp && currentPrefs.appTitle)    titleInp.value = currentPrefs.appTitle;
					if (subInp   && currentPrefs.appSubtitle) subInp.value   = currentPrefs.appSubtitle;
				}

				// Wire chip clicks
				['chips-fontsize','chips-cardwidth','chips-bgstyle','chips-density','chips-autolock'].forEach(id => {
					const container = document.getElementById(id);
					if (!container) return;
					const key = id === 'chips-fontsize'  ? 'fontSize'
					          : id === 'chips-cardwidth' ? 'cardWidth'
					          : id === 'chips-density'   ? 'density'
					          : id === 'chips-autolock'  ? 'autoLock'
					          : 'bgStyle';
					container.addEventListener('click', e => {
						const chip = e.target.closest('.chip');
						if (!chip) return;
						currentPrefs[key] = chip.dataset.val;
						applyPrefs(currentPrefs);
					});
				});

				// ── Apply title button ──────────────────────────────────
				document.getElementById('btn-apply-title')?.addEventListener('click', () => {
					const t = (document.getElementById('pref-app-title')?.value ?? '').trim();
					const s = (document.getElementById('pref-app-subtitle')?.value ?? '').trim();
					currentPrefs.appTitle    = t;
					currentPrefs.appSubtitle = s;
					applyPrefs(currentPrefs);
					showToast('App title updated', 'success');
				});

				// REST helpers for preferences table
				async function restGetPrefs(userId, accessToken) {
					const url = `${SUPABASE_URL}/rest/v1/preferences?select=prefs&user_id=eq.${encodeURIComponent(userId)}&limit=1`;
					const res = await fetch(url, {
						headers: {
							apikey: SUPABASE_ANON_KEY,
							Authorization: `Bearer ${accessToken}`,
							Accept: 'application/json',
						},
					});
					if (!res.ok) {
						let detail = '';
						try { detail = await res.text(); } catch { /* ignore */ }
						throw new Error(`Prefs load failed (HTTP ${res.status})${detail ? ': ' + detail : ''}`);
					}
					const arr = await res.json();
					return Array.isArray(arr) && arr.length ? (arr[0]?.prefs ?? null) : null;
				}

				async function restUpsertPrefs(userId, prefs, accessToken) {
					const res = await fetch(`${SUPABASE_URL}/rest/v1/preferences?on_conflict=user_id`, {
						method: 'POST',
						headers: {
							apikey: SUPABASE_ANON_KEY,
							Authorization: `Bearer ${accessToken}`,
							'Content-Type': 'application/json',
							Prefer: 'resolution=merge-duplicates',
							Accept: 'application/json',
						},
						body: JSON.stringify([{ user_id: userId, prefs }]),
					});
					if (!res.ok) {
						let detail = '';
						try { detail = await res.text(); } catch { /* ignore */ }
						throw new Error(`HTTP ${res.status}${detail ? ': ' + detail : ''}`);
					}
				}

				// localStorage key scoped to user so multiple accounts work
				function prefsLocalKey(userId) { return `ectl_prefs_${userId}`; }

				function savePrefsLocally(userId, prefs) {
					try { localStorage.setItem(prefsLocalKey(userId), JSON.stringify(prefs)); } catch { /* ignore */ }
				}

				function loadPrefsLocally(userId) {
					try {
						const raw = localStorage.getItem(prefsLocalKey(userId));
						return raw ? JSON.parse(raw) : null;
					} catch { return null; }
				}

				async function loadPrefs(userId) {
					try {
						const saved = await restGetPrefs(userId, activeAccessToken);
						if (saved && typeof saved === 'object') {
							applyPrefs(saved);
							savePrefsLocally(userId, saved); // keep local copy in sync
							return;
						}
					} catch (e) {
						console.warn('Prefs cloud load failed, trying localStorage:', e?.message);
					}
					// Fall back to localStorage (works without the DB table)
					const local = loadPrefsLocally(userId);
					applyPrefs(local ?? currentPrefs);
					window._loadRptContacts?.();
				}

				const prefsStatusEl  = document.getElementById('prefs-status');
				const savePrefsBtn   = document.getElementById('btn-save-prefs');

				function setPrefsStatus(msg) {
					if (prefsStatusEl) prefsStatusEl.textContent = msg;
				}

				if (savePrefsBtn) {
					savePrefsBtn.addEventListener('click', async () => {
						if (!activeUserId || !activeAccessToken) {
							setPrefsStatus('Not signed in.');
							return;
						}
						savePrefsBtn.disabled = true;
						setPrefsStatus('Saving…');
						// Always save locally first — this never fails
						savePrefsLocally(activeUserId, currentPrefs);
						try {
							await withTimeout(restUpsertPrefs(activeUserId, currentPrefs, activeAccessToken), AUTH_TIMEOUT_MS, 'Prefs save');
							setPrefsStatus('Saved!');
						} catch (e) {
							console.error('Prefs cloud save failed:', e?.message);
							// Local save already succeeded — tell user
							setPrefsStatus(`Saved locally (cloud: ${e?.message ?? 'error'})`);
						} finally {
							savePrefsBtn.disabled = false;
							setTimeout(() => setPrefsStatus(''), 3500);
						}
					});
				}

				// ── end preferences ─────────────────────────────────────────────

				// ── Account Manager ──────────────────────────────────────────────
				(function initAccountManager() {
					const MANAGED_USERS_KEY = 'ectl_managed_users'; // [{email, username, isAdmin, createdAt, imported?}]

					function getManagedUsers() {
						try { return JSON.parse(localStorage.getItem(MANAGED_USERS_KEY) || '[]'); } catch { return []; }
					}
					function putManagedUsers(arr) {
						try { localStorage.setItem(MANAGED_USERS_KEY, JSON.stringify(arr)); } catch {}
					}
					function syncAdminEmailsCache(arr) {
						const admins = arr.filter(u => u.isAdmin).map(u => u.email);
						try { localStorage.setItem(ADMIN_EMAILS_KEY, JSON.stringify(admins)); } catch {}
					}

					// Fetch all rows from the usernames table and merge any unknown ones into localStorage
					async function importUsernamesTable() {
						const token = activeAccessToken;
						if (!token) return;
						try {
							const res = await fetch(`${SUPABASE_URL}/rest/v1/usernames?select=username,email`, {
								headers: {
									apikey: SUPABASE_ANON_KEY,
									Authorization: `Bearer ${token}`,
									Accept: 'application/json',
								},
							});
							if (!res.ok) return;
							const rows = await res.json();
							if (!Array.isArray(rows)) return;
							const arr = getManagedUsers();
							let changed = false;
							for (const row of rows) {
								const email = (row.email || '').trim().toLowerCase();
								if (!email) continue;
								if (!arr.find(u => u.email === email)) {
									arr.push({
										email,
										username: row.username || email.split('@')[0],
										isAdmin: isUserAdmin(email),
										createdAt: null,
										imported: true,
									});
									changed = true;
								}
							}
							if (changed) {
								putManagedUsers(arr);
								syncAdminEmailsCache(arr);
							}
						} catch {
							// silently ignore fetch errors
						}
					}

					function renderAdminUserList(users) {
						const el = document.getElementById('admin-user-list');
						if (!el) return;
						if (!users) users = getManagedUsers();
						if (!users.length) {
							el.innerHTML = '<p style="color:var(--muted);font-size:0.82rem;margin:4px 0">No accounts found yet.</p>';
							return;
						}
						// Sort: seed admin first, then admins, then alphabetically by email
						const sorted = [...users].sort((a, b) => {
							if (a.email === ADMIN_SEED_EMAIL) return -1;
							if (b.email === ADMIN_SEED_EMAIL) return 1;
							if (a.isAdmin !== b.isAdmin) return a.isAdmin ? -1 : 1;
							return a.email.localeCompare(b.email);
						});
						el.innerHTML = sorted.map((u) => {
							const realIdx = users.findIndex(x => x.email === u.email);
							const isSeed = u.email === ADMIN_SEED_EMAIL;
							return `<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--panel-border);flex-wrap:wrap">
								<span style="flex:1;min-width:120px;font-size:0.85rem">
									${escHtml(u.username || '—')}
									<span style="color:var(--muted);font-size:0.75rem;margin-left:4px">${escHtml(u.email)}</span>
								</span>
								${u.isAdmin ? '<span style="font-size:0.7rem;background:var(--accent);color:#fff;padding:2px 7px;border-radius:4px;flex-shrink:0">' + (isSeed ? 'seed admin' : 'admin') + '</span>' : ''}
								${!isSeed ? `<button class="btn btn-small" data-i="${realIdx}" data-action="toggle-admin" style="flex-shrink:0">${u.isAdmin ? 'Revoke admin' : 'Make admin'}</button>` : ''}
								${!isSeed ? `<button class="btn btn-small" data-i="${realIdx}" data-action="remove" style="flex-shrink:0;color:#dc2626">Remove</button>` : ''}
							</div>`;
						}).join('');
						el.querySelectorAll('[data-action]').forEach(btn => {
							btn.addEventListener('click', () => {
								const idx = parseInt(btn.dataset.i, 10);
								const arr = getManagedUsers();
								if (btn.dataset.action === 'remove') {
									arr.splice(idx, 1);
								} else if (btn.dataset.action === 'toggle-admin') {
									arr[idx].isAdmin = !arr[idx].isAdmin;
								}
								putManagedUsers(arr);
								syncAdminEmailsCache(arr);
								renderAdminUserList(arr);
							});
						});
					}

					// Load list: first render from cache, then fetch & re-render
					async function loadAndRender() {
						renderAdminUserList();
						await importUsernamesTable();
						renderAdminUserList();
					}

					const createBtn = document.getElementById('btn-admin-create');
					if (createBtn) {
						createBtn.addEventListener('click', async () => {
							const usernameEl = document.getElementById('admin-new-username');
							const emailEl    = document.getElementById('admin-new-email');
							const passwordEl = document.getElementById('admin-new-password');
							const isAdminEl  = document.getElementById('admin-new-is-admin');
							const statusEl   = document.getElementById('admin-create-status');

							const email    = (emailEl?.value || '').trim().toLowerCase();
							const password = passwordEl?.value || '';
							const username = (usernameEl?.value || '').trim() || email.split('@')[0];
							const makeAdmin = !!isAdminEl?.checked;

							if (!email || !password) {
								if (statusEl) statusEl.textContent = '⚠ Email and password are required.';
								return;
							}
							if (statusEl) statusEl.textContent = 'Creating account…';
							createBtn.disabled = true;

							try {
								await signUpXHR(email, password, username, AUTH_TIMEOUT_MS, () => {});
							} catch (e) {
								if (statusEl) statusEl.textContent = `❌ ${e?.message || String(e)}`;
								createBtn.disabled = false;
								return;
							}

							const arr = getManagedUsers();
							const existing = arr.find(u => u.email === email);
							if (existing) {
								// Update imported entry with real data
								existing.username = username;
								existing.isAdmin = makeAdmin;
								existing.createdAt = new Date().toISOString();
								existing.imported = false;
							} else {
								arr.push({ email, username, isAdmin: makeAdmin, createdAt: new Date().toISOString() });
							}
							putManagedUsers(arr);
							syncAdminEmailsCache(arr);
							if (statusEl) statusEl.textContent = `✅ Account created for ${email}.${makeAdmin ? ' Granted admin.' : ''}`;
							if (usernameEl) usernameEl.value = '';
							if (emailEl)    emailEl.value    = '';
							if (passwordEl) passwordEl.value = '';
							if (isAdminEl)  isAdminEl.checked = false;
							createBtn.disabled = false;
							renderAdminUserList(arr);
						});
					}

					// Kick off on tab click so list is fresh each time the admin opens the tab
					document.getElementById('tab-admin')?.addEventListener('click', () => {
						loadAndRender();
					});

					loadAndRender();
				})();
				// ── end Account Manager ──────────────────────────────────────────

				recenterLoginCard();
				bootstrap();
				// Init auth tab indicator on first paint
				requestAnimationFrame(() => {
					const firstAuthTab = authTabs.find(t => t.tab?.getAttribute('aria-selected') === 'true')?.tab;
					if (firstAuthTab) updateTabIndicator('auth-tab-indicator', firstAuthTab);
				});
			}
		</script>
	</body>
</html>
